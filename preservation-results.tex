%!TEX root = Main-asynchCFSM-multicomp.tex

\section{Preservation results}
\label{sect:presres}
In the following subsections we proceed to prove the preservation by partial-fusion composition of the
various communication properties, separately.

%\brc
%\\
%I have not seen a point in the following where we need input- or output-deterministic.
%\bfc So it seems to me too. \efc
%\erc

\subsection{Preservation of  deadlock-freedom}


\begin{example}[Mixed-state counterexample for deadlock-freedom and progress preservation]
\label{ex:lackprogdfpres}
\em
Let us consider the two following systems $S_1$ and $S_2$ with interfaces
$\hh$ such that the one for $S_2$ possesses a mixed state.
$$
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge   [bend right]      node [below] {$\hh\ttu!\msg[a]$} (1)
                   edge   [bend left]       node [above]  {$\ttu\hh?\msg[b]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  % \node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend right, line width=0.5mm]      node [above] {$\ttv\hh?\msg[a]$} (1)
                   edge    [bend left, line width=0.5mm]            node [above]  {$\hh\ttv!\msg[b]$} (1);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_2\ttv?\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$

$S_1$ and $S_2$ are both deadlock free and both enjoy the progress property.
  The system $\MC(\Set{S_1,S_2}, \cs)$  is the following one.
$$
\begin{array}{c@{\hspace{1cm}}c@{\hspace{1cm}}c@{\qquad}c}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
             \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH_1$};
  \node[state]            (1) [above right of=hat0, yshift=-5mm] {$1$};
  \node[state]           (hat0') [above right of=0, yshift=-5mm] {$\widehat{0}'$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)         edge   [bend right]        node [below] {${\hh_2\hh_1}?{\msg[a]}$} (hat0)
                         edge   [bend left]      node [above]  {${\ttu\hh_1}?{\msg[b]}$} (hat0')
             (hat0)  edge  [bend right]         node [below] {${\HH_1\ttu}!{\msg[a]}$} (1)
             (hat0')  edge  [bend left]      node [above] {${\hh_1\hh_2}!{\msg[b]}$} (1);       \end{tikzpicture}
      &
             \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH_2$};
  \node[state]            (1) [above right of=hat0, yshift=-5mm] {$1$};
  \node[state]           (hat0') [above right of=0, yshift=-5mm] {$\widehat{0}'$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge    [bend right]               node [above] {${\ttv\hh_2}?{\msg[a]}$} (hat0)
                  edge   [bend left]          node [above]  {${\hh_1\hh_2}?{\msg[b]}$} (hat0')
             (hat0)  edge   [bend right]      node [above] {${\hh_2\hh_1}!{\msg[a]}$} (1)
             (hat0')  edge   [bend left]            node [above] {${\HH_2\ttv}!{\msg[b]}$} (1);      
 \end{tikzpicture}
       &
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_2\ttv?\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$
The initial configuration is actually a deadlock,  and hence the composed system does also not enjoy progress.
\finex
\end{example}

\begin{example}[Unique outcoming interface edges for deadlock-freedom and progress preservation]
\label{ex:singleeps}
\em
Let us consider the two following systems $S_1$ and $S_2$ with interfaces
$\hh$.
$$
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge      node [below] {$\hh\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh?\msg[b]$} (1)
            (0)   edge    [bend right, line width=0.5mm]            node [above]  {$\ttv\hh?\msg[a]$} (2);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$

$S_1$ and $S_2$ are both deadlock free and both enjoy the progress property.
Moreover $\emb{}{}{}{M^1_\hh}{M^2_\hh}$

  The system $\fusioncomp_{\!\hh}(S_1,S_2)$  is the following one.
$$
\begin{array}{c@{\hspace{1cm}}c@{\qquad}c}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
             \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH$};
  \node[state]            (2) [right of=hat0] {$2$};
  \node[state]           (1) [above right of=0, yshift=-5mm] {$1$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)         edge   [bend right]        node [below] {${\ttv\hh}?{\msg[a]}$} (hat0)
                         edge   [bend left]      node [above]  {${\ttv\hh}?{\msg[b]}$} (1)
             (hat0)  edge        node [below] {${\HH\ttu}!{\msg[a]}$} (2);       
             \end{tikzpicture}
       &
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$
The above system is actually non deadlock free,  and hence does also not enjoy progress.

The same problem arises with
$$
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge      node [below] {$\hh\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (3) [right of=2] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh?\msg[c]$} (2)
            (2)   edge    [line width=0.5mm]            node [above]  {$\ttv\hh?\msg[a]$} (3);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$

$$
\begin{array}{c@{\hspace{1cm}}c@{\qquad}c}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (2hat) [right of=2] {$\hat{2}$};
  \node[state]           (3) [right of=2hat] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh?\msg[c]$} (2)
            (2)   edge           node [above]  {$\ttv\hh?\msg[a]$} (2hat)
            (2hat)   edge      node [above]  {$\hh\ttu!\msg[a]$} (3)
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$
\finex
\end{example}


\begin{lemma}[Projections of deadlocks are deadlocks]
\label{lem:weakdfpreservation}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that
both $M^1_\hh$ and $M^2_\hh$ have no mixed state, and
let $s= (\vec{q},\vec{w}) \in \RS(S)$ be a deadlock configuration of $S$.\\
Then there exists $i\in \Set{1,2}$ such that $\restrict{s}{i}\in \RS(S_i)$ and $\restrict{s}{i}$
is a deadlock configuration of $S_i$.
\end{lemma}

\begin{proof}
By definition of deadlock configuration we have that
$q_{\HH}\not\in\widehat{Q_{\HH}}$.
Otherwise, by  \cref{fact:uniquesending}(\ref{fact:uniquesending-i}), 
there would be an output transition from $q_{\HH}$, contradicting $s$ to be a deadlock configuration of $S$.
So, by~\cref{lem:nohatrestrict}, we get $\restrict{s}{i}\in \RS(S_i)$ for each $i\in \Set{1,2}$.

Now, since $s= (\vec{q},\vec{w})$ is a deadlock configuration of $S$, we have $\vec{w}=\vec{\varepsilon}$ and, for each $\ttp\in\roles$, $q_\ttp$  is a receiving state.
Hence, by \cref{fact:uniquesending}(\ref{fact:uniquesending-iv})
we need  to take into account the following cases for the outgoing transitions from $q_{\HH}$  in 
$\delta_{\HH}$.

\begin{description}  
  \item
\underline{$\diamond$} 
{\em  There is a single outgoing transition from $q_\hh$ and it is of the form
$(q_{\HH},\tts{\HH}?\msg[a],q'_\hh)$ with $q'_\hh\not\in\widehat{Q_\hh}$ and $\tts\in\roles_2$.}\\
 By \cref{fact:uniquesending}(\ref{fact:uniquesending-iib})
 $(q_{\HH},\tts{\HH}?\msg[a],q'_\hh)\in\delta^2_\hh$ and hence, by definition of projection
 on $S_2$ (\cref{def:projs}(\ref{def:projs-2})) and since $\vec{w}=\vec{\varepsilon}$,
 it follows that $\restrict{s}{2}$ is a deadlock configuration.
\item
\underline{$\diamond$}
{\em  There are $n>0$ outgoing transitions from $q_\hh$, all of the form
$(q_{\HH},\ttu_j\HH?\msg[a]_j,\hat q_{\hh j})$ with $\hat q_{\hh j} \in\widehat{Q_\hh}$
for $1\leq j\leq n$.
.}\\
Now, by \cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) and the no mixed state condition,
we can have necessarily only the following possible subcases.
\begin{description} 
%
\item 
{\em $\ttu_j \in \roles_1$ for all $1\leq j\leq n$}.\\
By \cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) we have that, for each such $1\leq j\leq n$,  
$$(q_{\HH},\ttu_j{\HH}?\msg[a]_j,\hat{q}_{\hh j}),(\hat{q}_\hh,\HH{\tts_j}!\msg[a]_j,q'_{\HH j})\in \delta_{\HH}.$$
where $q'_{\HH j}\not\in\widehat{Q_\hh}$ and $\tts_j\in\roles_2$. 
Moreover, $(f(q_\HH),\ttu_j\HH?\msg[a]_j,f(q'_{\HH j}))\in\delta^1_\HH$.\\
% and $(q_\HH,\HH\tts_j!\msg[a],q'_{\HH j})\in\delta^2_\HH$.\\
Let now $\restrict{s}{1}=(\restrict{\vec{q}}{1},\restrict{\vec{w}}{1})$
where $\restrict{\vec{q}}{1} = (q''_\ttp)_{\ttp\in\roles_1}$
and $\restrict{\vec{w}}{1} = (w''_{\ttp\ttq})_{\ttp\ttq\in C_1}$.
By definition of $\restrict{\_}{1}$ (\cref{def:projs}(\ref{def:projs-1}))
we have that $q''_\hh = f(q_\hh)$ and $q''_\ttp = q_\ttp$ for each $\ttp\in\roles_1\setminus\Set{\hh}$.
Moreover, $(w''_{\ttp\ttq})_{\ttp\ttq\in C_1} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_1}$,
Since $s$ is a deadlock configuration, it hence follows that  $(w''_{\ttp\ttq})_{\ttp\ttq\in C_1} =  (\varepsilon_{\ttp\ttq})_{\ttp\ttq\in C_1}$.
We have then that all the states of $(q''_\ttp)_{\ttp\in\roles_1}$ are receiving states
and all the channel in $C_1$ are empty, that is $\restrict{s}{1}$ is a deadlock.
%
\item 
{\em $\ttu_j \in \roles_2$ for all $1\leq j\leq n$}.\\
By \cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) we have that, for each such $1\leq j\leq n$,  
$$(q_{\HH},\ttu_j{\HH}?\msg[a]_j,\hat{q}_{\hh j}),(\hat{q}_\hh,\HH{\tts_j}!\msg[a]_j,q'_{\HH j})\in \delta_{\HH}.$$
where $q'_{\HH j}\not\in\widehat{Q_\hh}$ and $\tts_j\in\roles_1$. 
Moreover, $(q_\HH,\ttu_j\HH?\msg[a]_j,q'_{\HH j})\in\delta^2_\HH$.\\
% and $(q_\HH,\HH\tts_j!\msg[a],q'_{\HH j})\in\delta^2_\HH$.\\
Let now $\restrict{s}{2}=(\restrict{\vec{q}}{2},\restrict{\vec{w}}{2})$
where $\restrict{\vec{q}}{2} = (q''_\ttp)_{\ttp\in\roles_2}$
and $\restrict{\vec{w}}{2} = (w''_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
By definition of $\restrict{\_}{2}$ (\cref{def:projs}(\ref{def:projs-2}))
we have that $q''_\ttp = q_\ttp$ for each $\ttp\in\roles_1$.
Moreover, $(w''_{\ttp\ttq})_{\ttp\ttq\in C_2} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_2}$,
Since $s$ is a deadlock configuration, it hence follows that  $(w''_{\ttp\ttq})_{\ttp\ttq\in C_2} =  (\varepsilon_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
We have then that all the states of $(q''_\ttp)_{\ttp\in\roles_2}$ are receiving states
and all the channel in $C_1$ are empty, that is $\restrict{s}{2}$ is a deadlock.
\end{description}
 \end{description}
 \end{proof}

\begin{corollary}[Preservation of deadlock-freedom]%\hfill\\
\label{prop:weakdfPreservation}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that
both $M^1_\hh$ and $M^2_\hh$ have no mixed state.
If both $S_1$ and $S_2$ are deadlock free then also $S$ is deadlock free.
\end{corollary}
\begin{proof}
By contradiction, let us assume there is an $s\in \RS(S)$ which is a deadlock configuration of $S$. Then we get a contradiction by Lemma \ref{lem:weakdfpreservation}.
\end{proof}



\subsection{No-orphan-message preservation}


\begin{lemma}%\hfill\\
\label{lem:restrRSom}
Let $s= (\vec{q},\vec{w}) \in \RS(S)$ be an orphan-message configuration of $S=\fusioncomp_{\!\hh}(S_1,S_2)$.
Then there exists $i\in \Set{1,2}$ such that $\restrict{s}{i}\in \RS(S)$ and $\restrict{s}{i}$ is an  orphan-message configuration of $S_i$.
\end{lemma}

\begin{proof}
Let $s= (\vec{q},\vec{w}) \in \RS(S)$ be an orphan-message configuration of $S$, 
that is $\vec{q}$ is final and $\vec{w}\neq \vec{\varepsilon}$.
Since $\vec{q}$ is final we get, by  \cref{fact:uniquesending}(\ref{fact:uniquesending-i},  
that $q_{\HH}\not\in \widehat{Q_{\HH}}$.
So, by~\cref{lem:nohatrestrict}, $\restrict{s}{i}\in \RS(S_i)$ for each $i\in \Set{1,2}$. 
By definition of composition by partial fusion we have that from $\vec{w}\neq \vec{\varepsilon}$
it follows that $\exists i\in \Set{1,2}.\exists \ttp,\ttq\in \roles_i.\ w_{\ttp\ttq}\neq\varepsilon$.
Hence, by definition of projections and \cref{lem:indrestrict}(\ref{lem:indrestrict-abis}),
there exists  $i\in \Set{1,2}$ such that
$\restrict{s}{i}$ is an  orphan-message configuration of $S_i$.
\end{proof}


\begin{corollary}[Preservation of orphan-message-freedom]%\hfill\\
\label{prop:nomPreservation}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that, for each $i\in \Set{1,2}$, 
$S_i$ is orphan-message free.
Then also $S$ is orphan-message free.
\end{corollary}
\begin{proof}
By contradiction, let us assume there is an $s\in \RS(S)$ which is an orphan-message configuration. Then we get
a contradiction by Lemma \ref{lem:restrRSom}.
\end{proof}



\subsection{Preservation of no unspecified reception}


\begin{proposition}[Preservation of reception-error freedom]%\hfill\\
\label{prop:nurPreservation}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that, for each $i\in \Set{1,2}$, 
no element in $\RS(S_{i})$ is an unspecified reception configuration 
and the CFSMs $M_{\hh}$ in $S_2$, has no mixed state.
Then there is no unspecified reception configuration in $\RS(S)$.
\end{proposition}



\begin{proof}
By contradiction, let us assume there is an $s= (\vec{q},\vec{w})\in \RS(S)$ which is an unspecified reception configuration.
So, let $\ttr \in \roles$ and let ${q}_\ttr$  be the receiving state of $M_\ttr$ prevented from 
receiving any message from any of its buffers, which are all not empty (Definition \ref{def:safeness}(\ref{def:safeness-ur})).
We consider two main cases.
\begin{description}
%
\item 
${q}_\HH\not\in \widehat{Q_\HH}$.\\ 
By~\cref{lem:nohatrestrict} we get $\restrict{s}{i}\in \RS(S_i)$ for each $i\in\Set{1,2}$.
We distinguish now two further subcases.

$\ttr \neq \HH$\\
Then necessarily either $\ttr\in\roles_1$ or $\ttr\in\roles_2$.
Let $z\in\Set{1,2}$ such that $\ttr\in\roles_z$. We have hence that $\restrict{s}{z}\in \RS(S_z)$ is an unspecified reception configuration of $S_z$. Contradiction.

$\ttr = \HH$\\
Since ${q}_\ttr(= {q}_\HH)$ is a receiving state,
by \cref{fact:uniquesending}(\ref{fact:uniquesending-iv}), we consider the following cases
for the outgoing transitions from $q_\HH$ in $\delta_\HH$:
\begin{itemize}
%
\item [\underline{$\diamond$}] 
{\em  There is a single transition from $q_\hh$ and it is of the form
$(q_{\HH},\ttu{\HH}?\msg[a],q'_\hh)$ with $q'_\hh\not\in\widehat{Q_\hh}$ and $\ttu\in\roles_2$.}\\
By definitions of $\restrict{\_}{2}$ (\cref{def:projs}(\ref{def:projs-2})) and partial fusion 
(\cref{def:parfus}), we get that $(q_{\HH},\ttu{\HH}?\msg[a],q'_\hh)\in\delta^2_\hh$.
We have hence that $\restrict{s}{2}\in \RS(S_2)$ is an unspecified reception configuration of $S_2$. Contradiction.
%
\item[\underline{$\diamond$}]
{\em  There are $n>0$ transitions from $q_\hh$, all of the form
$(q_{\HH},\ttu_j\HH?\msg[a]_j,\hat q_{\hh j})$ with $\hat q_{\hh j} \in\widehat{Q_\hh}$
for $1\leq j\leq n$. Moreover, either
$\ttu_j\in\roles_1$ for all $1\leq j\leq n$ or $\ttu_j\in\roles_2$ for all $1\leq j\leq n$.}\\
By definition of unspecified reception configuration,  we have that for all $1\leq j\leq n$, 
\begin{equation} \label{eq:wur}
\mid w_{\ttu_j\HH}\mid > 0 
\text{ and } w_{\ttu_j\HH}\not\in  \msg[a]_j \cdot \mathbb{A}^*  
\end{equation}
Now, we proceed by distinguishing among the above mentioned two possibilities.
\begin{itemize}
\item
%\underline{$\diamond$}
{\it $\ttu_j\in\roles_1$ for all $1\leq j\leq n$}\\ 
In this case we can infer from~\cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) that, for each $1\leq j\leq n$, there exists $q'_j \in Q_{\HH}$
such that $(f(q_\HH),\ttu_j\HH?\msg[a]_j,f(q'_j))\in\delta^1_\HH.$
 By definition of $\restrict{\_}{1}$ (\cref{def:projs}(\ref{def:projs-1})), it follows that $q''_\hh=f(q_\hh)$ and, for each $1\leq j\leq n$,
$w''_{\ttu_j\hh}=w_{\ttu_j\hh}$, where 
$\restrict{s}{1}=(\vec{q''},\vec{w''})$. 
 This implies that $\restrict{s}{1}\in \RS(S_1)$ is an  unspecified reception configuration of $S_z$. Contradiction.\\
%
\item
%\underline{$\diamond$} 
{\it $\ttu_j\in\roles_2$ for all $1\leq j\leq n$}\\ 
In this case we can infer from~\cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) that, for each $1\leq j\leq n$, there exists $q'_j \in Q_{\HH}$
such that $(q_\HH,\ttu_j\HH?\msg[a]_j,q'_j)\in\delta^2_\HH.$
By definition of $\restrict{\_}{2}$ (\cref{def:projs}(\ref{def:projs-2})), 
it follows that $q''_\hh=q_\hh$ and, for each $1\leq j\leq n$,
$w''_{\ttu_j\hh}=w_{\ttu_j\hh}$, where 
$\restrict{s}{2}=(\vec{q''},\vec{w''})$. 
 This implies that $\restrict{s}{2}\in \RS(S_2)$ is an  unspecified reception configuration of $S_z$. Contradiction.
\end{itemize}
\end{itemize}
\item 
${q}_\HH\in \widehat{Q_\HH}$.\\ 
Then, by \cref{fact:uniquesending}(\ref{fact:uniquesending-i}),
${q}_\HH$ is a single and sending state such that $({q}_\HH,\HH\tts!\msg[a],q'_\HH)\in{\delta}_\HH$ with $q'_\HH \not\in Q_{\HH}$. 
Since $q_\ttr$ is a receiving state, it is impossible that $\ttr=\HH$.
So, let $\ttr\neq\HH$. 
It is now possible to check that  there exists $s'\in \RS(S)$ such that
$s\lts{\HH\tts!\msg[a]}s'=(\vec{q'},\vec{w'})$ with $q'_\HH$ and $\tts$ as above.
Since $q'_\HH\not\in \widehat{Q_\HH}$ it
follows, by~\cref{lem:nohatrestrict}, that $\restrict{s'}{i} \in \RS(S_i)$ for each $i\in\Set{1,2}$.
Moreover, we have that 
\begin{enumerate}[a)]
\item
\label{l:aa}
$\forall \ttp\neq\HH.\ q'_\ttp = {q}_\ttp$ and,
in particular, $q'_\ttr = {q}_\ttr$;
\item
\label{l:bb}
$\forall \ttp\ttq \neq \HH\tts.\ w'_{\ttp\ttq} = {w}_{\ttp\ttq}$;
\item
\label{l:cc}
$w'_{\HH\tts} = {w}_{\HH\tts}\cdot \msg[a]$.
\end{enumerate}
We consider now the following subcases:
\begin{description}
\item
 {\it $\tts \neq \ttr$}.  \\
From ($\ref{l:aa}$) and ($\ref{l:bb}$) above it follows that  $q'_\ttr = {q}_\ttr$
and, since  $\tts \neq \ttr$, $w'_{\ttp\ttr} = {w}_{\ttp\ttr}$ for all $\ttp \in \roles_z$.
Consequently, by definition of projections (\cref{def:projs}) and  for each $i\in\Set{1,2}$, 
we get that $\ttr\in\roles_i$ implies that $\restrict{s'}{i}$ is an unspecified reception configuration of $S_i$. Contradiction.
%
\item
 {\it $\tts = \ttr$}.  \\
In case $\HH$ sends the message $\msg[a]$ to the buffer $w_{\HH\ttr}$ getting
$w'_{\HH\ttr}$ as in ($\ref{l:cc}$) above. Since $q_\ttr$ is the receiving state of $M_\ttr$ prevented from receiving any message from any of its buffers, which all are not empty in configuration $s$, the sending of $\msg[a]$ extends $w_{\HH\ttr}$ which still has a wrong element on its first position. Then, by ($\ref{l:aa}$) and ($\ref{l:bb}$) above 
and definition of projections (\cref{def:projs}) we can conclude that for each $i\in\Set{1,2}$, 
$\ttr\in\roles_i$ implies that $\restrict{s'}{i}$ is an unspecified reception configuration of $S_i$. Contradiction.
\end{description}
\end{description}
\end{proof}




\subsection{Progress preservation}

%\begin{lemma}
%Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ and $s= (\vec{q},\vec{w}) \in \RS(S)$.
%Moreover, let assume the CFSMs $M^2_{\hh}$ to have no mixed state.
%Then $s\notlts{}\hspace{2mm}$ implies either $\restrict{s}{1}\notlts{}\hspace{2mm}$
%or $\restrict{s}{2}\notlts{}$
%\end{lemma}
%\begin{lemma}
%By contraposition, let us assume $\restrict{s}{1}\lts{\elle_1}\hspace{2mm}$
%and $\restrict{s}{2}\lts{\elle_2}$.
%By definition of projections  (\cref{def:projs}) we get that, for each $i\in\Set{1,2}$,
%$\hh\neq\subj{\elle_i} \implies s\lts{\elle_i}$.
%So we need to consider now just the case  when $\hh=\subj{\elle_1}=\subj{\elle_2}$


\begin{proposition}[Progress preservation]%\hfill\\
\label{lem:restrRS}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that both $S_1$ and $S_2$ satisfy 
the progress property. 
Moreover, let assume the CFSMs $M^2_{\hh}$ to have no mixed state.
Then also $S$ satisfies the progress property. 
\end{proposition}

\begin{proof}
The proof is by contradiction.
Let us assume $S$ does not enjoy the progress property, namely that there exists 
 $s= (\vec{q},\vec{w}) \in \RS(S)$ such that
 \begin{equation}
 \label{eq:snotprogr}
 \text{$s\notlts{}\hspace{2mm}$ and $\hspace{2mm}\vec{q}$ is not final, i.e.\
 $\exists \ttr\in\roles. ~ q_\ttr \text{ is not final in } M_\ttr$.}
\end{equation}
By $s\notlts{}$  and by \cref{fact:uniquesending}(\ref{fact:uniquesending-i}), 
we have that $q_{\HH}\not\in\widehat{Q_{\HH}}$. 
Otherwise there would be an output transition from some $q_{\HH}$, contradicting $s\notlts{}$.
So, by~\cref{lem:nohatrestrict}, we get $\restrict{s}{i}\in \RS(S_i)$ for each $i\in \Set{1,2}$.
Now we distinguish two cases:
\begin{description}
%
\item \emph{$q_{\HH}$ is final in $M_{\HH}$.}\\
Consequently, $\ttr\neq\hh$ and by definition of projections (\cref{def:projs}) we have that,
for each $i\in\Set{1,2}$, $s\notlts{}$ and $\restrict{s}{i}\in \RS(S_i)$ implies $\restrict{s}{i}\notlts{}$. Moreover, we know that $q_\ttr$ is not final in $M_\ttr$ which is
an element of either $S_1$ or $S_2$. Hence, $S_1$ or $S_2$ does not enjoy the progress property. Contradiction.
%
\item \emph{$q_{\HH}$ is not final in $M_{\HH}$.}\\
From above we know  $q_{\HH}\not\in\widehat{Q_{\HH}}$ and hence, 
by \cref{fact:uniquesending}(\ref{fact:uniquesending-iv}) 
we proceed by distinguishing the following two cases:
\begin{description}
%
\item[\underline{$\diamond$}] \emph{There is a single transition from $q_\hh$ and it is of the form
$(q_{\HH},\ttu{\HH}?\msg[a],q'_\hh)$ with $q'_\hh\not\in\widehat{Q_\hh}$ and $\ttu\in\roles_2$.}\\[1mm]
By definition of partial fusion (\cref{def:parfus})
we have that $(q_{\HH},\ttu{\HH}?\msg[a],q'_\hh)\in\delta^2_\hh$.
Moreover, by definition of $\restrict{\_}{2}$ (\cref{def:projs}(\ref{def:projs-2}), 
$q_\hh=q''_\hh$ where $\restrict{s}{2}=(\vec{q''},\vec{w''})$.
Hence $\restrict{s}{2}\notlts{}$ can be inferred from $s\notlts{}$ and then 
$S_2$ does not satisfy the progress property, regardless that $\ttr\neq\hh$ or $\ttr=\hh$. Contradiction.
%
\item[\underline{$\diamond$}] \emph{There are $n>0$ transitions from $q_\hh$, all of the form
$(q_{\HH},\ttu_j\HH?\msg[a]_j,\hat q_{\hh j})$ with $\hat q_{\hh j} \in\widehat{Q_\hh}$
for $1\leq j\leq n$. Moreover, either
$\ttu_j\in\roles_1$ for all $1\leq j\leq n$ or $\ttu_j\in\roles_2$ for all $1\leq j\leq n$.}\\[1mm]
We proceed according to the two above possibilities.\\[1mm]
$\ttu_j\in\roles_1$ for all $1\leq j\leq n$\\
By definition of partial fusion (\cref{def:parfus}) we get that, for all $1\leq j\leq n$,
$(f(q_{\HH}),\ttu_j{\HH}?\msg[a]_j,f(q'_{\hh j}))\in\delta^1_\hh$ and these are the only
outgoing transition from $f(q_{\HH})$ in $\delta^1_\hh$. 
Moreover, by definition of $\restrict{\_}{1}$ (\cref{def:projs}(\ref{def:projs-1}), 
$f(q_\hh)=q''_\hh$ where $\restrict{s}{1}=(\vec{q''},\vec{w''})$.
Hence $\restrict{s}{1}\notlts{}$ can be inferred from $s\notlts{}$ and then 
that $S_1$ does not satisfy the progress property, regardless of $\ttr\neq\hh$ or $\ttr=\hh$. Contradiction.\\[1mm]
%
$\ttu_j\in\roles_2$ for all $1\leq j\leq n$\\
By definition of partial fusion (\cref{def:parfus}) we get that, for all $1\leq j\leq n$,
$(q_{\HH},\ttu_j{\HH}?\msg[a]_j,q'_{\hh j})\in\delta^2_\hh$ and these are the only
outgoing transition from $q_{\HH}$ in $\delta^2_\hh$. 
Moreover, by definition of $\restrict{\_}{2}$ (\cref{def:projs}(\ref{def:projs-2}), 
$q_\hh=q''_\hh$ where $\restrict{s}{1}=(\vec{q''},\vec{w''})$.
Hence $\restrict{s}{2}\notlts{}$ can be inferred from $s\notlts{}$ and then 
that $S_2$ does not satisfy the progress property, regardless of $\ttr\neq\hh$ or $\ttr=\hh$. Contradiction.
\end{description}
\end{description}
\end{proof}









