%!TEX root = Main-asynchCFSM-multicomp.tex

\section{Preservation results}
\label{sect:presres}
In the following subsections we proceed to prove the preservation by partial-fusion composition of the
various communication properties, separately.

%\brc
%\\
%I have not seen a point in the following where we need input- or output-deterministic.
%\bfc So it seems to me too. \efc
%\erc

\subsection{Preservation of  deadlock-freedom}


\begin{example}[Mixed-state counterexample for deadlock-freedom and progress preservation]
\label{ex:lackprogdfpres}
\em
Let us consider the two following systems $S_1$ and $S_2$ with interfaces
$\hh$ such that the one for $S_2$ possesses a mixed state.
$$
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge   [bend right]      node [below] {$\hh\ttu!\msg[a]$} (1)
                   edge   [bend left]       node [above]  {$\ttu\hh?\msg[b]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  % \node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend right, line width=0.5mm]      node [above] {$\ttv\hh?\msg[a]$} (1)
                   edge    [bend left, line width=0.5mm]            node [above]  {$\hh\ttv!\msg[b]$} (1);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_2\ttv?\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$

$S_1$ and $S_2$ are both deadlock free and both enjoy the progress property.
  The system $\MC(\Set{S_1,S_2}, \cs)$  is the following one.
$$
\begin{array}{c@{\hspace{1cm}}c@{\hspace{1cm}}c@{\qquad}c}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
             \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH_1$};
  \node[state]            (1) [above right of=hat0, yshift=-5mm] {$1$};
  \node[state]           (hat0') [above right of=0, yshift=-5mm] {$\widehat{0}'$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)         edge   [bend right]        node [below] {${\hh_2\hh_1}?{\msg[a]}$} (hat0)
                         edge   [bend left]      node [above]  {${\ttu\hh_1}?{\msg[b]}$} (hat0')
             (hat0)  edge  [bend right]         node [below] {${\HH_1\ttu}!{\msg[a]}$} (1)
             (hat0')  edge  [bend left]      node [above] {${\hh_1\hh_2}!{\msg[b]}$} (1);       \end{tikzpicture}
      &
             \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH_2$};
  \node[state]            (1) [above right of=hat0, yshift=-5mm] {$1$};
  \node[state]           (hat0') [above right of=0, yshift=-5mm] {$\widehat{0}'$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge    [bend right]               node [above] {${\ttv\hh_2}?{\msg[a]}$} (hat0)
                  edge   [bend left]          node [above]  {${\hh_1\hh_2}?{\msg[b]}$} (hat0')
             (hat0)  edge   [bend right]      node [above] {${\hh_2\hh_1}!{\msg[a]}$} (1)
             (hat0')  edge   [bend left]            node [above] {${\HH_2\ttv}!{\msg[b]}$} (1);      
 \end{tikzpicture}
       &
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_2\ttv?\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$
The initial configuration is actually a deadlock,  and hence the composed system does also not enjoy progress.
\finex
\end{example}

\begin{example}[Unique outcoming interface edges for deadlock-freedom and progress preservation]
\label{ex:singleeps}
\em
Let us consider the two following systems $S_1$ and $S_2$ with interfaces
$\hh$.
$$
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge      node [below] {$\hh\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh?\msg[b]$} (1)
            (0)   edge    [bend right, line width=0.5mm]            node [above]  {$\ttv\hh?\msg[a]$} (2);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$

$S_1$ and $S_2$ are both deadlock free and both enjoy the progress property.
Moreover $\emb{}{}{}{M^1_\hh}{M^2_\hh}$

  The system $\fusioncomp_{\!\hh}(S_1,S_2)$  is the following one.
$$
\begin{array}{c@{\hspace{1cm}}c@{\qquad}c}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
             \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH$};
  \node[state]            (2) [right of=hat0] {$2$};
  \node[state]           (1) [above right of=0, yshift=-5mm] {$1$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)         edge   [bend right]        node [below] {${\ttv\hh}?{\msg[a]}$} (hat0)
                         edge   [bend left]      node [above]  {${\ttv\hh}?{\msg[b]}$} (1)
             (hat0)  edge        node [below] {${\HH\ttu}!{\msg[a]}$} (2);       
             \end{tikzpicture}
       &
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$
The above system is actually non deadlock free,  and hence does also not enjoy progress.

The same problem arises with
$$
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge      node [below] {$\hh\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (3) [right of=2] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh?\msg[c]$} (2)
            (2)   edge    [line width=0.5mm]            node [above]  {$\ttv\hh?\msg[a]$} (3);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$

$$
\begin{array}{c@{\hspace{1cm}}c@{\qquad}c}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (2hat) [right of=2] {$\hat{2}$};
  \node[state]           (3) [right of=2hat] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh?\msg[c]$} (2)
            (2)   edge           node [above]  {$\ttv\hh?\msg[a]$} (2hat)
            (2hat)   edge      node [above]  {$\hh\ttu!\msg[a]$} (3)
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
$$
.
\finex
\end{example}


\begin{lemma}[Projections of deadlocks are deadlocks]
\label{lem:weakdfpreservation}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that
both $M^1_\hh$ and $M^2_\hh$ have no mixed state, and
let $s= (\vec{q},\vec{w}) \in \RS(S)$ be a deadlock configuration of $S$.\\
Then there exists $i\in \Set{1,2}$ such that $\restrict{s}{i}\in \RS(S_i)$ and $\restrict{s}{i}$
is a deadlock configuration of $S_i$.
\end{lemma}

\begin{proof}
By definition of deadlock configuration we have that
$q_{\HH}\not\in\widehat{Q_{\HH}}$.
Otherwise, by  \cref{fact:uniquesending}(\ref{fact:uniquesending-i}), 
there would be an output transition from $q_{\HH}$, contradicting $s$ to be a deadlock configuration of $S$.
So, by~\cref{lem:nohatrestrict}, we get $\restrict{s}{i}\in \RS(S_i)$ for each $i\in \Set{1,2}$.

Now, since $s= (\vec{q},\vec{w})$ is a deadlock configuration of $S$, we have $\vec{w}=\vec{\varepsilon}$ and, for each $\ttp\in\roles$, $q_\ttp$  is a receiving state.
Hence, by definitions of  partial fusion and fusion-composition 
(Definitions \ref{def:parfus} and \ref{def:cpf}) and \cref{fact:uniquesending}(\ref{fact:uniquesending-ii}),
we need  to 
take into account the following cases for the outgoing transitions from $q_{\HH}$  in 
$\delta_{\HH}$.

\begin{description}  
  \item
\underline{$\diamond$} 
{\em  There is a single outgoing transition from $q_\hh$ and it is of the form
$(q_{\HH},\tts{\HH}?\msg[a],q'_\hh)$ with $q'_\hh\not\in\widehat{Q_\hh}$ and $\tts\in\roles_2$.}\\
 By \cref{fact:uniquesending}(\ref{fact:uniquesending-iib})
 $(q_{\HH},\tts{\HH}?\msg[a],q'_\hh)\in\delta^2_\hh$ and hence, by definition of projection
 on $S_2$ (\cref{def:projs}(\ref{def:projs-2})) and since $\vec{w}=\vec{\varepsilon}$,
 it follows that $\restrict{s}{2}$ is a deadlock configuration.
% definition of connector it follows that the no-mixed-state assumption,
%the CFSM $M_{\hh_v}$ in $S_v$ has no mixed state.
%Therefore, by definition of gateway, all the transitions from $q_{\HH_v}$ in $\delta_{\HH_v}$ 
%are of the form  $(q_{\HH_v},\tts{\HH_v}?\_,\_)$ with $\tts \in \roles_v$.\\ %  (and hence $\tts\neq{\HH_v}$).}\\
%Then we can infer, again from the definition of gateway, that all transitions from $q_{\HH_v}$
% in $\delta^v_{\HH_v}$, i.e.\ transitions in  $M_{h_v}$, are of the form $(q_{\HH_v},\tts{\HH_v}?\_,\_)$.
%  Hence we obtain that $\restrict{s}{v}$ is a deadlock configuration of $S_v$,
% since, for each $\ttu\in\rolescsint$, we have that $q_{\ttu}$ is a receiving state. 
  

\item
\underline{$\diamond$}
{\em  There are $n>0$ outgoing transitions from $q_\hh$, all of the form
$(q_{\HH},\ttu_j\HH?\msg[a]_j,\hat q_{\hh j})$ with $\hat q_{\hh j} \in\widehat{Q_\hh}$
for $1\leq j\leq n$.
.}\\
Now, by \cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) and the no mixed state condition,
we can have necessarily only the following possible subcases.
\begin{description} 
%
\item 
{\em $\ttu_j \in \roles_1$ for all $1\leq j\leq n$}.\\
By \cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) we have that, for each such $1\leq j\leq n$,  
$$(q_{\HH},\ttu_j{\HH}?\msg[a]_j,\hat{q}_{\hh j}),(\hat{q}_\hh,\HH{\tts_j}!\msg[a]_j,q'_{\HH j})\in \delta_{\HH}.$$
where $q'_{\HH j}\not\in\widehat{Q_\hh}$ and $\tts_j\in\roles_2$. 
Moreover, $(f(q_\HH),\ttu_j\HH?\msg[a]_j,f(q'_{\HH j}))\in\delta^1_\HH$.\\
% and $(q_\HH,\HH\tts_j!\msg[a],q'_{\HH j})\in\delta^2_\HH$.\\
Let now $\restrict{s}{1}=(\restrict{\vec{q}}{1},\restrict{\vec{w}}{1})$
where $\restrict{\vec{q}}{1} = (q''_\ttp)_{\ttp\in\roles_1}$
and $\restrict{\vec{w}}{1} = (w''_{\ttp\ttq})_{\ttp\ttq\in C_1}$.
By definition of $\restrict{\_}{1}$ (\cref{def:projs}(\ref{def:projs-1}))
we have that $q''_\hh = f(q_\hh)$ and $q''_\ttp = q_\ttp$ for each $\ttp\in\roles_1\setminus\Set{\hh}$.
Moreover, $(w''_{\ttp\ttq})_{\ttp\ttq\in C_1} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_1}$,
Since $s$ is a deadlock configuration, it hence follows that  $(w''_{\ttp\ttq})_{\ttp\ttq\in C_1} =  (\varepsilon_{\ttp\ttq})_{\ttp\ttq\in C_1}$.
We have then that all the states of $(q''_\ttp)_{\ttp\in\roles_1}$ are receiving states
and all the channel in $C_1$ are empty, that is $\restrict{s}{1}$ is a deadlock.
%
\item 
{\em $\ttu_j \in \roles_2$ for all $1\leq j\leq n$}.\\
By \cref{fact:uniquesending}(\ref{fact:uniquesending-iii}) we have that, for each such $1\leq j\leq n$,  
$$(q_{\HH},\ttu_j{\HH}?\msg[a]_j,\hat{q}_{\hh j}),(\hat{q}_\hh,\HH{\tts_j}!\msg[a]_j,q'_{\HH j})\in \delta_{\HH}.$$
where $q'_{\HH j}\not\in\widehat{Q_\hh}$ and $\tts_j\in\roles_1$. 
Moreover, $(q_\HH,\ttu_j\HH?\msg[a]_j,q'_{\HH j})\in\delta^2_\HH$.\\
% and $(q_\HH,\HH\tts_j!\msg[a],q'_{\HH j})\in\delta^2_\HH$.\\
Let now $\restrict{s}{2}=(\restrict{\vec{q}}{2},\restrict{\vec{w}}{2})$
where $\restrict{\vec{q}}{2} = (q''_\ttp)_{\ttp\in\roles_2}$
and $\restrict{\vec{w}}{2} = (w''_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
By definition of $\restrict{\_}{2}$ (\cref{def:projs}(\ref{def:projs-2}))
we have that $q''_\ttp = q_\ttp$ for each $\ttp\in\roles_1$.
Moreover, $(w''_{\ttp\ttq})_{\ttp\ttq\in C_2} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_2}$,
Since $s$ is a deadlock configuration, it hence follows that  $(w''_{\ttp\ttq})_{\ttp\ttq\in C_2} =  (\varepsilon_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
We have then that all the states of $(q''_\ttp)_{\ttp\in\roles_2}$ are receiving states
and all the channel in $C_1$ are empty, that is $\restrict{s}{2}$ is a deadlock.
\end{description}
 \end{description}
 \end{proof}

%
%
% OLD version of the proof
%
%By definition of deadlock configuration and by Fact \ref{fact:uniquesending}(\ref{fact:uniquesending-i}), we have that, for each $i\in I$,
%$q_{\HH_i}\not\in\widehat{Q_{\HH_i}}$.
%Otherwise there would be an output transition from $q_{\HH_i}$, contradicting $s$ to be a deadlock configuration.
%So, by Lemma \ref{lem:nohatrestrict} we get $\restrict{s}{i}\in RS(S_i)$ for each $i\in I$,
%as well as $\restrict{s}{\cp}\in RS(\cp)$.
%
%Now, since $s$ is a deadlock configuration, we have \\
%\centerline{$\vec{w}=\vec{\varepsilon}$ and 
%$\forall \ttp\in\roles.~q_\ttp$  is a receiving state,}
%where $s=(\vec{q},\vec{w})$.\\
%By definitions of  gateway and multicomposition 
%(Defs \ref{def:gatewaymc} and \ref{def:multicomposition}) and 
%\bfr since all states of the configuration $s$ are receiving states, \efr
%\bfc I erased ``by the no mixed state condition on each $M_{\HH_i}$
%imposed by composability''\efc
% we need  to 
%take into account only the following cases concerning the shapes of the transitions from  the various $q_{\HH_i}$  in their respective $\delta_{\HH_i}$. 
%
%\begin{description}
%%\item
%%\underline{$\diamond$} 
%%{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$ and
%%all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts \in \roles_2$ (and hence $\tts\neq\HH$).}\\
%%Since all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts \in \roles_2$ (and hence $\tts\neq\HH$),
%%  we can infer, from the definition of  $\gateway{\cdot}$, that also  all the transitions from $q_\KK$ in $\delta^2_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$. Hence we obtain that $\restrict{s}{2}$ is a deadlock configuration of $S_2$.
%  
%  \item
%\underline{$\diamond$} 
%{\em  There exists a $v\in I$ such that all the transitions from $q_{\HH_v}$ in $\delta_{\HH_v}$ 
%are of the form  $(q_{\HH_v},\tts{\HH_v}?\_,\_)$ with  $\tts \in \roles_v$  (and hence $\tts\neq{\HH_v}$).}\\
%In this case
%  we can infer, from the definition of gateway, that also  all the transitions from $q_{\HH_v}$
% in $\delta^v_{\HH_v}$ are of the form $(q_{\HH_v},\tts{\HH_v}?\_,\_)$. Hence we obtain that $\restrict{s}{v}$ is a deadlock configuration of $S_v$.
%
%\item
%\underline{$\diamond$}
%{\em  For each $v\in I$  the transitions from $q_{\HH_v}$ in $\delta_{\HH_v}$ 
%are of the form $(q_{\HH_v},\HH_{\bmr z_{v\hspace{0.3pt}a}\emr}{\HH_v}?\_,\_)$}\\
%In order not to cope with too many indexes and indexed indexes, we consider a 
%generic single transition $(q_{\HH},\HH'{\HH}?a,\widehat{q})$
%where we have set $\HH =\HH_v$, $\HH'=\HH_{z_{v\hspace{0.3pt}a}}$ (i.e $\HH'$ depends on $v$ and $a$),
%$a=a_v$ and $\widehat{q}=\widehat{q}_{j_{v\hspace{0.3pt}a}}$.
%Now, by definition of gateway, we have that
%$$(q_{\HH},\HH'{\HH}?a,\widehat{q}),(\widehat{q},\HH{\tts}!a,q'_{\HH})\in \delta_{\HH}$$
%for some $\tts\in\roles_v$ (where $\tts$ depends on $v$ and $a$).\\
%This implies that
%$$(q_{\HH},\HH{\tts}!a,q'_{\HH})\in \delta^v_{\HH}.$$
%So, by definition of connection policy, we can infer that 
%$$({\dot {q_{\HH}}},\KK'{\KK_v}?a,\dot {q'_{\HH}})\in \delta^{\cp}_{\KK_v}.$$
%We note that by definition of projection, if $\restrict{s}{\cp} = (\vec{p},\vec{w'})$,
% we have that $w'_{\KK_j\KK_i} = w_{\HH_j\HH_i}$, for each ${j,i\in I}$ such that $j\neq i$, namely
% $\vec{w'}=\vec{\varepsilon}$. The thesis hence follows because we have shown above that
% $\restrict{s}{\cp}\in RS(\cp)$ and, by definition of projection, $p_{\KK_v}={\dot {q_{\HH}}}$.
%\end{description}
%\end{proof}

\begin{corollary}[Preservation of deadlock-freedom]%\hfill\\
\label{prop:weakdfPreservation}
Let $S = \fusioncomp_{\!\hh}(S_1,S_2)$ such that
both $M^1_\hh$ and $M^2_\hh$ have no mixed state.
If both $S_1$ and $S_2$ are deadlock free then also $S$ is deadlock free.
\end{corollary}
\begin{proof}
By contradiction, let us assume there is an $s\in \RS(S)$ which is a deadlock configuration of $S$. Then we get a contradiction by Lemma \ref{lem:weakdfpreservation}.
\end{proof}











