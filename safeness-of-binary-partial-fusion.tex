%!TEX root = JLAMP-Main.tex



\section{Preservation of Communication Properties by Partial Fusion}
\label{sect:safetypreservation}


In the present section we show that if we take two communicating systems
$S_1$ and $S_2$ such that $S_1$ possesses a CFSM $M^1_\HH$ and $S_2$ a CFSM $M^2_\KK$ which is compatible with $M^1_\HH$, replace both CFSMs by their gateway transformations and then join the resulting systems, we get a system which satisfies all the communication properties which are satisfied by both $S_1$ and $S_2$.\\


\noindent
\textbf{General assumption:}\\ 
In the following, we generally assume given a
system  
$$S= (M_\ttp)_{\ttp\in\roles} = \fusioncomp_{\!\hh}(S_1,S_2)$$  
composed
as described in Def.~\ref{def:cpf}
from systems 
$$S_1= (M^1_\ttp)_{\ttp\in\roles_1}  \hspace{4mm} \text{ and } \hspace{4mm} S_2= (M^2_\ttp)_{\ttp\in\roles_2}$$ where $\emb{f}{\bm{\delta^2}}{\roles_1\setminus\Set{\hh}}{M^1_{\hh_1}}{M^2_{\hh_2}}$
and $M^2_\hh = (Q^2, q^2_0, \textit{Act}, \delta^2)$.



\vspace{2mm}
\noindent
\textbf{Notation:} \\
The roles of $S$ are $\roles=\roles_1\cup\roles_2$ with  $\roles_1\cap\roles_2=\setminus\Set{\hh_2}$.\\
The channels of $S_i$ are  $C_i=\Set{\ttp\ttq \mid \ttp,\ttq\in \roles_i, \ttp\neq\ttq}$ for $i=1,2$.\\
The channels of $S$ are 
$C=C_1\cup C_2\cup\Set{\HH\KK,\KK\HH}$.\\
The transitions of $M_\ttp$ in $S$ will be denoted by $\delta_\ttp$.
The transitions of $M^1_\ttp$ in $S_1$ will be denoted by $\delta^1_\ttp$, whereas the 
transitions of $M^2_\ttp$ in $S_2$ will be denoted by $\delta^2_\ttp$.
Notice that $\delta_\ttp = \delta^1_\ttp$ for all $\ttp\in\roles_1\setminus\Set{\HH}$
and $\delta_\ttp = \delta^2_\ttp$ for all $\ttp\in\roles_2\setminus\Set{\hh}$.



\subsection{Technical notions and results}

Different definition of projections are possible. We preferred the following one since, notwithstanding forces proofs to be slighter more difficult, has the advantage of simplicity. 
\begin{definition}[Projections]
\label{def:projs}
Let $s= (\vec{q},\vec{w})\in RS(S)$, where $\vec{q}=(q_\ttp)_{\ttp\in\roles}$
and $\vec{w} = (w_{\ttp\ttq})_{\ttp\ttq\in C}$. 
We define:
% for $i=1,2$,\\
%\centerline{$\restrict{s}{i}=(\restrict{\vec{q}}{i},\restrict{\vec{w}}{i})$ \quad
%where $\restrict{\vec{q}}{i} = (q_\ttp)_{\ttp\in\roles_i}$ and\ 
%$\restrict{\vec{w}}{i} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_i}$.
%}
\begin{enumerate}[i)]
\item
\label{def:projs-1}
\vspace{-8mm}
\begin{tabular}{@{\hspace{0mm}}llll@{\hspace{4mm}}l}
\\[5mm]
$\restrict{s}{1}=(\restrict{\vec{q}}{1},\restrict{\vec{w}}{1})$ &
where & $\bullet$  $\restrict{\vec{q}}{1} = (q'_\ttp)_{\ttp\in\roles_1}$  with & - $q'_\ttp = q_\ttp$ & if $\ttp\in\roles_1\setminus\Set{\hh}$ or $[\ttp=\hh$ and $q_\hh\in \widehat{Q}]$\\
& & & - $q'_\hh = f(q_\hh)$  & if $q_\hh\not\in \widehat{Q}$\\
 &   & $\bullet$  
$\restrict{\vec{w}}{1} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_1}$.
%\item
%\vspace{-8mm}
%\begin{tabular}{@{\hspace{0mm}}llll@{\hspace{4mm}}l}
%\\[5mm]
%$\restrict{s}{2}=(\restrict{\vec{q}}{2},\restrict{\vec{w}}{2})$ &
%where & $\bullet$  $\restrict{\vec{q}}{2} = (q'_\ttp)_{\ttp\in\roles_2}$  with & - $q'_\ttp = q_\ttp$ & if $\ttp\in\roles_2\setminus\Set{\hh}$ or $[\ttp=\hh$ and $q_\hh\in \widehat{Q}]$\\
%& & & - $q'_\hh = q_\hh$  & if $q_\hh\not\in \widehat{Q}$\\
% &   & $\bullet$  
%$\restrict{\vec{w}}{2} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
\end{tabular}
\item
\label{def:projs-2}
$\restrict{s}{2}=(\restrict{\vec{q}}{2},\restrict{\vec{w}}{2})$ \quad
where $\restrict{\vec{q}}{2} = (q_\ttp)_{\ttp\in\roles_2}$ and\ 
$\restrict{\vec{w}}{2} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
\end{enumerate}
\end{definition}


Notice that $\restrict{s}{i}$ is not necessarily a configuration of $S_i$, because of possible additional states of the connecting participant $\hh$.\\


The following fact easily descends from the definition of $\gateway{\cdot}$.
In particular from the fact that the gateway transformation of a machine $M$ does insert an intermediate state
 between any pair of states of $M$ connected by a transition. By definition, the intermediate state
 possesses exactly one incoming transition and one outgoing transition. 

\begin{fact}($\checkmark$)
\label{fact:uniquesending}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a reachable configuration of
$S =\fusioncomp_{\!\hh}(S_1,S_2)$.
\begin{enumerate}
\item
\label{fact:uniquesending-i}
If ${q_\HH} \in\widehat{Q_\HH}$ then
${q_\HH}$ is not final and
 there exists a unique transition $({q_\HH},\_,\_)\in\delta_\HH$.
  Moreover such a transition is of the form
 $(q_\HH,\HH\tts!\msg[a],q')$ with $q'\not\in\widehat{Q_\HH}$.

\item
\label{fact:uniquesending-ii}
 If ${q_\HH}\not\in\widehat{Q_\HH}$ then either $q_\HH$ is final, 
or any transition $({q_\HH},\elle,q'_\hh)\in\delta_\HH$ is such that 
\begin{enumerate}[a)]
\item
${q'_\HH}\in\widehat{Q_\HH}$ implies that $({q_\HH},\elle,q'_\hh)$
is an input transition, that 
is of the form $({q_\HH},\tts\HH?\msg[a],{q'_\HH})$;
\item
\label{fact:uniquesending-iib}
${q'_\HH}\not\in\widehat{Q_\HH}$ implies that
$({q_\HH},\elle,q'_\hh)$ is the only outcoming transition from $q_\hh$ and such that
$\tts\in\roles_2$ where $\elle$ is either $\tts\hh?\msg[a]$ or $\hh\tts!\msg[a]$.
Moreover, $({q_\HH},\elle,q'_\hh)\in\delta^2_\hh$.
\end{enumerate}
\item
\label{fact:uniquesending-iii}
If $(q_\HH,\ttr\HH?\msg[a],{q'_\HH})\in\delta_\HH$ with $q_\HH\not\in\widehat{Q_\HH}$ and
$q'_\HH\in\widehat{Q_\HH}$, then
\begin{enumerate}[a)]
\item
$\ttr\in\roles_1$ implies that
there exists $({q'_\HH},\HH\tts!\msg[a],q''_\HH)\in\delta_\HH$ where $\tts \in \roles_2$ and  
$q''_\HH\not\in\widehat{Q_\HH}$ and 
such that 
$(f(q_\HH),\ttr\HH?\msg[a],f(q''_\HH))\in\delta^1_\HH$ and 
$(q_\HH,\HH\tts!\msg[a],q''_\HH)\in\delta^2_\HH$;
\item
$\ttr\in\roles_2$ implies that
there exists $({q'_\HH},\HH\tts!\msg[a],q''_\HH)\in\delta_\HH$ where $\tts \in \roles_1$ and  
$q''_\HH\not\in\widehat{Q_\HH}$ and 
such that 
$(q_\HH,\ttr\HH?\msg[a],q''_\HH)\in\delta^1_\HH$ and 
$(f(q_\HH),\HH\tts!\msg[a],f(q''_\HH))\in\delta^2_\HH$.
\end{enumerate}
\end{enumerate}
\end{fact}

\medskip
The third item of the following lemma (whose proof depends on the first two items)
states that any sequence of transitions ending with an output action by a gateway
can be ``rearranged'' so that the output action is immediately preceded
by its corresponding reception. 


\begin{lemma}($\checkmark$)
\label{lem:swap-rolf}
Let $S =\fusioncomp_{\!\hh}(S_1,S_2)$.

\begin{enumerate}[i)]
\item\label{lem:swap-rolf-item1}
Let $s,s',s''\in \RS(S)$  such that\\
\centerline{
$s\lts{\ttr\HH?\msg[a]}s'\lts{\elle}s''$}
 where $s'' = (\vec{q''},\vec{w''})$ and $s' = (\vec{q'},\vec{w'})$ with  $q'_\hh\in \widehat{Q_\hh}$, and where $\elle$ is not of the form $\HH\_!\_$.\\
Then there exists $s'''\in \RS(S)$ such that $s\lts{\elle}s'''\lts{\ttr\HH?\msg[a]}s''$
where $q''_\hh = q'_\hh$.

\item\label{lem:swap-rolf-item2}
For $j,k \geq 0$, let $s_j \in \RS(S)$ and $s_{j+k+1} \in \RS(S)$ be reachable from $s_j$ by a sequence of transitions of the form
$s_j  \lts{\ttr\HH?\msg[a]} s_{j+1}\lts{\elle_1}\ldots\, s_{j+k}\lts{\elle_{k}}s_{j+k+1}$
 where ${q_{(j+1)}}_\hh\in Q_\hh$ and, for $x = 1,\ldots,k$,  $\elle_x$ is not of the form $\HH\_!\_$.\\
Then  there exists a sequence of transitions of the form
\\
\hspace*{30mm}
$s_j  \lts{\elle_1}s'_{j+1} \ldots\,  \lts{\elle_k} s'_{j+k} \lts{\ttr\HH?\msg[a]}s_{j+k+1}$.

\item\label{lem:swap-rolf-item3}
Let $s \in \RS(S)$ be reachable from $s_0$ by a sequence of
transitions of the form\\
\hspace*{30mm}
$s_0\lts{}  s_1\,\ldots \lts{} s_{n-2}  \lts{} s_{n-1}\lts{\HH\tts!\msg[a]}s_n=s$.\\
where $s_i = (\vec{q_i},\vec{w_i})$ $(i=0,\ldots,n)$ and ${q_{n-1}}_\hh \in \widehat{Q_\hh}$.\\
Then $n \geq 2$ and there exists a sequence of transitions of the form
\\
\hspace*{30mm}
$s_0\lts{} s'_1\,\ldots \lts{} s'_{n-2}\lts{\ttr\HH?\msg[a]}s_{n-1}\lts{\HH\tts!\msg[a]}s_n=s$.
\end{enumerate}
\end{lemma}

\begin{proof}
(\ref{lem:swap-rolf-item1})
%For all $\tts\in\roles_j\cup\Set{\hh_i}_{i\in I\setminus \Set{j}}$, the action $\elle$ cannot affect the buffer ${w}_{\HH_j\tts}$.\\
%
 Let $s = (\vec{q},\vec{w})$.
 For all $\ttp \in \roles\setminus\{\hh\}$ we have $q'_\ttp = q_\ttp$.
 Since $\elle$ is not of the form $\HH\_!\_$ by assumption and
$\elle$ is also not of the form $\_\HH?\_$ by construction of connector, 
we have $q''_\HH = q'_\HH$. 
Then we set $q'''_\HH = q_\HH$ and $q'''_\ttp = q''_\ttp$ for all
$\ttp \in \roles\setminus\{\hh\}$.

Concerning the channels, we know that $w_{\ttr\HH} =  \msg[a]\cdot w'_{\ttr\HH}$ and $w'_{\ttp\ttv} =  w_{\ttp\ttv}$ for all
$\ttp\ttv \neq \ttr\HH$. 
Now we set $w'''_{\ttp\ttv} =  w''_{\ttp\ttv}$ for all $\ttp\ttv \neq \ttr\HH$. 
For defining $w'''_{\ttr\HH}$ we consider three cases for $\elle$: 
%
\begin{description}
\item \underline{$\diamond$}
$\elle = \ttr\HH?\msg[b]$ for some $\msg[b]$.\\
As already said above, this case is not possible by construction of connector.

\item \underline{$\diamond$}
$\elle \neq \ttr\HH?\msg[b]$ and $\elle \neq \ttr\HH!\msg[b]$
for any $\msg[b]$.\\
Then $w''_{\ttr\HH} =  w'_{\ttr\HH}$. We set
$w'''_{\ttr\HH} = w_{\ttr\HH}$ and $s''' = (\vec{q'''},\vec{w'''})$. 
Thus $s\lts{\elle}s'''\lts{\ttr\HH?\msg[a]}s''$. 
%
\item
\underline{$\diamond$}
$\elle = \ttr\HH!\msg[b]$ for some $\msg[b]$.\\
Then $w''_{\ttr\HH} = w'_{\ttr\HH}\cdot\msg[b]$.
We set $w'''_{\ttr\HH} = w_{\ttr\HH}\cdot\msg[b] = \msg[a]\cdot w'_{\ttr\HH}\cdot\msg[b]$ and $s''' = (\vec{q'''},\vec{w'''})$.
Thus $s\lts{\elle}s'''\lts{\ttr\HH?\msg[a]}s''$. 
\end{description}

(\ref{lem:swap-rolf-item2}) The proof is done by induction on $k$.

{\em Case $k = 0$}.
Then we take $s'_{j+k} = s_j$ and the statement is trivial. 

{\em Case $k>0$}. % \mapsto k+1$}.
Let $s_j  \lts{\ttr\HH?\msg[a]} s_{j+1}\lts{\elle_1}s_{j+2}\,\,\ldots\, \lts{\elle_{k}}s_{j+k+1} \lts{\elle_{k+1}}s_{j+k+2}.$
Then, by part (\ref{lem:swap-rolf-item1}) of the lemma, there exists
$s'_{j+1}$ such that $s_j \lts{\elle_1} s'_{j+1}\lts{\ttr\HH?\msg[a]}s_{j+2}$
where ${q_{(j+2)}}_\hh\in \widehat{Q_{\hh}}$.
By the induction hypothesis, there exists a sequence of transitions 
$s'_{j+1}  \lts{\elle_2} \ldots\,  \lts{\elle_{k+1}} s'_{j+k+1} \lts{\ttr\HH?\msg[a]}s_{j+k+2}$. Thus
$s_j \lts{\elle_1} s'_{j+1}  \lts{\elle_2} \ldots\,  \lts{\elle_{k+1}} s'_{j+k+1} \lts{\ttr\HH?\msg[a]}s_{j+k+2}$. 


(\ref{lem:swap-rolf-item3})
Let $s_0\lts{}  s_1\,\ldots \lts{} s_{n-2}  \lts{} s_{n-1}\lts{\HH\tts!\msg[a]}s_n=s$ with $s = (\vec{q},\vec{w})$.
By assumption, ${q_{(n-1)}}_{\HH}\in\widehat{Q_{\HH}}$.
Hence, by definition of of connector
 and by the fact that ${q_0}_{\HH}\not\in\widehat{Q_{\HH}}$,
 there must be a transition $s_j \lts{\ttr\HH?\msg[a]}s_{j+1}$ for
 some $0\leq j \leq n-2$ such that ${q_{(j+1)}}_\hh\in\widehat{Q_\hh}$. 
In particular, $n \geq 2$ must hold.
Now we take the largest $j$ with $0\leq j \leq n-2$ such that
 $s_j  \lts{\ttr\HH?\msg[a]} s_{j+1}\lts{\elle_1}\ldots\, s_{j+k}\lts{\elle_{k}}s_{n-1}$
 where, for each $x = 1,\ldots,k$,  $\elle_x$ is not of the form $\HH\_!\_$.
By part (\ref{lem:swap-rolf-item2}) of the lemma, there exists
 $s_j  \lts{\elle_1}s'_{j+1} \ldots\,  \lts{\elle_k} s'_{j+k} \lts{\ttr\HH?\msg[a]} s_{n-1}$. Thus we obtain a sequence
$s_0\lts{}\,\,\ldots \lts{}s_j  \lts{\elle_1}s'_{j+1} \ldots\,  \lts{\elle_k} s'_{n-2}\lts{\ttr\HH?\msg[a]}s_{n-1}\lts{\HH\tts!\msg[a]}s_n=s$.
\end{proof}



\begin{lemma} ($\checkmark$) \hfill
\label{lem:indrestrict}  
\begin{enumerate}[1)]
\item
\label{lem:indrestrict-a}
$\restrict{s_0}{1}\in RS(S_1)$ and  $\restrict{s_0}{2}\in RS(S_2)$
\item
\label{lem:indrestrict-b}
Let $s\lts{\elle}s'$ and $\subj{\elle}\neq\hh$.
% is neither of the form $\_\HH?\_$ nor of the form $\HH\_!\_$.\\
Then, for $i=1,2$,  either $\restrict{s}{i}\lts{\elle}\restrict{s'}{i}$ or  $\restrict{s}{i}=\restrict{s'}{i}$.
\item
\label{lem:indrestrict-c}
Let $s\lts{\elle}s'$ where $s= (\vec{q},\vec{w})$, $s'= (\vec{q'},\vec{w'})$
and $\subj{\elle}=\hh$ % $\elle$ is either of the form $\_\HH?\_$ or of the form $\HH\_!\_$ 
where %and such that
$q_\hh\lts{\elle}q'_\hh$ with $q_\hh,q'_\hh\not\in\widehat{Q}$. Then
\begin{enumerate}[a)]
\item
\label{lem:indrestrict-c1}
$\restrict{s}{1} = \restrict{s'}{1}$;
\item
\label{lem:indrestrict-c2}
$\restrict{s}{2}\lts{\elle}\restrict{s'}{2}$.
\end{enumerate}
\item
\label{lem:indrestrict-d}
Let $s\lts{\ttr\HH?\msg[a]} s'\lts{\HH\tts!\msg[a]} s''$ where $s'= (\vec{q'},\vec{w'})$ with $q'_\hh\in \widehat{Q_\hh}$.
Then, $\restrict{s}{1}\lts{}\restrict{s''}{1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
All (???) statements easily
descends from definitions of projections, configuration transition and connector.
[*Expand?*]\\
\ref{lem:indrestrict-c})
By definition of connector, we immediately get that $(q_\hh,\elle,q'_\hh,\nintf)\in\bm{\delta}$.
So, by definition of complementarity, we have that $f(q_\hh)=f(q'_\hh)$ and hence,
by definition of projection $\restrict{\_}{1}$, we get (\ref{lem:indrestrict-c1}).
Item (\ref{lem:indrestrict-c2}) descends immediately from the definition of projection $\restrict{\_}{2}$.
%By the assumption,  $q_\hh\lts{\elle}q'_\hh\in\delta_\hh$. We distinguish between the two following cases:\\
%\begin{description}
%\item[]
%\end{description}
%\ref{lem:indrestrict-c2})[{\em Sketch}]
%Let $\sigma=\parproj{s}{C_1\cap C'}$ (*definition to do*), where $C'=\Set{\ttr\tts\mid \ttr\in\Set{\hh} \text{ or }\tts\in\Set{\hh}}$.
%Since $\emb{f}{\bm{\delta^2}}{}{M^1_{\hh}}{M^2_{\hh}}$ and both $M^1_{\hh}$ and $M^2_{\hh}$ are deterministic,
%by definition of fusion and configuration transition [*make a lemma?*]we have that $\overline{\delta'}({q_0}_\hh,\sigma) =\Set{q_\hh}$,
%where  $(Q_\hh,{q_0}_\hh,\Act\cup\Set{\varepsilon},\delta')$ is the $\varepsilon$-counterpart of 
%$M^1_{\hh}=(Q_\hh,{q_0}_\hh,\Act,\delta^1))$. 
%By definition of $\noeps(\cdot)$ we have also that 
%$\sigma=\parproj{\restrict{s}{1}}{C_1}$. Moreover, there exists $\tilde q = \overline{\delta^1}({q_0}_\hh,\sigma)$ [*make a lemma?*]
\end{proof}

\begin{remark}{\em
Notice that for \cref{lem:indrestrict}(\ref{lem:indrestrict-c}) to hold,  
the conditions involving $f$ in \cref{def:noepsver} (and hence the conditions in \cref{def:cfsmie},
see \cref{rem:neccond}) are necessary.\finex
}
\end{remark}



If a reachable configuration of the connected system $S={S_{1}}\connect{\HH}{\KK} {S_{2}}$ does not involve an intermediate state of the gateway
$M_\HH = \gateway{M^1_\HH, \KK}$, %$M_\KK = \gateway{M^2_\KK, \HH}$, 
then by taking into account only the states of machines of $S_1$ and disregarding
the channels between the gateways, %(see Definition \ref{def:restrictedconf} above),
we get a
reachable configuration of $S_1$. Similarly for $S_2$.

\begin{lemma}($\checkmark$)
\label{lem:nohatrestrict}\hfill\\
Let $s= (\vec{q},\vec{w}) \in \RS(S)$ be a reachable configuration of 
$S =\fusioncomp_{\!\hh}(S_1,S_2)$.
$${q}_\HH\not\in\widehat{Q_\hh} \implies 
\restrict{s}{i}\in \RS(S_i) \quad i=1,2.$$
\end{lemma}

\begin{proof}
Let $s = (\vec{q},\vec{w}) \in \RS(S)$ and $i=1,2$ such that ${q}_{\HH}\not\in\widehat{Q_{\HH}}$.
If $s \in RS(S)$, then there exists a transition sequence leading to $s$ from the initial state, say
$$s_0\lts{}s_1\lts{} \ldots\lts{} s_{n-1}\lts{}s_n=s$$
where $s_i = (\vec{q_i},\vec{w_i})$ $(i=0,\ldots,n)$.\\
We prove $\restrict{s}{i}\in \RS(S_i)$  by (well-founded) induction on the length $n$ of the transition sequence to reach $s$ from the initial state $s_0$.

{\em Case $n=0$}. Then $\restrict{s}{i} = \restrict{s_0}{i} \in \RS(S_i)$
by~\cref{lem:indrestrict}(\ref{lem:indrestrict-a}).


{\em Case $n>0$}.
Then there exists $s_x = (\vec{q_x},\vec{w_x}) \in \RS(S)$ and an action $\elle_x$ over $\roles$
such that $s_x\lts{\elle_x}s$ and $s_x$ is reachable from $s_0$ in $n-1$ steps.
%By the induction hypothesis, $\restrict{s_x}{i}\in \RS(S_i)$.
We now proceed by cases, according to the possible forms of $\elle_x$:

\begin{description}
%
\item
\underline{$\diamond$}
$\elle_x$ is neither of the form $\_\,\HH?\_$ nor of the form $\HH\_!\_$.\\
Then ${q_x}_{\HH}={q}_{\HH}\not\in\widehat{Q_{\HH}}$.
Moreover, by~\cref{lem:indrestrict}(\ref{lem:indrestrict-b}),
either $\restrict{s_x}{i}\lts{\elle_x}\restrict{s}{i}$ or  $\restrict{s_x}{i}=\restrict{s}{i}$.\\
Since ${q_x}_{\HH}\not\in\widehat{Q_{\HH}}$ we can apply the induction hypothesis for $s_x$ and obtain $\restrict{s_x}{i}\in \RS(S_i)$.\\
Hence $\restrict{s}{i}\in \RS(S_i)$.
%
\item
\underline{$\diamond$}
$\elle_x$ is either of the form $\_\,\HH?\_$ or of the form $\HH\_!\_$
and ${q_x}_\hh\not\in\widehat{Q_{\HH}}$.\\
The thesis descends immediately for $i=1$, since  $\restrict{s_x}{1}=\restrict{s}{1}$
by \cref{lem:indrestrict}(\ref{lem:indrestrict-c1}).
Let us consider now $i=2$. Since ${q_x}_{\HH}\not\in\widehat{Q_{\HH}}$, we can apply the induction hypothesis for $s_x$ and obtain $\restrict{s_x}{2}\in \RS(S_2)$.
By \cref{lem:indrestrict}(\ref{lem:indrestrict-c2}) $\restrict{s_x}{2}\lts{\elle_x}\restrict{s}{2}$.
Hence $\restrict{s}{2}\in \RS(S_2)$.

%
\item
\underline{$\diamond$}
$\elle_x$ is of the form $\_\,\HH?\_$ and ${q_x}_\hh\in\widehat{Q_{\HH}}$.\\
This case cannot occur since otherwise,
by definition of gateways,
${q}_{\HH}\in\widehat{Q_{\HH}}$ which is excluded by hypothesis. 
%
\item
\underline{$\diamond$}
$\elle_x$ is of the form $\HH\_!\_$  and ${q_x}_\hh\in\widehat{Q_{\HH}}$.\\
More explicitly, let $s_x\lts{\HH\tts!\msg[a]}s$.
%By definition of gateways, ${q_x}_{\HH_i}\in\widehat{Q_{\HH_i}}$.
%Therefore $s_x \neq s_0$ and thus $s$ is reachable from $s_0$ in $n \geq 2$ steps.
Then, by~\cref{lem:swap-rolf}(\ref{lem:swap-rolf-item3}), there exist
transitions
$s_y \lts{\ttr\HH?\msg[a]}s_x\lts{\HH\tts!\msg[a]}s$
such that $s_y = (\vec{q_y},\vec{w_y})\in \RS(S)$ is reachable from $s_0$ in $n-2$ steps. By definition of connector, ${q_y}_{\HH} \not\in\widehat{Q_{\HH}}$.
Hence, we can apply the induction hypothesis for $s_y$ and obtain $\restrict{s_y}{i}\in \RS(S_i)$.
Moreover, by~\cref{lem:indrestrict}(\ref{lem:indrestrict-d}) we get a transition
$\restrict{s_y}{i}\lts{\elle}\restrict{s}{i}$. Hence $\restrict{s}{i}\in \RS(S_i)$.
\end{description}
\end{proof}

The following lemma will be handy to prove the preservation of reception-error freedom (\cref{prop:nurPreservation}). Roughly, it states that from any reachable configuration we can reach
configurations not containing any of the gateway intermediate states. 
In fact, the single outgoing transitions out of them are, by definition of gateway, output transitions. They can hence be always fired, so increasing the lengths of the corresponding buffers.
\begin{lemma}
\label{lem:addendum}
Let $s = (\vec{q},\vec{w}) \in \RS(S)$. Then there exists $s'= (\vec{q'},\vec{w'}) \in \RS(S)$ such that $s \to^* s'$, where
$|w_{\ttp\ttq}| \leq |w'_{\ttp\ttq}|$ for all $\ttp\ttq \in C$, and where
$q'_{\HH}\not\in\widehat{Q_{\HH}}$ and
 $(q_{\HH}\not\in\widehat{Q_{\HH}} \implies q'_{\HH}= q_{\HH})$.
\end{lemma}
\begin{proof}
If ${q}_{\HH}\not\in\widehat{Q_{\HH}}$, we are done by setting $s'=s$.
Otherwise, in case ${q}_{\HH}\in\widehat{Q_{\HH}}$, 
%\brc : ${q}_{\HH_i}\not\in\widehat{Q_{\HH_i}}$ replaced by
%${q}_{\HH_i}\in\widehat{Q_{\HH_i}}$\erc 
by~\cref{fact:uniquesending}(\ref{fact:uniquesending-i}) we can infer that there exists a configuration transition of the form
$$
s \lts{\HH\tts!\msg[a]} s''
$$
such that, for $s'' = (\vec{q''}, \vec{w''})$, it holds that 
$|w_{\ttp\ttq}| \leq |w''_{\ttp\ttq}|$ for all $\ttp\ttq \in C$ and that
$q''_{\HH}\not\in \widehat{Q_{\HH}}$, whereas
$q_{\HH}\not\in\widehat{Q_{\HH}} \implies q''_{\HH}= q_{\HH}$
is vacuously true.
\end{proof}

















