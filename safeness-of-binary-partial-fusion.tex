%!TEX root = JLAMP-Main.tex



\section{Preservation of Communication Properties by Partial Fusion}
\label{sect:safetypreservation}


In the present section we show that if we take two communicating systems
$S_1$ and $S_2$ such that $S_1$ possesses a CFSM $M^1_\HH$ and $S_2$ a CFSM $M^2_\KK$ which is compatible with $M^1_\HH$, replace both CFSMs by their gateway transformations and then join the resulting systems, we get a system which satisfies all the communication properties which are satisfied by both $S_1$ and $S_2$.\\


\noindent
\textbf{General assumption:}\\ 
In the following, we generally assume given a
system  
$$S= (M_\ttp)_{\ttp\in\roles} = \fusioncomp_{\!\hh}(S_1,S_2)$$  
composed
as described in Def.~\ref{def:cpf}
from systems 
$$S_1= (M^1_\ttp)_{\ttp\in\roles_1}  \hspace{4mm} \text{ and } \hspace{4mm} S_2= (M^2_\ttp)_{\ttp\in\roles_2}$$ where $\emb{\bm{\delta^2}}{}{M^1_{\hh_1}}{M^2_{\hh_2}}$
and $M^2_\hh = (Q^2, q^2_0, \textit{Act}, \delta^2)$.



\vspace{2mm}
\noindent
\textbf{Notation:} \\
The roles of $S$ are $\roles=\roles_1\cup\roles_2$ with  $\roles_1\cap\roles_2=\setminus\Set{\hh_2}$.\\
The channels of $S_i$ are  $C_i=\Set{\ttp\ttq \mid \ttp,\ttq\in \roles_i, \ttp\neq\ttq}$ for $i=1,2$.\\
The channels of $S$ are 
$C=C_1\cup C_2\cup\Set{\HH\KK,\KK\HH}$.\\
The transitions of $M_\ttp$ in $S$ will be denoted by $\delta_\ttp$.
The transitions of $M^1_\ttp$ in $S_1$ will be denoted by $\delta^1_\ttp$, whereas the 
transitions of $M^2_\ttp$ in $S_2$ will be denoted by $\delta^2_\ttp$.
Notice that $\delta_\ttp = \delta^1_\ttp$ for all $\ttp\in\roles_1\setminus\Set{\HH}$
and $\delta_\ttp = \delta^2_\ttp$ for all $\ttp\in\roles_2\setminus\Set{\hh}$.



\subsection{Technical notions and results}

Different definition of projections are possible. We preferred the following one since, notwithstanding forces proofs to be slighter more difficult, has the advantage of simplicity. 
\begin{definition}[Projections]
Let $s= (\vec{q},\vec{w})\in RS(S)$, where $\vec{q}=(q_\ttp)_{\ttp\in\roles}$
and $\vec{w} = (w_{\ttp\ttq})_{\ttp\ttq\in C}$. 
We define, for $i=1,2$,\\
\centerline{$\restrict{s}{i}=(\restrict{\vec{q}}{i},\restrict{\vec{w}}{i})$ \quad
where $\restrict{\vec{q}}{i} = (q_\ttp)_{\ttp\in\roles_i}$ and\ 
$\restrict{\vec{w}}{i} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_i}$.
}
%\begin{enumerate}[i)]
%\item
%$\restrict{s}{1}=(\restrict{\vec{q}}{1},\restrict{\vec{w}}{1})$ \quad
%where $\restrict{\vec{q}}{1} = (q_\ttp)_{\ttp\in\roles_1}$ and\ 
%$\restrict{\vec{w}}{1} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_1}$.
%\item
%\vspace{-8mm}
%\begin{tabular}{@{\hspace{0mm}}llll@{\hspace{4mm}}l}
%\\[5mm]
%$\restrict{s}{2}=(\restrict{\vec{q}}{2},\restrict{\vec{w}}{2})$ &
%where & $\bullet$  $\restrict{\vec{q}}{2} = (q'_\ttp)_{\ttp\in\roles_2}$  with & - $q'_\ttp = q_\ttp$ & if $\ttp\in\roles_2\setminus\Set{\hh}$ or $[\ttp=\hh$ and $q_\hh\in \widehat{Q}]$\\
%& & & - $q'_\hh = q_\hh$  & if $q_\hh\not\in \widehat{Q}$\\
% &   & $\bullet$  
%$\restrict{\vec{w}}{2} =  (w_{\ttp\ttq})_{\ttp\ttq\in C_2}$.
%\end{tabular}
%\end{enumerate}
\end{definition}


Notice that $\restrict{s}{i}$ is not necessarily a configuration of $S_i$, because of possible additional states of the connecting participant $\hh$.\\


The following fact easily descends from the definition of $\gateway{\cdot}$.
In particular from the fact that the gateway transformation of a machine $M$ does insert an intermediate state
 between any pair of states of $M$ connected by a transition. By definition, the intermediate state
 possesses exactly one incoming transition and one outgoing transition. 

\begin{fact}
\label{fact:uniquesending}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a reachable configuration of
$S =\fusioncomp_{\!\hh}(S_1,S_2)$.
\begin{enumerate}
\item
\label{fact:uniquesending-i}
If ${q_\HH} \in\widehat{Q_\HH}$ then
${q_\HH}$ is not final and
 there exists a unique transition $({q_\HH},\_,\_)\in\delta_\HH$.
  Moreover such a transition is of the form
 $(q_\HH,\HH\tts!a,q')$ with $q'\not\in\widehat{Q_\HH}$.

\item
\label{fact:uniquesending-ii}
(???) If ${q_\HH}\not\in\widehat{Q_\HH}$ then either $q_\HH$ is final, or any transition $({q_\HH},\_,\_)\in\delta_\HH$
is an input  one, that 
is of the form $({q_\HH},\tts\HH?a,{q'_\HH})$ with ${q'_\HH}\in\widehat{Q_\HH}$. Similarly for $\KK$.
\item
\label{fact:uniquesending-iii}
If ${q_\HH}\not\in\widehat{Q_\HH}$ then
             \begin{enumerate}[a)]
\item
(???) If $(q_\HH,\KK\HH?a,{q'_\HH})\in\delta_\HH$  then there exists $({q'_\HH},\HH\tts!a,q''_\HH)\in\delta_\HH$ with $\tts \in \roles_1$ (and hence $\tts \neq \KK$) 
such that $(q_\HH,\HH\tts!a,q''_\HH)\in\delta^1_\HH$.
The same holds for $\delta_\KK$ and by exchanging $\HH$ with $\KK$ and vice versa.
\item
If $(q_\HH,\tts\HH?a, {q'_\HH})\in\delta_\HH$ with $\tts \in \roles_1$ (and hence $\tts \neq \KK$)  then there exists   $({q'_\HH},\HH\KK!a,q''_\HH)\in\delta_\HH$  
such that $(q_\HH,\tts\HH?a,q''_\HH)\in\delta^1_\HH$.
The same holds for $\delta_\KK$ and by exchanging $\HH$ with $\KK$ and vice versa.
              \end{enumerate}
\end{enumerate}
\end{fact}




\begin{lemma}
\label{lem:swap}
(???) Let $\JJ\in\Set{\HH,\KK}$ and 
let $s,s',s''\in RS(S)$  such that\\
\centerline{$s\lts{\elle}s'\lts{\JJ\tts!a}s''$ where
$\elle$ is not of the form $\_\JJ?\_$.}
Then, there exists $s'''\in RS(S)$ such that $s\lts{\JJ\tts!a}s'''\lts{\elle}s''$
\end{lemma}

\begin{proof}
Let us consider just the case $\JJ=\HH$, the other one being similar.
Since $s\in RS(S)$ and by definition of $\gateway{\cdot}$, $\elle$ cannot be of the form $\_\HH!\_$.
So, for all $\ttr\in\roles_1\cup\Set{\KK}$, the action $\elle$ cannot affect the buffer ${w}_{\ttr\HH}$.\\
It is now easy to check that, by defining $s'''=(\vec{q'''},\vec{w'''})$ such that  
${q'''}_{\HH} = {q''}_{\HH}$,  and ${q'''}_{\ttp} = {q}_{\ttp}$ for $\ttp\neq \HH$,
and such that
${w'''}_{\HH\tts} = {w}_{\HH\tts}\cdot a$ and  ${w'''}_{\ttp\ttq} = {w}_{\ttp\ttq}$ for $\ttp\ttq\neq \HH\tts$, we get $s\lts{\HH\tts!a}s'''\lts{\elle}s''$.
\end{proof}




\begin{lemma} (???) \hfill
\label{lem:indrestrict}  
\begin{enumerate}[1)]
\item
\label{lem:indrestrict-a}
$\restrict{s_0}{1}\in RS(S_1)$ and  $\restrict{s_0}{2}\in RS(S_2)$
\item
\label{lem:indrestrict-b}
Let $s\lts{\elle}s'$ 
%where $\restrict{s}{1}\in RS(S_1)$ 
and $\elle$ is neither of the form $\_\HH?\_$ nor of the form $\HH\_!\_$.\\
Then, for $i=1,2$,  either $\restrict{s}{i}\lts{\elle}\restrict{s'}{i}$ or  $\restrict{s}{i}=\restrict{s'}{i}$.
\item
\label{lem:indrestrict-c}
Let $s\lts{\elle}s'$ where $s= (\vec{q},\vec{w})$, $s'= (\vec{q'},\vec{w'})$
and  $\elle$ is either of the form $\_\HH?\_$ or of the form $\HH\_!\_$ and such that
$q_\hh\lts{\elle}q'_\hh$ with $q_\hh,q'_\hh\not\in\widehat{Q}$. Then
\begin{enumerate}[a)]
\item
\label{lem:indrestrict-c1}
$\restrict{s}{2}\lts{\elle}\restrict{s'}{2}$;
\item
\label{lem:indrestrict-c2}
$s\in \RS(S) \implies s'\in \RS(S)$.
\end{enumerate}
\item
Let $s\lts{\elle}s'$ 
%where $\restrict{s}{2}\in RS(S_2)$ 
and $\elle$ is neither of the form $\_\KK?\_$ nor of the form $\KK\_!\_$.\\
Then either $\restrict{s}{2}\lts{\elle}\restrict{s'}{2}$ or  $\restrict{s}{2}=\restrict{s'}{2}$.
\item
Let $s\lts{\ttr\HH?a} s'\lts{\HH\tts!a} s''$.
Then, $\restrict{s}{1}\lts{}\restrict{s''}{1}$.
\item
Let $s\lts{\ttr\KK?a} s'\lts{\KK\tts!a} s''$.
Then, $\restrict{s}{2}\lts{}\restrict{s''}{2}$.
\end{enumerate}
\end{lemma}

\begin{proof}
All statements but \ref{lem:indrestrict-c2}) easily
descends from definitions of $\restrict{s}{1}$ and $\restrict{s}{2}$, by definition of configuration transition and by definition of  connector.\\
\ref{lem:indrestrict-c2})[{\em Sketch}]
Let $\sigma=\parproj{s}{(\roles_{1}\setminus\Set{\hh})}$ (*definition to do*). 
Since $\emb{\bm{\delta^2}}{}{M^1_{\hh}}{M^2_{\hh}}$ and both $M^1_{\hh}$ and $M^2_{\hh}$ are deterministic,
by definition of fusion and configuration transition [*make a lemma?*]we have that $\overline{\delta'}({q_0}_\hh,\sigma) =q_\hh$,
where  $(Q_\hh,{q_0}_\hh,\Act\cup\Set{\varepsilon},\delta')$ is the $\varepsilon$-counterpart of 
$M^1_{\hh}=(Q_\hh,{q_0}_\hh,\Act,\delta^1))$. 
Let now $\tilde q = \overline{\delta^1}({q_0}_\hh,\sigma)$. 
By definition of $\noeps(\cdot)$ [*expand?*],

--

We have that $s\in \RS(S)$, and that $M^1_{\hh}$ and $M^2_{\hh}$ are both deterministic.
Let $\sigma\in\Act^*$ such that $\overline{\delta^2}({q_0}_\hh,\sigma) =q_\hh$
there exixts $\sigma\in\Act^*$ such that $\overline{\delta^1}({q_0}_\hh,\sigma) =q_\hh$. 
Moreover, from $q_\hh,q'_\hh\not\in\widehat{Q}$ it follows that $(q_\hh,\elle,q'_\hh,\nintf)\in\bm{\delta^2}$
and hence $(q_\hh,\varepsilon,q'_\hh)\in \varepsilon(N_{\hh})$ where
$N_{\hh}=(Q_\hh,{q_0}_\hh,\Act,\bm{\delta^2})$, since we have that
$\emb{\bm{\delta^2}}{}{M^1_{\hh}}{M^2_{\hh}}$.
By XXX we have get that  $\overline{\delta^1}({q_0}_\hh,\sigma) =q_\hh$

\end{proof}



If a reachable configuration of the connected system $S={S_{1}}\connect{\HH}{\KK} {S_{2}}$ does not involve an intermediate state of the gateway
$M_\HH = \gateway{M^1_\HH, \KK}$, %$M_\KK = \gateway{M^2_\KK, \HH}$, 
then by taking into account only the states of machines of $S_1$ and disregarding
the channels between the gateways, %(see Definition \ref{def:restrictedconf} above),
we get a
reachable configuration of $S_1$. Similarly for $S_2$.

\begin{lemma}
\label{lem:nohatrestrict}\hfill\\
Let $s= (\vec{q},\vec{w}) \in \RS(S)$ be a reachable configuration of 
$S =\fusioncomp_{\!\hh}(S_1,S_2)$.
$${q}_\HH\not\in\widehat{Q_\hh} \implies 
\restrict{s}{i}\in \RS(S_i) \quad i=1,2.$$
\end{lemma}

\begin{proof}
Let $s = (\vec{q},\vec{w}) \in \RS(S)$ and $i=1,2$ such that ${q}_{\HH}\not\in\widehat{Q_{\HH}}$.
If $s \in RS(S)$, then there exists a transition sequence leading to $s$ from the initial state, say
$$s_0\lts{}s_1\lts{} \ldots\lts{} s_{n-1}\lts{}s_n=s$$
where $s_i = (\vec{q_i},\vec{w_i})$ $(i=0,\ldots,n)$.\\
We prove $\restrict{s}{i}\in \RS(S_i)$  by (well-founded) induction on the length $n$ of the transition sequence to reach $s$ from the initial state $s_0$.

{\em Case $n=0$}. Then $\restrict{s}{i} = \restrict{s_0}{i} \in \RS(S_i)$
by~\cref{lem:indrestrict}(\ref{lem:indrestrict-a}).


{\em Case $n>0$}.
Then there exists $s_x = (\vec{q_x},\vec{w_x}) \in \RS(S)$ and an action $\elle_x$ over $\roles$
such that $s_x\lts{\elle_x}s$ and $s_x$ is reachable from $s_0$ in $n-1$ steps.
%By the induction hypothesis, $\restrict{s_x}{i}\in \RS(S_i)$.
We now proceed by cases, according to the possible forms of $\elle_x$:

\begin{description}
%
\item
\underline{$\diamond$}
$\elle_x$ is neither of the form $\_\,\HH?\_$ nor of the form $\HH\_!\_$.\\
Then ${q_x}_{\HH}={q}_{\HH_i}\not\in\widehat{Q_{\HH}}$.
Moreover, by~\cref{lem:indrestrict}(\ref{lem:indrestrict-b}),
either $\restrict{s_x}{i}\lts{\elle_x}\restrict{s}{i}$ or  $\restrict{s_x}{i}=\restrict{s}{i}$.\\
Since ${q_x}_{\HH_i}\not\in\widehat{Q_{\HH_i}}$ we can apply the induction hypothesis for $s_x$ and obtain $\restrict{s_x}{i}\in \RS(S_i)$.\\
Hence $\restrict{s}{i}\in \RS(S_i)$.
%
\item
\underline{$\diamond$}
$\elle_x$ is either of the form $\_\,\HH?\_$ or of the form $\HH\_!\_$
and ${q_x}_\hh\not\in\widehat{Q_{\HH}}$.

%
\item
\underline{$\diamond$}
$\elle_x$ is of the form $\_\,\HH_i?\_$.\\
This is not possible since otherwise,
by definition of gateways,
${q}_{\HH_i}\in\widehat{Q_{\HH_i}}$ which is excluded. 
%
\item
\underline{$\diamond$}
$\elle_x$ is of the form $\HH_i\_!\_$.\\
More explicitly, let $s_x\lts{\HH_i\tts!\msg[a]}s$.
%By definition of gateways, ${q_x}_{\HH_i}\in\widehat{Q_{\HH_i}}$.
%Therefore $s_x \neq s_0$ and thus $s$ is reachable from $s_0$ in $n \geq 2$ steps.
Then, by~\cref{lem:swap-rolf}(\ref{lem:swap-rolf-item3}), there exist
transitions
$s_y \lts{\ttr\HH_i?\msg[a]}s_x\lts{\HH_i\tts!\msg[a]}s$
such that $s_y = (\vec{q_y},\vec{w_y})\in \RS(S)$ is reachable from $s_0$ in $n-2$ steps. By definition of gateways, ${q_y}_{\HH_i} \not\in\widehat{Q_{\HH_i}}$.
Hence, we can apply the induction hypothesis for $s_y$ and obtain $\restrict{s_y}{i}\in \RS(S_i)$.
Moreover, by~\cref{lem:indrestrict}(\ref{lem:indrestrict3}) we get a transition
$\restrict{s_y}{i}\lts{\elle}\restrict{s}{i}$. Hence $\restrict{s}{i}\in \RS(S_i)$.
\end{description}

--------------------------------         

(\ref{lem:nohatrestrict-i})
If $s \in RS(S)$, then there exists a transition sequence leading to $s$ from the initial state, say
$$s_0\lts{}s_1\lts{} \ldots\lts{} s_{n-1}\lts{}s_n=s$$
$s_i = (\vec{q_i},\vec{w_i})$ $(i=0,\ldots,n)$.\\
Let $j \geq 0$ be the smallest index such that ${q_j}_\HH\not\in \widehat{Q_\HH}$ and  ${q_{j+1}}_\HH\in \widehat{Q_\HH}$
(if there is not such a $j$, then the thesis follows immediately).
By definition of $\gateway{\cdot}$ we have that $s_j\lts{\ttr\HH?a} s_{j+1}$ for a certain $\ttr$.
Now let $t$ be the smallest index such that  $t\geq j+1$, ${q_t}_\HH = {q_{j+1}}_\HH$ and ${q_{t+1}}_\HH\not\in \widehat{Q_\HH}$.
Such an index $t$ does exist because of the hypothesis $q_\HH\not\in\widehat{Q_\HH}$
(moreover, notice that no self loop transitions are possible out of a state in $\widehat{Q_\HH}$).
By definition of $\gateway{\cdot}$ we have that $s_{t}\lts{\HH\tts!a} s_{t+1}$ for a certain $\tts$.\\
We can now proceed by induction on the lenght of the transition sequence
\centerline{
$s_j\lts{\ttr\HH?a} \ldots \lts{\HH\tts!a}s_{t+1}$
}
using Lemma \ref{lem:swap}, in order to show that 
it is possible to build a transition sequence like the following one\\
\centerline{
$s_0\lts{}s_1\lts{}\ldots s_j\lts{\ttr\HH?a} s_{j+1}\lts{\HH\tts!a} s'_{j+2} \lts{} \ldots \lts{}s'_{n-1}\lts{}s_n=s$
}
where ${q_{j+2}}_\HH\not\in \widehat{Q_\HH}$.\\
The iteration of this procedure trivially converges and allow us to get a sequence
\\
\begin{equation}
\label{eq:goodseqa}
s_0\lts{}\ldots  \lts{}s_n=s
\end{equation}
such that any transition of the form $\ttr\HH?a$ is immediately followed by a transition $\HH\tts!a$.

Now, by using Lemma \ref{lem:indrestrict}, it is possible to proceed by complete induction over the 
lenght of the transition sequence (\ref{eq:goodseqa})
in order to get a transition sequence $\restrict{s_0}{1} \lts{}^* \restrict{s}{1}$. So $\restrict{s}{1}\in RS(S_1)$.\\
(\ref{lem:nohatrestrict-ii}) This case can be treated similarly to (\ref{lem:nohatrestrict-i}).
\end{proof}


Given a transition sequence $\xi$, we now define the subsequence of $\xi$ made only
of transitions having a given role as
sender or receiver.


%\begin{definition}
%Let $\xi$ be a transition sequence for a system S and let $\ttp\in\roles(S)$.\\
%We define $\restrictup{\xi}{\ttp}\in \textit{Act}^*$  by 
%$$\restrictup{\xi}{\ttp} = \left\{\begin{array}{ll}
%                                                \varepsilon & \text{if } \xi=s\\
%                                               \elle\cdot\restrictup{\xi'}{\ttp} & 
%                                                         \text{if } \xi=s\lts{\elle}\xi' \text{ and } [ \elle= \_\ttp?\_  \vee \elle= \ttp\_!\_ ]\\
%                                               \restrictup{\xi'}{\ttp}  & \text{if } \xi=s\lts{\elle}\xi' \text{ and } [ \elle\neq \_\ttp?\_  \wedge \elle\neq \ttp\_!\_ ]
%                                      \end{array} \right. 
%$$
%\end{definition}

\begin{definition}
Let $\xi$ be a transition sequence for a system S and let $\ttp\in\roles(S)$.\\
We define $\restrictup{\xi}{\ttp}\in \textit{Act}^*$  by 
$$\restrictup{\xi}{\ttp} = \left\{\begin{array}{ll}
                                                \varepsilon & \text{if } \xi=s  \;\; (\text{i.e. } |\xi|=0) \\
                                               \restrictup{\xi'}{\ttp}\cdot\elle & 
                                                         \text{if } \xi=\xi'\lts{\elle}s \text{ and } [ \elle= \_\ttp?\_  \vee \elle= \ttp\_!\_ ]\\
                                               \restrictup{\xi'}{\ttp}  & \text{otherwise}
                                               %\text{if } \xi=\xi'\lts{\elle}s \text{ and } [ \elle\neq \_\ttp?\_  \wedge \elle\neq \ttp\_!\_ ]
                                      \end{array} \right. 
$$
\end{definition}

Notice that by definitions of $\gateway{\cdot}$ and  $\restrictup{(\cdot)}{(\cdot)}$,  
if $\xi$ is a transition sequence leading to an $s\in RS(S)$, then
 $\restrictup{\xi}{\HH}$ is made (but for its last element, in case $|\restrictup{\xi}{\HH}|$ is odd) of consecutive pairs of elements of $\textit{Act}$  of the form
$\KK\HH?a \,\, \HH\tts!a$ or $\tts\HH?a \,\,\HH\KK!a$, with $\tts\neq\KK$.
Moreover, in case $|\restrictup{\xi}{\HH}|$ is odd, it ends with an action of the form
$\KK\HH?a$ or $\tts\HH?a$, with $\tts\neq\KK$.
Similarly for $\restrictup{\xi}{\KK}$.\\

We define now two functions, one enabling to map traces of ${M_\HH}$ (i.e. the gateway $\gateway{M^1_\HH, \KK}$)
  into the corresponding traces of ${M^1_\HH}$
and one enabling to map traces of ${M_\KK}$  (i.e. the gateway $\gateway{M^2_\KK, \HH}$) into the corresponding traces of ${M^2_\KK}$.
Traces ending in elements of $\widehat{Q_\HH}$ or $\widehat{Q_\KK}$ will be treated differently
for what concerns their last elements.

%\begin{definition}
%Given $\varphi\in\textit{Act}^*$, we define $\symb{\HH\KK}{\varphi}\in (\Set{?,!}\times\mathbb{A})^* $  by 
%$$\symb{\HH\KK}{\varphi} = \left\{\begin{array}{ll}                                             
%                                                \varepsilon & \text{if }  \varphi  = \varepsilon  \text{ or } \varphi = \tts\HH?\_ \text{ with } \tts\neq\KK    \\
%                                                !a & \text{if }  \varphi = \KK\HH?a \\
%                                                 %?a    & \text{if } \varphi= \tts\HH?a \text{ with } \tts\neq\KK \\
%                                               ?a\cdot\symb{\HH}{\varphi'} & 
%                                                      \text{if } \varphi= \tts\HH?a \cdot \HH\KK!a \cdot \varphi' \text{ with } \tts\neq\KK\\
%                                                !a\cdot\symb{\HH}{\varphi'}   & 
%                                                         \text{if } \varphi= \KK\HH?a \cdot \HH\tts!a \cdot \varphi'  \text{ with } \tts\neq\KK\\
%                                               \textit{undefined}  & \text{otherwise } 
%                                      \end{array} \right. 
%$$
%The function $\symb{\KK\HH}{\varphi}$ is defined by simply exchanging the roles of $\HH$ and $\KK$ in the above definition.
%\end{definition}

\begin{definition}
Given $\varphi\in\textit{Act}^*$, we define $\symb{\HH\KK}{\varphi}\in (\Set{?,!}\times\mathbb{A})^* $  by 
$$\symb{\HH\KK}{\varphi} = \left\{\begin{array}{ll}                                             
                                                \varepsilon & \text{if }  \varphi  = \varepsilon  \text{ or } \varphi = \tts\HH?\_ \text{ with } \tts\neq\KK    \\
                                                !a & \text{if }  \varphi = \KK\HH?a \\
                                               ?a\cdot\symb{\HH\KK}{\varphi'} & 
                                                      \text{if } \varphi= \tts\HH?a \cdot \HH\KK!a \cdot \varphi' \text{ with } \tts\neq\KK\\
                                                !a\cdot\symb{\HH\KK}{\varphi'}   & 
                                                         \text{if } \varphi= \KK\HH?a \cdot \HH\tts!a \cdot \varphi'  \text{ with } \tts\neq\KK\\
                                               \textit{undefined}  & \text{otherwise } 
                                      \end{array} \right. 
$$
The function $\symb{\KK\HH}{\varphi}$ is defined by simply exchanging the roles of $\HH$ and $\KK$ in the above definition.
\end{definition}

\begin{lemma}
\label{lem:notwomarks}
Let $\phi\in\lang{M^1_\HH}^\mC$.\\
Then there are no two messages $a,c\in \mathbb{A}$ such that \\
$$\phi\cdot !a\in\lang{M^1_\HH}^\mC \mathrm{~and~}  \phi\cdot ?c\in\lang{M^1_\HH}^\mC.$$
Similarly for $\lang{M^2_\KK}^\mC$
\end{lemma}
\begin{proof}
Easy, by induction on the length of $\phi$, 
using the
?!-determinism and no mixed states assumption for
$M^1_\HH$ imposed by compatibility.

\end{proof}

\begin{lemma}
\label{lem:inlangs}
Let $\xi$ be a transition sequence for a system
$S={S_{1}}\connect{\HH}{\KK} {S_{2}}$ starting from the initial state. Then
$$\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC \text{ and }
\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in\lang{M^2_\KK}^\mC$$
\end{lemma}
\begin{proof}
We prove only $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC$, since 
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in\lang{M^2_\KK}^\mC$ can be proved in a similar way.
Let $\xi$ be\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n$
}
where $s_i=({\vec{q_i}},{\vec{w_i}})$.\\
We can proceed by  induction on $n$.\\
\underline{Base case} $n=0$. \\
This case is trivial since $\xi = \restrictup{\xi}{\HH}=\varepsilon$. .\\
\underline{Inductive case} $n\neq 0$.\\
Let $\xi'$ be the sequence $s_0\lts{\elle_1} \ldots \lts{\elle_{n-1}}s_{n-1}$.
We distinguish now two possible cases:
\begin{description}
\item 
${q_n}_\HH\in\widehat{Q_\HH}$.\\
If  $\elle_n = \KK\HH?a$ then, by definition of $\restrictup{\cdot}{\HH}$,
we have that $\restrictup{\xi}{\HH}= \restrictup{\xi'}{\HH}\cdot\KK\HH?a$. 
Then, by definition of $\symb{\HH\KK}{\cdot}$, 
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}=\symb{\HH\KK}{\restrictup{\xi'}{\HH}}\cdot !a$ with
$\symb{\HH\KK}{\restrictup{\xi'}{\HH}}\in\lang{M^1_\HH}^\mC$ by the induction hypothesis.
We can now obtain the thesis since, by definition of $\gateway{\cdot}$, we have that, for a certain $q'$ belonging to the states of $M^1_\HH$, $({q_{n-1}}_\HH, \KK\HH?a, {q_n}_\HH), ({q_{n}}_\HH, \HH\tts!a, q') \in \delta_\HH$ and
 $({q_{n-1}}_\HH, \HH\tts!a, q') \in \delta^1_\HH$
 where $\tts \in \roles_1$. Hence $\symb{\HH\KK}{\restrictup{\xi}{\HH}} = \symb{\HH\KK}{\restrictup{\xi'}{\HH}}\cdot !a
\in \lang{M^1_\HH}^\mC$. \\
 If  $\elle_n = \tts\HH?a$ then, by definition of $\restrictup{\cdot}{\HH}$ and $\symb{\HH\KK}{\restrictup{\cdot}{\HH}}$, we have that $\symb{\HH\KK}{\restrictup{\xi}{\HH}}=\symb{\HH\KK}{\restrictup{\xi'}{\HH}}$
 and hence the thesis follows immediately from the induction hypothesis.\\
 All the other possible forms of $\elle_n$ do not involve $\HH$ and hence $\restrictup{\xi}{\HH}=\restrictup{\xi'}{\HH}$.
 So the thesis follows immediately from the induction hypothesis.
\item
${q_n}_\HH\not\in\widehat{Q_\HH}$\\
It is possible to proceed similarly to the previous case, distinguishing the possible forms of 
$\elle_n$ involving $\HH$.
\end{description}
\end{proof}



The next definition and the subsequent lemma are used to prove Proposition \ref{lem:halfduplex}  and Corollary \ref{lem:prefix} below.
In the lemma we shall  check (besides other things) that
the application of the function $\symb{\_\,\_}{\cdot}$ on a transition sequence yelds a sequence of messages all
prefixed by `?' and that such a sequence does coincide with
 the content of a buffer. In order to formalize such an equality, we define below a function that inserts a `?' in front
 of any message in a buffer.
\begin{definition}
We define $\qm :\messages^* \rightarrow (\Set{?}\times\messages)^*$ by
$$\qm(\varepsilon) = \varepsilon \hspace{12mm} \qm(a\cdot w') = ?a\cdot\qm(w')$$
\end{definition}



\begin{lemma}%\hfill\\
\label{lem:prefixaux}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a reachable configuration of
$S={S_{1}}\connect{\HH}{\KK} {S_{2}}$, and
let $\xi$ be a transition sequence of length $n$ leading to $s\in RS(S)$ from the initial state
such that, for all $0\leq i\leq n$, ${w_i}_{\HH\KK}\neq \varepsilon \implies {w_i}_{\KK\HH}= \varepsilon$.
\begin{enumerate}[i)]
\item
\label{lem:prefix-iii}
If $w_{\HH\KK}= w_{\KK\HH}=\varepsilon$, then
 $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}=\symb{\KK\HH}{\restrictup{\xi}{\KK}}$;

\item
\label{lem:prefix-i}

If $w_{\HH\KK}\neq\varepsilon$  then 
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}$;
\item
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}} = \qm({{w}_{\HH\KK}})$.
\end{enumerate}

\item
\label{lem:prefix-ii}

If $w_{\KK\HH}\neq\varepsilon$ then 
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}$
 is a strict prefix of
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}$;

\item
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\setminus \Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}
 = \qm({{w}_{\KK\HH}})$
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Let $\xi$ be the following transition sequence leading to $s\in RS(S)$ from the initial state\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n=s$}
where $s_i=(\vec{q_i},\vec{w_i})$.\\
We show  (\ref{lem:prefix-iii}), (\ref{lem:prefix-i}) and (\ref{lem:prefix-ii}) by simultaneous
 induction over $|\xi|$.\\
\underline{Base case} $|\xi|=n=0$. \\
It is immediate to check that  ${w_0}_{\KK\HH}={w_0}_{\HH\KK}=\varepsilon$
and $\restrictup{\xi}{\HH}=\restrictup{\xi}{\KK}=\varepsilon$. 

Then (\ref{lem:prefix-iii}) trivially holds,
whereas (\ref{lem:prefix-i}) and (\ref{lem:prefix-ii}) are vacuously satisfied.\\
\underline{Inductive case} $|\xi|=n\neq 0$.\\
In case the action $\elle_n$ does not involve neither $\HH$ nor $\KK$, the thesis descends immediately
from the induction hypothesis on $\xi' \equiv
s_0\lts{\elle_1} \ldots \lts{\elle_{n-1}}s_{n-1}$, since $ {w_{n-1}}_{\HH\KK}  = w_{\HH\KK}$,
$ {w_{n-1}}_{\KK\HH}  = w_{\KK\HH}$,  $\symb{\KK\HH}{\restrictup{\xi'}{\KK}}= \symb{\KK\HH}{\restrictup{\xi}{\KK}}$
 and $\symb{\HH\KK}{\restrictup{\xi'}{\HH}}= \symb{\HH\KK}{\restrictup{\xi}{\HH}}$.\\
Otherwise, we distinguish two cases: either $\elle_n$ corresponds to an action performed by $\HH$ or
by an action  performed by $\KK$. Let us consider only the first case, since the second one can be treated in the same way.\\
Now we need to consider the following further possibilities concerning the form
of $\elle_n$.


\begin{description}
\item
$\elle_n =\HH\KK!a$.\\
In such a case, we can infer that ${w_n}_{\HH\KK}= {w_{n-1}}_{\HH\KK}\cdot  a\neq\varepsilon$.
In this case, (\ref{lem:prefix-iii}) and also  (\ref{lem:prefix-ii}), since by assumption ${w_{n}}_{\KK\HH} = \varepsilon$, when ${w_{n}}_{\HH\KK} \neq \varepsilon$,
 are vacuously satisfied and only item (\ref{lem:prefix-i}) has to be proved.\\

Since $\elle_n =\HH\KK!a$, we have that 
\begin{equation}
\label{eq:weq}
\restrictup{\xi'}{\KK}=\restrictup{\xi}{\KK}
\end{equation}
and hence $\symb{\KK\HH}{\restrictup{\xi'}{\KK}} = \symb{\KK\HH}{\restrictup{\xi}{\KK}}$. 
Moreover, by definition of $\gateway{\cdot}$ and $\symb{\HH\KK}{\cdot}$, 
\begin{equation}
\label{eq:xipxi}
\symb{\HH\KK}{\restrictup{\xi}{\HH}} = \symb{\HH\KK}{\restrictup{\xi'}{\HH}}\cdot ?a
\end{equation}



By the hypothesis
 $\forall 0\leq i\leq n. {w_i}_{\HH\KK}\neq \varepsilon \implies {w_i}_{\KK\HH}= \varepsilon$,
we have to consider only the following subcases:
\begin{description}
\item
      ${w_{n-1}}_{\HH\KK} = {w_{n-1}}_{\KK\HH} = \varepsilon$ and ${w_n}_{\HH\KK} = a$.\\
By the induction hypothesis for (\ref{lem:prefix-iii}),we get
$$\Dual{\symb{\HH\KK}{\restrictup{\xi'}{\HH}}}=\symb{\KK\HH}{\restrictup{\xi'}{\KK}} = \symb{\KK\HH}{\restrictup{\xi}{\KK}} $$
Hence, 
$$\symb{\HH\KK}{\restrictup{\xi'}{\HH}} = \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$$
Then, by (\ref{eq:xipxi}), we get
$$\symb{\HH\KK}{\restrictup{\xi}{\HH}} = \symb{\HH\KK}{\restrictup{\xi'}{\HH}}\cdot ?a = 
 \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}} \cdot ?a$$
Thus we obtain the thesis, namely
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}$;
\item
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}} = ?a = \qm(a) = \qm({{w_n}_{\HH\KK}})$
\end{enumerate}

\item
      ${w_{n-1}}_{\HH\KK}\neq\varepsilon$ and ${w_{n}}_{\HH\KK}= {w_{n-1}}_{\HH\KK}\cdot a$\\
Let us hence assume ${w_{n-1}}_{\HH\KK}$ to be of the form $\phi\cdot b$.\\
By the induction hypothesis for (\ref{lem:prefix-i}) we have
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\KK\HH}{\restrictup{\xi'}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\xi'}{\HH}}$;
\item
$\symb{\HH\KK}{\restrictup{\xi'}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi'}{\KK}}}) = \qm({{w_{n-1}}_{\HH\KK}})$
\end{enumerate}

     By the above, by (\ref{eq:weq}) and (\ref{eq:xipxi}) and by the fact that
 ${{w_{n}}_{\HH\KK}}= {{w_{n-1}}_{\HH\KK}}\cdot a$ we obtain
 \begin{itemize}
\item[c)]
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$
 is a strict prefix of
$\mathsf{init}(\symb{\HH\KK}{\restrictup{\xi}{\HH}})$ with $\mathsf{last}(\symb{\HH\KK}{\restrictup{\xi}{\HH}}) = ?a$;
\item[d)]
$\mathsf{init}(\symb{\HH\KK}{\restrictup{\xi}{\HH}})\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}} = \qm(\mathsf{init}({\vec{w_{n}}_{\HH\KK}}))$  with $\mathsf{last}({\vec{w_{n}}_{\HH\KK}}) = ?a $
\end{itemize}
Out of the above the thesis descends immediately.
\end{description}


\item
       $\elle_n =\HH\tts!a$ with $\tts \in \roles_1$ (hence $\tts\neq\KK$).\\
Since $\elle_n =\HH\tts!a$, we have  
\begin{equation}
\label{eq:weq2}
\restrictup{\xi'}{\KK}=\restrictup{\xi}{\KK}
\end{equation}
and 
\begin{equation}
\label{eq:weqw}
{w_{n-1}}_{\KK\HH} = {w_{n}}_{\KK\HH} \text{ and } {w_{n-1}}_{\HH\KK} = {w_{n}}_{\HH\KK}
\end{equation}

Moreover, by definition of $\gateway{\cdot}$ and $\symb{\HH\KK}{\cdot}$, 
\begin{equation}
\label{eq:xipxi2}
\symb{\HH\KK}{\restrictup{\xi}{\HH}} = \symb{\HH\KK}{\restrictup{\xi'}{\HH}}
\end{equation}

The thesis hence follows by the induction hypothesis.


\item
       $\elle_n =\KK\HH?a$\\
Since $\elle_n =\KK\HH?a$, we have 
\begin{equation}
\label{eq:weq3}
\restrictup{\xi'}{\KK}=\restrictup{\xi}{\KK}
\end{equation}
Moreover, by definition of $\gateway{\cdot}$ and $\symb{\HH\KK}{\cdot}$, 
\begin{equation}
\label{eq:xipxi3}
\symb{\HH\KK}{\restrictup{\xi}{\HH}} = \symb{\HH\KK}{\restrictup{\xi'}{\HH}}\cdot !a
\end{equation}

By the hypothesis
 $\forall 0\leq i\leq n. {w_i}_{\HH\KK}\neq \varepsilon \implies {w_i}_{\KK\HH}= \varepsilon$,
we have to consider only the following subcases:

\begin{description}
\item
      ${w_{n-1}}_{\KK\HH} = a\cdot {w_{n}}_{\KK\HH}$ with ${w_{n}}_{\KK\HH}\neq \varepsilon$\\
In this case, (\ref{lem:prefix-iii}) and (\ref{lem:prefix-i}) are vacuously satisfied. For what concerns
(\ref{lem:prefix-ii}),
by the induction hypothesis we have
\begin{enumerate}[a)]
\item 
\label{l:aa}
$\Dual{\symb{\HH\KK}{\restrictup{\xi'}{\HH}}}$
 is a strict prefix of
$\symb{\KK\HH}{\restrictup{\xi'}{\KK}}$;
\item
\label{l:bb}
$\symb{\KK\HH}{\restrictup{\xi'}{\KK}}\setminus \Dual{\symb{\HH\KK}{\restrictup{\xi'}{\HH}}} = \qm({{w_{n-1}}_{\KK\HH}})$
\end{enumerate}

     By the above, using  (\ref{eq:weq3}), (\ref{eq:xipxi3}), we  get
\begin{itemize}
\item[c)]
\label{l:cc}
$\Dual{\init(\symb{\HH\KK}{\restrictup{\xi}{\HH}})}
\text{ is a strict prefix of }
\symb{\KK\HH}{\restrictup{\xi}{\KK}}$
with $\last(\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}})= ?a$;
\item[d)]
\label{l:dd}
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\setminus \Dual{\init(\symb{\HH\KK}{\restrictup{\xi}{\HH}})} =  \qm({w_{n-1}}_{\KK\HH}) =?a\cdot\qm({{w_{n}}_{\KK\HH}})$
\end{itemize}

and then, by c) and  d) above  the thesis descends immediately.

\item
      ${w_{n-1}}_{\KK\HH} = a\cdot {w_{n}}_{\KK\HH}$ with ${w_{n}}_{\KK\HH}={w_{n}}_{\HH\KK} = \varepsilon$\\
In this case, (\ref{lem:prefix-i})  and (\ref{lem:prefix-ii}) are vacuously satisfied. For what concerns
(\ref{lem:prefix-iii}),
by the induction hypothesis for (\ref{lem:prefix-ii}) we have
\begin{enumerate}[a)]
\item 
\label{l:aa}
$\Dual{\symb{\HH\KK}{\restrictup{\xi'}{\HH}}}$
 is a strict prefix of
$\symb{\KK\HH}{\restrictup{\xi'}{\KK}}$;
\item
\label{l:bb}
$\symb{\KK\HH}{\restrictup{\xi'}{\KK}}\setminus \Dual{\symb{\HH\KK}{\restrictup{\xi'}{\HH}}} = \qm({{w_{n-1}}_{\KK\HH}}) = ?a$
\end{enumerate}
     By the above, using  (\ref{eq:weq3}), (\ref{eq:xipxi3}), we  get
\begin{itemize}
\item[c)]
\label{l:ccc}
$\Dual{\init(\symb{\HH\KK}{\restrictup{\xi}{\HH}})}
\text{ is a strict prefix of }
\symb{\KK\HH}{\restrictup{\xi}{\KK}}$ 
with $\last(\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}})= ?a$;
\item[d)]
\label{l:ddd}
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\setminus\Dual{\init(\symb{\HH\KK}{\restrictup{\xi}{\HH}})} =  ?a$
\end{itemize}
and then, by c) and  d) above we can infer the thesis, namely
$$\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}} = 
\symb{\KK\HH}{\restrictup{\xi}{\KK}}$$

\end{description}


\item
       $\elle_n =\tts\HH?a$ with  $\tts \in \roles_1$ (hence $\tts\neq\KK$)\\
Since $\elle_n = \tts\HH?a$, we have  
\begin{equation}
\label{eq:weq2}
\restrictup{\xi'}{\KK}=\restrictup{\xi}{\KK}
\end{equation}
and 
\begin{equation}
\label{eq:weqw}
{w_{n-1}}_{\KK\HH}= {w_{n}}_{\KK\HH} \text{ and } {w_{n-1}}_{\HH\KK}= {w_{n}}_{\HH\KK}
\end{equation}

Moreover, by definition of $\gateway{\cdot}$ and $\symb{\HH\KK}{\cdot}$, 
\begin{equation}
\label{eq:xipxi2}
\symb{\HH\KK}{\restrictup{\xi}{\HH}} = \symb{\HH\KK}{\restrictup{\xi'}{\HH}}
\end{equation}

The thesis hence follows by the induction hypothesis.

\end{description}

\end{proof}


The following proposition essentially shows that in gateway-connected systems any pair of FIFO channels  connecting
gateways is such that in each reachable configuration at least one of the two buffers is empty, that is they
 can be replaced by a half-duplex channel.

\begin{proposition}%\hfill\\
\label{lem:halfduplex}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a reachable configuration of
$S={S_{1}}\connect{\HH}{\KK} {S_{2}}$.
Then $w_{\HH\KK}$ and  $w_{\KK\HH}$ cannot be both non-empty. That is
$${w}_{\HH\KK}\neq \varepsilon \implies {w}_{\KK\HH}= \varepsilon$$
\end{proposition}

\begin{proof}
Towards a contradiction, we assume the thesis not to hold.
We then take, among all the transition sequences $\zeta$ leading (from the initial state) to a state $s_{\zeta}= (\vec{q_\zeta},\vec{w_\zeta}) \in RS(S)$
such that 
\begin{equation}
\label{tchyp}
{w_\zeta}_{\HH\KK}\neq \varepsilon  \text{ and } {w_\zeta}_{\KK\HH} \neq \varepsilon,
\end{equation}
a sequence having a minimal length.
 Let the following sequence $\xi$ be such a sequence.
$$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n$$
where $s_i=({\vec{q_i}},{\vec{w_i}})$. And let $s_{\xi}$ be $s=(\vec{q},\vec{w}) \in RS(S)$.
Since ${w_0}_{\HH\KK} = {w_0}_{\KK\HH} = \varepsilon$, we have that  $|\xi| > 0$.
\\
By the minimality of $|\xi |$, we can infer that one of the following two cases necessarily holds:
either    ${w_{n-1}}_{\KK\HH} = \varepsilon$ or ${w_{n-1}}_{\HH\KK} = \varepsilon$.
%We can assume the first case to hold since the other one can be treated similarly.
Without loss of generality, assume
  $w_{{n-1}_{\KK\HH}} = \varepsilon$.\\
In this case, as a consequence of (\ref{tchyp}), we have that ${w_{n-1}}_{\HH\KK}= {w_\xi}_{\HH\KK} \neq \varepsilon$.\\
So we are assuming that 
\begin{equation}
\label{allnonbothnonempty}
{w_i}_{\HH\KK}\neq \varepsilon \implies {w_i}_{\KK\HH}= \varepsilon \text{~~ for all } 0\leq i \leq n-1
\end{equation}
and
\begin{equation}
\label{ngetsnonempty}
{{w_{n-1}}}_{\HH\KK} \neq\varepsilon  \text{ and } {{w_{n-1}}}_{\KK\HH} = \varepsilon \text{ and } {w_{n}}_{\KK\HH}\neq \varepsilon
\end{equation}


To get a contradiction, the idea is the following: First, since ${{w_{n-1}}}_{\HH\KK} \neq\varepsilon$,
\ref{lem:prefixaux}(\ref{lem:prefix-i})  implies, that the next action of  $M_\KK$ in configuration 
$s_{n-1}$ can only be the consumption of an element $c$ of the channel ${w_{n-1}}_{\HH\KK}$.
 On the other hand, since ${w_{n-1}}_{\KK\HH}= \varepsilon$ and  ${w_{n}}_{\KK\HH} \neq \varepsilon$, to progress from $s_{n-1}$ to $s_n$  $M_\KK$ must put an element $a$ into the buffer ${w_{n-1}}_{\KK\HH}$. But both is not possible.
Let us now do the formal proof of the contradiction. \\
By Lemma \ref{lem:inlangs}, 
$\symb{\HH\KK}{\restrictup{(\upto{\xi}{n-1})}{\HH}}\in \lang{M^1_\HH}^\mC$ and 
$\symb{\KK\HH}{\restrictup{(\upto{\xi}{n-1})}{\KK}} \in \lang{M^2_\KK}^\mC$.\\
Moreover, since we have (\ref{allnonbothnonempty}) and (\ref{ngetsnonempty}), by Lemma \ref{lem:prefixaux} we can infer that  
\begin{enumerate}[a)]
\item 
\label{en:a}
$\Dual{\symb{\KK\HH}{\restrictup{\upto{\xi}{n-1}}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\upto{\xi}{n-1}}{\HH}}$;
\item
\label{en:b}
$\symb{\HH\KK}{\restrictup{\upto{\xi}{n-1}}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\upto{\xi}{n-1}}{\KK}}} = \qm({{w_{n-1}}_{\HH\KK}})$.
\end{enumerate}

Recall that by definitions of $\gateway{\cdot}$ and  $\restrictup{(\cdot)}{(\cdot)}$,  
 we have that $\restrictup{\xi}{\HH}$ is made (but for its last element, in case $|\restrictup{\xi}{\HH}|$ is odd) of consecutive pairs of elements of $\textit{Act}$ either of the form
$\KK\HH?a \,\, \HH\tts!a$, with $\tts\neq\KK$, or $\tts\HH?a \,\,\HH\KK!a$, with $\tts\neq\KK$.
Moreover, in case $|\restrictup{\xi}{\HH}|$ is odd, it ends with an action either of the form
$\KK\HH?a$ or $\tts\HH?a$, with $\tts\neq\KK$.
Similarly for $\restrictup{\xi}{\KK}$.\\


Hence, as a consequence of (\ref{en:a}) and (\ref{en:b}) above, there exists a message $c$ such that 
$$\Dual{\symb{\KK\HH}{\restrictup{\upto{\xi}{n-1}}{\KK}}}\cdot ?c \in \lang{M^1_\HH}^\mC$$
Now, from (\ref{ngetsnonempty}) (in particular ${w_{n-1}}_{\KK\HH} = \varepsilon$ and ${w_{n}}_{\KK\HH} \neq \varepsilon$), we can infer also that, for a certain message $a$,
$$\symb{\KK\HH}{\restrictup{(\upto{\xi}{n-1})}{\KK}}\cdot ?a \in \lang{M^2_\KK}^\mC.$$
By definition of compatibility we have $\lang{M^1_\HH}^\mC = \Dual{\lang{M^2_\KK}^\mC}$ and hence
 $$\Dual{\symb{\KK\HH}{\restrictup{(\upto{\xi}{n-1})}{\KK}}\cdot ?a} = \Dual{\symb{\KK\HH}{\restrictup{(\upto{\xi}{n-1})}{\KK}}}\cdot !a \in \lang{M^1_\HH}^\mC$$
 So we have both $\Dual{\symb{\KK\HH}{\restrictup{\upto{\xi}{n-1}}{\KK}}}\cdot ?c \in \lang{M^1_\HH}^\mC$
 and $ \Dual{\symb{\KK\HH}{\restrictup{(\upto{\xi}{n-1})}{\KK}}}\cdot !a \in \lang{M^1_\HH}^\mC$, which, by Lemma \ref{lem:notwomarks}
 is a contradiction.
\end{proof}

The next corollary is an immediate consequence of Lemma \ref{lem:prefixaux}  and Proposition \ref{lem:halfduplex}. It is the key for getting our preservation results in the next section.

\begin{corollary}%\hfill\\
\label{lem:prefix}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a reachable configuration of
$S={S_{1}}\connect{\HH}{\KK} {S_{2}}$, and
let $\xi$ be a transition sequence leading to $s\in RS(S)$ from the initial state.
\begin{enumerate}[i)]
\item
\label{lem:prefixcor-iii}
If $w_{\KK\HH}= w_{\HH\KK}=\varepsilon$, then
 $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}=\symb{\KK\HH}{\restrictup{\xi}{\KK}}$;

\item
\label{lem:prefixcor-i}

If $w_{\HH\KK}\neq\varepsilon$  then 
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}$;
\item
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}} = \qm({{w}_{\HH\KK}})$.
\end{enumerate}

\item
\label{lem:prefixcor-ii}

If $w_{\KK\HH}\neq\varepsilon$ then 
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}$
 is a strict prefix of
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}$;

\item
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\setminus \Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}
 = \qm({{w}_{\KK\HH}})$
\end{enumerate}
\end{enumerate}
\end{corollary}
\begin{proof}
Immediate by Lemma \ref{lem:prefixaux} and Proposition \ref{lem:halfduplex}.
\end{proof}


\subsection{Preservation of deadlock-freeness}

\begin{lemma}%\hfill\\
\label{lem:weakdfpreservation}
Let $s= (\vec{q},\vec{\varepsilon})$ be a deadlock configuration of $S={S_{1}}\connect{\HH}{\KK} {S_{2}}$.
Then there exists $i\in\Set{1,2}$ such that $\restrict{s}{i}\in RS(S_i)$ and $\restrict{s}{i}$ is a deadlock configuration for $S_i$.
\end{lemma}

\begin{proof}
By definition of deadlock configuration and by Fact \ref{fact:uniquesending}(\ref{fact:uniquesending-i}), we have that
neither $q_\HH\in\widehat{Q_\HH}$ nor $q_\KK\in\widehat{Q_\KK}$. Otherwise
there will be an output transition from either $q_\HH$ or  $q_\KK$, contradicting $s$ to be a deadlock configuration.
Hence necessarily $q_\HH\not\in\widehat{Q_\HH}$ and $q_\KK\not\in\widehat{Q_\KK}$. 
So, by Lemma \ref{lem:nohatrestrict} we get $\restrict{s}{i}\in RS(S_i)$ for $i=1,2$.

Now, since $s$ is a deadlock configuration, we have \\
\centerline{$\vec{w}=\vec{\varepsilon}$ and 
$\forall \ttp\in\roles.~q_\ttp$  is a receiving state.}
By definition of $\gateway{\cdot}$ and by the no mixed state condition on $M^1_\HH$ and $M^2_\KK$
imposed by compatibility,  we need  to 
take into account only the following possible cases concerning the shapes of the transitions from  $q_\HH$  in $\delta_\HH$ and from  $q_\KK$ in $\delta_\KK$.

\begin{description}
\item
\underline{$\diamond$} 
{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$ and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts \in \roles_2$ (and hence $\tts\neq\HH$).}\\
Since all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts \in \roles_2$ (and hence $\tts\neq\HH$),
  we can infer, from the definition of  $\gateway{\cdot}$, that also  all the transitions from $q_\KK$ in $\delta^2_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$. Hence we obtain that $\restrict{s}{2}$ is a deadlock configuration of $S_2$.
  
\item
\underline{$\diamond$} 
{\em All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\tts\HH?\_,\_)$ with $\tts \in \roles_1$ (and hence $\tts\neq\KK$) and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$.}\\
This case can be treated similarly to the previous one, obtaining  $\restrict{s}{1}$ to be a deadlock configuration of $S_1$.

\item
\underline{$\diamond$} 
{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\tts\HH?\_,\_)$ with $\tts\in\roles_1$ and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts\in\roles_2$.}\\
Actually this case cannot occur, but even if it could, we could argue as in the previous cases, obtaining
both $\restrict{s}{1}$ and $\restrict{s}{2}$ to be deadlock configurations, respectively of $S_1$ and $S_2$.

\item
\underline{$\diamond$}
{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$ and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$.}\\
 Since $w_{\HH\KK}=w_{\KK\HH}=\varepsilon$,
this case cannot occur. Towards a contradiction, let us assume it to be possible.\\
Let now $\xi$ be a transition sequence leading to $s\in RS(S)$ from the initial state, in particular let $\xi$ be\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n=s$
}
 By Lemma \ref{lem:inlangs},
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC $ and $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in\lang{M^2_\KK}^\mC$. Moreover, by Corollary \ref{lem:prefix}(\ref{lem:prefixcor-iii}),
  $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}=\symb{\KK\HH}{\restrictup{\xi}{\KK}}$.
  Since all the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$ and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$,
we can infer, by definition of $\gateway{\cdot}$, that  $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot !a\in\lang{M^1_\HH}^\mC $ and $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !b\in\lang{M^2_\KK}^\mC$ for certain $a$ and $b$.

We have then that $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?b} = {\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !b} \in\lang{M^2_\KK}^\mC$
and hence, since by compatibility $\Dual{\lang{M^1_\HH}^\mC} = \lang{M^2_\KK}^\mC$, also that
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?b\in \lang{M^1_\HH}^\mC$.\\
 To have both $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot !a\in\lang{M^1_\HH}^\mC $ and 
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?b\in \lang{M^1_\HH}^\mC$
does contradict the no mixed state condition of compatibility since,
 by ?!-determinism of $M^1_\HH$, ${q}_\HH$ is the unique state of $M^1_\HH$ 
recognising the string $\symb{\HH\KK}{\restrictup{\xi}{\HH}}$. 
\end{description}
\end{proof}

\begin{corollary}[Preservation of deadlock-freeness]%\hfill\\
\label{prop:weakdfPreservation}
Let $S_1$ and $S_2$ be deadlock-free.
Then $S = {S_{1}} \connect{\HH}{\KK} {S_{2}}$ is deadlock-free.
\end{corollary}
\begin{proof}
By contradiction, let us assume there is an $s\in RS(S)$ which is a deadlock configuration of $S$. We get
immediately a contradiction by Lemma \ref{lem:weakdfpreservation}.
\end{proof}









\subsection{No-orphan-message preservation}


 \begin{lemma}
\label{lem:wempty}
%Let $S={S_{1}}\connect{\HH}{\KK} {S_{2}}$.
If $s= (\vec{q},\vec{w}) \in RS(S)$ is a reachable configuration of $S={S_{1}}\connect{\HH}{\KK} {S_{2}}$ 
such that ${q}_\KK$ is final, then ${w}_{\HH\KK} = \varepsilon$.
%both  states $\vec{q}_\HH$ and $\vec{q}_\KK$ are final, then $\vec{w}_{\HH\KK} = \vec{w}_{\KK\HH} = \varepsilon$.
The same holds by exchanging $\HH$ and $\KK$.
\end{lemma}

\begin{proof}
By Fact. \ref{fact:uniquesending}(\ref{fact:uniquesending-i}), 
%$q_\HH\notin \widehat{Q_\HH}$ and 
$q_\KK\notin \widehat{Q_\KK}$.
Let now $\xi$ be a transitions sequence leading to $s\in RS(S)$ from the initial state, say\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n=s$
}
Towards a contradiction, let us assume $\vec{w}_{\HH\KK}\neq \varepsilon$ 
%(the case  $\vec{w}_{\KK\HH}\neq \varepsilon$ can be treated similarly). 
Hence, by Corollary \ref{lem:prefix} we get
\begin{enumerate}[a)]
\item 
\label{l:aaaa}
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}$;
\item
\label{l:bbbb}
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}} = \qm({{w}_{\HH\KK}})$.
\end{enumerate}
Now, by ?!-determinism of 
%$M^1_\HH$ and 
$M^2_\KK$ and by 
%$q_\HH\notin \widehat{Q_\HH}$ and 
$q_\KK\notin \widehat{Q_\KK}$, we have that $\vec{q}_\KK$ is the unique state of $M^2_\KK$ recognising the string 
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in \lang{M^2_\KK}^\mC$.\\
% Let now $q$ be the unique state of $M^2_\KK$ 
%recognizing the string $\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$.\\
Now, by (\ref{l:aaaa}) and (\ref{l:bbbb}) above and knowing, by Lemma \ref{lem:inlangs}, that $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC $, 
there exists a message $a$ such that
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}\cdot ?a \in \lang{M^1_\HH}^\mC$.
Hence, by compatibility, $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !a \in \lang{M^2_\KK}^\mC$.
Contradiction, since $\vec{q}_\KK$ is final.
\end{proof}



\begin{lemma}%\hfill\\
\label{lem:restrRSom}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be an orphan-message configuration for $S$.
Then,
either $\restrict{s}{1}$ is an  orphan-message configuration for $S_1$
or $\restrict{s}{2}$ is an  orphan-message configuration for $S_2$.
\end{lemma}

\begin{proof}
By hypothesis,  let $s= (\vec{q},\vec{w}) \in RS(S)$ be an orphan-message configuration for $S$, 
that is $\vec{q}$ is final and $\vec{w}\neq \vec{\varepsilon}$.
Since $\vec{q}$ is final, then a fortiori $q_\HH$ and $q_\KK$ are final, and hence, by Lemma \ref{lem:wempty}, it follows that $w_{\HH\KK} = w_{\KK\HH} = \varepsilon$.
This implies that, since  $\vec{w}\neq \vec{\varepsilon}$, we have to consider only the following two cases.
\begin{description}
\item
$\exists \ttp,\ttq\in \roles_1$ such that  $w_{\ttp\ttq}\neq\varepsilon$\\
By Lemma \ref{lem:nohatrestrict} we have that $\restrict{s}{1}\in RS(S_1)$. Moreover, from the hypothesis, we 
trivially get that $(\vec{q}_\tts)_{\tts\in\roles_1}$ is final. So, by definition, $\restrict{s}{1}$ is an  orphan-message configuration of $S_1$.
\item
$\exists \ttp',\ttq'\in \roles_2$ with  $w_{\ttp'\ttq'}\neq\varepsilon$ \\
We can argue as in the previous case, getting  $\restrict{s}{2}$ to be an  orphan-message configuration of $S_2$.
\end{description}
\end{proof}

\begin{corollary}[Preservation of no orphan-message]%\hfill\\
\label{prop:nomPreservation}
%Let $S={S_{1}}\connect{\HH}{\KK} {S_{2}}$, and 
Let $S_1$ and $S_2$ be such that both  $RS(S_{1})$ and $RS(S_{2})$ do not contain any orphan-message configuration.
Then there is no orphan-message configuration in $RS(S)$.
\end{corollary}
\begin{proof}
By contradiction, let us assume there is an $s\in RS(S)$ which is an orphan-message configuration. We get
immediately a contradiction by Lemma \ref{lem:restrRSom}.
\end{proof}


\subsection{Preservation of no unspecified reception}

The following lemma is crucial for proving our preservation results for absence of unspecified receptions and progress.


\begin{lemma}%\hfill\\
\label{lem:getright}
Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a reachable configuration of
$S={S_{1}}\connect{\HH}{\KK} {S_{2}}$ such that 
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$.
Then
$$w_{\HH\KK}= a\cdot w' \implies  \exists (q_\KK,\HH\KK?a,\_)\in\delta_\KK$$
The same property holds by exchanging $\HH$ and $\KK$.
 \end{lemma}
 
 \begin{proof}
Let $\xi$ be a transition sequence leading to $s$ from the initial state, in particular let $\xi$ be\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n=s$
}
where $s_i=({\vec{q_i}},{\vec{w_i}})$.\\
Moreover, let us assume $w_{\HH\KK}= a\cdot w'$.
Now, by Corollary \ref{lem:prefix}(\ref{lem:prefixcor-i}) 
we have that
\begin{enumerate}[a)]
\item 
$\Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$
 is a strict prefix of
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}$;
\item
$\symb{\HH\KK}{\restrictup{\xi}{\HH}}\setminus \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}
= \qm({w_{\HH\KK}}) = ?a\cdot  \qm({w'}) $.
\end{enumerate}
Moreover $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC$ and
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in\lang{M^2_\KK}^\mC$ by Lemma \ref{lem:inlangs}.

Now, let $j$ be the greatest index such that ${q_j}_\HH\not\in\widehat{Q_\HH}$ and 
$\symb{\HH\KK}{\restrictup{\upto{\xi}{j}}{\HH}} = \Dual{\symb{\KK\HH}{\restrictup{\xi}{\KK}}}$.
Then necessarily $s_j\lts{\tts\HH?a} s_{j+1}$.
% and  $s_{j'}\lts{\HH\KK!a} s_{j'+1}$ for a $j'$ such that $j<j'\leq n$. 
Now, by ?!-determinism of $M^1_\HH$ and $M^2_\KK$, we have that ${q_j}_\HH$ is the unique state of $M^1_\HH$ recognising the string 
$\symb{\HH\KK}{\restrictup{\upto{\xi}{j}}{\HH}}$ and ${q}_\KK$ is the unique state of $M^2_\KK$ 
recognising the string $\symb{\KK\HH}{\restrictup{\xi}{\KK}} = \Dual{\symb{\HH\KK}{\restrictup{\upto{\xi}{j}}{\HH}}}$.
Obviously, $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !a =
\Dual{\symb{\HH\KK}{\restrictup{\upto{\xi}{j}}{\HH}}\cdot ?a}$. Because 
 $\symb{\HH\KK}{\restrictup{\upto{\xi}{j}}{\HH}}\cdot ?a \in \lang{M^1_\HH}^\mC$
and, by compatibility,  $\lang{M^1_\HH}^\mC=  \Dual{\lang{M^2_\KK}^\mC}$ we then know that 
$\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !a \in \lang{M^2_\KK}^\mC$.
Hence, by definition of $\symb{\KK\HH}{\cdot}$, $\exists ({q}_\KK,\HH\KK?a,\_)\in\delta_\KK$.\\
 The very same argument can be used to show the statement with $\HH$ and $\KK$ exchanged. 
 \end{proof}
 
 We are now ready to prove preservation of no unspecified reception.
Intuitively this holds, since, by Lemma~\ref{lem:getright}, no ``wrong'' elements can be put
in a gateway-connecting channel, if the interface machines are compatible.   
 


\begin{proposition}[Preservation of no unspecified reception]
\label{prop:nurPreservation}
Let $S_1$ and $S_2$ be such that both  $RS(S_{1})$ and $RS(S_{2})$ do not contain any unspecified reception configuration.
Then there is no unspecified reception configuration in $RS(S)$.
\end{proposition}

\begin{proof}
By contradiction, let us assume there is an $s= (\vec{q},\vec{w})\in RS(S)$ which is an unspecified reception configuration.
So, let $\ttr \in \textbf{P}$ and let ${q}_\ttr$  be the receiving state of $M_\ttr$ prevented from 
receiving any message from any of its buffers (Definition \ref{def:safeness}(\ref{def:safeness-ur})).
Without loss of generality, we can assume $\ttr\in\roles_1$, since the case $\ttr\in\roles_2$ can be
treated in a similar way.\\
Now we  take into account the following possible cases:

\begin{description}
\item 
${q}_\HH=\widehat{q}\not\in \widehat{Q_\HH}$.\\ 
By Lemma \ref{lem:nohatrestrict} we get $\restrict{s}{1}\in RS(S_1)$. 
We distinguish now two further subcases.
\begin{description}
\item 
$\ttr \neq \HH$\\
We get a contradiction by the hypothesis that $RS(S_{1})$ does not contain any unspecified reception configuration.
\item 
$\ttr = \HH$\\
Since ${q}_\ttr(= {q}_\HH)$ is a receiving state,
by definition of $\gateway{\cdot}$ it follows that
 the set
of all the outgoing transitions from $q_\HH$ in $\delta_\HH$ is of the form 
$$\Set{({q}_\HH,\tts_j\HH?a_j,\widehat{q_j})}_{j=1..m}$$
By definition of unspecified reception configuration,  we have hence that for all $j=1..m$, 
$$\mid w_{\tts_j\HH}\mid > 0 
\text{ and } w_{\tts_j\HH}\not\in \mathbb{A}^*\cdot a_j$$
Now, the following further possibilities have to be taken into account\\
\underline{$\diamond$} {\it  $\tts_j\neq\KK$ for all $j=1..m$.}\\
By Fact \ref{fact:uniquesending}(\ref{fact:uniquesending-iii}) and definition of $\gateway{\cdot}$ we have that  
$$[(q_\HH,\tts_j\HH?a_j,\widehat{q_j})\in\delta_\HH  ~~\wedge ~~
\tts_j\neq\KK] \iff  
(q_\HH,\tts\HH?a_j,q_j)\in\delta^1_\HH$$
 This implies $\restrict{s}{1}$ to be an  unspecified reception configuration for $S_1$. Contradiction.\\
\underline{$\diamond$} {\it $\tts_j = \KK$ for all  $j=1..m$.} \\
In this case we do get a contradiction by Lemma \ref{lem:getright}.
\end{description}


\item 
${q}_\HH=\widehat{q}\in \widehat{Q_\HH}$.\\ 
By Fact \ref{fact:uniquesending}(\ref{fact:uniquesending-i}),
${q}_\HH\in \widehat{Q_\HH}$ is a sending state such that $({q}_\HH,\HH\tts!a,{q'}_\HH)\in{\delta}_\HH$. Hence it is impossible that $\ttr=\HH$.
So, let $\ttr\neq\HH$.
It is now immediate to check that  there exists an element $s'\in RS(S)$ such that
$s\lts{\HH\tts!a}s'=(\vec{q'},\vec{w'})$ with ${q'}_\HH\not\in \widehat{Q_\HH}$
and $\tts \in \roles_1 \cup \Set{\KK}$.
It hence follows, by Lemma \ref{lem:nohatrestrict}, that $\restrict{s'}{1} \in RS(S_1)$.
Moreover, we have that 
\begin{enumerate}[a)]
\item
\label{l:aa}
$\forall \ttp\neq\HH.\ {q'}_\ttp = {q}_\ttp$;
\item
\label{l:bb}
$\forall \ttp\ttq \neq \HH\tts.\ {w'}_{\ttp\ttq} = {w}_{\ttp\ttq}$;
\item
\label{l:cc}
${w'}_{\HH\tts} = a\cdot{w}_{\HH\tts}$.
\end{enumerate}
We consider now the following two possible subcases:
\begin{description}
\item
%$\tts\neq\ttr$ (and hence $\tts = \KK$)\\
$\tts = \KK$\\
By ($\ref{l:aa}$) and ($\ref{l:bb}$) above it follows that  also $\restrict{s'}{1} \in RS(S_1)$ is an unspecified reception configuration. Contradiction.
\item
%$\tts=\ttr$ (and hence $\tts \in \roles_1$)\\
$\tts \in \roles_1$\\
In this case $\HH$ sends the message $a$ to the buffer $w_{\HH\ttr}$. Since $q_\ttr$ is the receiving state of $M_\ttr$ prevented from receiving any message from any of its buffers, which all are not empty in configuration $s$, the sending of $a$ extends $w_{\HH\ttr}$ which still has a wrong element on its first position. Then, by (a) and (b) above $\restrict{s'}{1}$ is an unspecified reception configuration of $S_1$.  Contradiction.


%By definition of unspecified-reception configuration we have that if 
%$$\Set{(\vec{q}_\HH,\ttp_j\ttr?a_j,\widehat{q_j})}_{j=1..m}$$
%is the set of all the outgoing transitions from $q_\HH$ in $\delta_\HH$, then
%for any $j=1..m$, 
%$$\mid \vec{w}_{\ttp_j\ttr}\mid > 0 
%\text{ and } \vec{w}_{\ttp_j\ttr}\not\in \mathbb{A}^*\cdot a_j$$
%Now, in case, for any $j=1..m$, $\ttp_j\neq\HH$, we get that, by ($\ref{l:aa}$) and ($\ref{l:bb}$) above, 
%also $\restrict{s'}{1} \in RS(S_1)$ is an unspecified-reception configuration. Contradiction.\\
%Otherwise, for any $j$ such that $\ttp_j = \HH$ we have that  
%$\mid \vec{w}_{\ttp_j\ttr}\mid > 0 $
%and  $\vec{w}_{\ttp_j\ttr}\not\in \mathbb{A}^*\cdot a_j$ and, 
% by ($\ref{l:cc}$) above,  also that 
% $\mid \vec{w'}_{\ttp_j\ttr}\mid  =  \mid a\cdot\vec{w}_{\ttp_j\ttr} \mid > 0 $ and 
% $\vec{w'}_{\ttp_j\ttr} =  a\cdot\vec{w}_{\ttp_j\ttr} \not\in \mathbb{A}^*\cdot a_j$.
% So, by ($\ref{l:aa}$) and ($\ref{l:bb}$) above, 
%also $\restrict{s'}{1} \in RS(S_1)$ is an unspecified-reception configuration.
% Contradiction.

\end{description}


%In such a case, by definition of $\gateway{\cdot}$, 
%there exists necessarily a unique transition of the form $(q'_\HH,\ttp\HH?a,q_\HH)\in{\delta}_\HH$.
%Moreover, $q'_\HH\not\in \widehat{Q_\HH}$. So 
% there exists necessarily an element $s'\in RS(S)$ such that
%$s'=(\vec{q'},\vec{w'})\lts{\ttp\HH?a}s$ with $q'_\HH\not\in \widehat{Q_\HH}$. It follows that also $s'$ is 
%an unspecified-reception configuration and $\restrict{s'}{1} \in RS(S_1)$.
%Then we get a contradiction by arguing like in the first case, sub-case $\ttr \neq \HH$.
\end{description}
\end{proof}
 
 
 
 
 
 
 


\subsection{Progress preservation}

\begin{proposition}[Progress preservation]%\hfill\\
\label{lem:restrRS}
If $S_1$ and $S_2$ do enjoy the progress property, so does $S$. 
%Let $s= (\vec{q},\vec{w}) \in RS(S)$ be a deadlock configuration for $S$.
%Then, either $\restrict{s}{1}\in RS(S_1)$ is a deadlock configuration for $S_1$
%or $\restrict{s}{2}\in RS(S_2)$ is a deadlock configuration for $S_2$ (or both).
\end{proposition}

\begin{proof}
By contraposition, let us assume $S$ not to enjoy the progress property, namely that there exists 
 $s= (\vec{q},\vec{w}) \in RS(S)$ such that
 \begin{equation}
 \label{eq:snotprogr}
 \text{$s\notlts{}\hspace{2mm}$ and $\hspace{2mm}\vec{q}$ is not final.}
\end{equation}
%It is immediate to check that this can be equivalently rephrased as
%\begin{equation}
% \label{eq:snotprogrequiv}
%\text{$\vec{q}$ is not final and  $\exists\ttr\in\roles$ such that $\vec{q}_\ttr$ is a receiving state of $M_\ttr$}
%\end{equation}


By $s\notlts{}$  and by Fact \ref{fact:uniquesending}(\ref{fact:uniquesending-i}), we have that
neither $q_\HH\in\widehat{Q_\HH}$ nor $q_\KK\in\widehat{Q_\KK}$. Otherwise
there will be an output transition from either $q_\HH$ or  $q_\KK$, contradicting $s\notlts{}$.
Hence necessarily $q_\HH\not\in\widehat{Q_\HH}$ and $q_\KK\not\in\widehat{Q_\KK}$. 
So, by Lemma \ref{lem:nohatrestrict} we get $\restrict{s}{i}\in RS(S_i)$ for $i=1,2$.
We show in the following that either

\begin{equation}
 \label{eq:snotprogr1}
\text{$\restrict{\vec{s}}{1}\notlts{}\hspace{2mm}$ and $\hspace{2mm}\restrict{\vec{q}}{1}$ is not final;}
\end{equation}
or 
\begin{equation}
 \label{eq:snotprogr2}
\text{$\restrict{\vec{s}}{2}\notlts{}\hspace{2mm}$ and $\hspace{2mm}\restrict{\vec{q}}{2}$ is not final.}
\end{equation}

Once we have shown ( \ref{eq:snotprogr1}) or ( \ref{eq:snotprogr2}) either $S_1$ or $S_2$ does not enjoy the progress property and we are done.

%As pointed out previously, the two above properties can be equivalently rephrased, for $i=1,..2$, as 
%\begin{equation}
% \label{eq:snotprogrequivi}
%\text{$\restrict{\vec{q}}{i}$ is not final and  $\exists\ttr\in\roles_i$ such that $\vec{q}_\ttr$ is a receiving state of $M^i_\ttr$;}
%\end{equation}





%\noindent
%{\bf case (\ref{caseA})}.  
%Since $\vec{q}$ is final, then a fortiori $q_\HH$ and $q_\KK$ are final, and hence, by Lemma \ref{lem:wempty}, it follows that $w_{\HH\KK} = w_{\KK\HH} = \varepsilon$.
%This implies that, since  $\vec{w}\neq \vec{\varepsilon}$, there exist either $\ttp,\ttq\in \roles_1$ with  $w_{\ttp\ttq}\neq\varepsilon$
% or $\ttp',\ttq'\in \roles_2$ with  $w_{\ttp'\ttq'}\neq\varepsilon$. 
%Let us assume, without loss of generality, the first case to hold.
%Now, since we have that $\restrict{s}{1}\in RS(S_1)$ and $\restrict{s}{1}\notlts{}$ (because $\restrict{\vec{q}}{1}$ is final in $S_1$), we get that, by definition, $\restrict{s}{1}$ is a deadlock state of $S_1$.\\
% 
% \noindent
%{\bf case (\ref{caseB})}. 

\noindent
 We distinguish now the following possible cases according to whether $q_\HH$ and $q_\KK$ are final or not.
 \begin{description}
\item Both $q_\HH$ and $q_\KK$ are final in $M_\HH$ and $M_\KK$ and hence in $M^1_\HH$ and $M^2_\KK$: \\
Then from $s\notlts{}$ it immediately follows that $\restrict{s}{1}\notlts{}$ and $\restrict{s}{2}\notlts{}$. Moreover, since there exists $\ttr\in\roles$ such that $q_r$ is not final,
 we can infer that either there exists $\ttr\in\roles_1$
 such that $\ttr\neq\HH$ and $q_r$ is not final,
 or there exists $\ttr\in\roles_2$ such that $\ttr\neq\KK$ and $q_r$ is not final.
% a receiving state of $M^1_\ttr$.
% This means that either  $\restrict{s}{1}$  is a deadlock state of  $S_1$ or  $\restrict{s}{2}$  is a deadlock state of  $S_2$ (or both).
 \item Both $q_\HH$ and $q_\KK$ are non final: \\
In such a case, by definition of $\gateway{\cdot}$ and by the no mixed state condition on $M^1_\HH$ and $M^2_\KK$
imposed by compatibility,  we need  to 
take into account only the following  further possible subcases concerning the shapes of the transitions from  $q_\HH$  in $\delta_\HH$ and from  $q_\KK$ in $\delta_\KK$.

\underline{$\diamond$} 
{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$ and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts \in \roles_2$ (and hence $\tts\neq\HH$).}\\
Since all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts \in \roles_2$ (and hence $\tts\neq\HH$),
  we can infer, from the definition of  $\gateway{\cdot}$, that also  all the transitions from $q_\KK$ in $\delta^2_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$. Hence from $s\notlts{}$ we can  
obtain that $\restrict{s}{2}\notlts{}$ as well and then  (\ref{eq:snotprogr2}).
%that $\restrict{s}{2}$ is a deadlock state.
(Notice that, instead, $\restrict{s}{1}\lts{}$, since, by definition of $\gateway{\cdot}$, all the transitions from 
$q_\HH$ in $\delta^1_\HH$ are of the form $(q_\HH,\HH\_!\_,\_)$)\!
\footnote{This fact clearly prevents us from having the preservation of progress in the case where, instead of connecting roles of
different systems, we connect roles belonging to the same system. This ``self connection'' is equivalent to having multiple connections 
(see discussion in Section \ref{sec:mulconn}). }
.

\underline{$\diamond$} 
{\em All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\tts\HH?\_,\_)$ with $\tts \in \roles_1$ (and hence $\tts\neq\KK$). and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$.}\\
This case can be treated similarly to the previous one.


\underline{$\diamond$} 
{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\tts\HH?\_,\_)$ with $\tts\in\roles_1$ and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts\in\roles_2$.}\\
This case can be treated similarly to the previous ones.


\underline{$\diamond$}
{\em  All the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$. and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$.}\\
We now consider the possible shapes of $w_{\HH\KK}$ and $w_{\KK\HH}$.
\begin{description}
\item
 $w_{\HH\KK}=w_{\KK\HH}=\varepsilon$.\\
This subcase cannot occur. Towards a contradiction, let us assume it to be possible.\\
Let now $\xi$ be a transition sequence leading to $s\in RS(S)$ from the initial state, in particular let $\xi$ be\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n=s$
}
 By Lemma \ref{lem:inlangs},
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC $ and $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in\lang{M^2_\KK}^\mC$. Moreover, by Corollary \ref{lem:prefix}(\ref{lem:prefixcor-iii}),
  $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}=\symb{\KK\HH}{\restrictup{\xi}{\KK}}$.
  Since all the transitions from $q_\HH$ in $\delta_\HH$ are of the form $(q_\HH,\KK\HH?\_,\_)$. and
all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$,
we can infer, by definition of $\gateway{\cdot}$, that  $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot !a\in\lang{M^1_\HH}^\mC $ and $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !b\in\lang{M^2_\KK}^\mC$ for certain $a$ and $b$.

We have then that $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?b} = {\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !b} \in\lang{M^2_\KK}^\mC$
and hence, since by compatibility $\Dual{\lang{M^1_\HH}^\mC} = \lang{M^2_\KK}^\mC$, also that
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?b\in \lang{M^1_\HH}^\mC$.\\
 To have both $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot !a\in\lang{M^1_\HH}^\mC $ and 
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?b\in \lang{M^1_\HH}^\mC$
does contradict the no mixed state condition of compatibility since,
 by ?!-determinism of $M^1_\HH$, ${q}_\HH$ is the unique state of $M^1_\HH$ 
recognising the string $\symb{\HH\KK}{\restrictup{\xi}{\HH}}$. 

\item 
$w_{\HH\KK}\neq\varepsilon$.\\
This subcase cannot occur, otherwise, by Lemma \ref{lem:getright}, we would get $s\lts{}$.

\item 
$w_{\KK\HH}\neq\varepsilon$.\\
This subcase cannot occur, otherwise, by Lemma \ref{lem:getright}, we would get $s\lts{}$.
\end{description}


\item $q_\HH$ is final and $q_\KK$ is non final: \\
By the no mixed state condition imposed by compatibility, we need to take into account two further subcases.\\
\underline{$\diamond$} 
{\em  All the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$ with $\tts\neq\HH$}.\\
As done in a previous case,  we can infer, from the definition of  $\gateway{\cdot}$, that also  all the transitions from $q_\KK$ in $\delta^2_\KK$ are of the form $(q_\KK,\tts\KK?\_,\_)$. Hence from $s\notlts{}$ we can  
obtain that $\restrict{s}{2}\notlts{}$ as well, and then  (\ref{eq:snotprogr2}).\\
\underline{$\diamond$} 
{\em  All the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$}.\\
Since $\vec{q}_\HH$ is final, by Lemma \ref{lem:wempty}, $\vec{w}_{\KK\HH} = \varepsilon$. Thus, it remains to consider the following two subcases:
 \begin{description}
 \item
 ${w}_{\HH\KK}=\varepsilon$.\\
 This case cannot occur. Towards a contradiction, let us assume it to be possible.\\
Let $\xi$ be a transition sequence leading to $s\in RS(S)$ from the initial state, in particular let $\xi$ be\\
\centerline{
$s_0\lts{\elle_1}s_1\lts{\elle_2} \ldots \lts{\elle_{n-1}}s_{n-1}\lts{\elle_n}s_n=s$
}
 By Lemma \ref{lem:inlangs},
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in\lang{M^1_\HH}^\mC $ and $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\in\lang{M^2_\KK}^\mC$. \\
 Moreover, by Corollary \ref{lem:prefix}(\ref{lem:prefixcor-iii}),
  $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}}=\symb{\KK\HH}{\restrictup{\xi}{\KK}}$.
  Since all the transitions from $q_\KK$ in $\delta_\KK$ are of the form $(q_\KK,\HH\KK?\_,\_)$,
we can infer, by definition of $\gateway{\cdot}$, that  $\symb{\KK\HH}{\restrictup{\xi}{\KK}}\cdot !a\in\lang{M^2_\KK}^\mC$ for a certain $a$.

We have then that $\Dual{\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?a}\in\lang{M^2_\KK}^\mC$
and hence, since by compatibility $\Dual{\lang{M^1_\HH}^\mC} = \lang{M^2_\KK}^\mC$, also that
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?a\in \lang{M^1_\HH}^\mC$.\\
 To have both $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\cdot ?a\in\lang{M^1_\HH}^\mC $ and 
 $\symb{\HH\KK}{\restrictup{\xi}{\HH}}\in \lang{M^1_\HH}^\mC$
does contradict $q_\HH$ to be final, since,
 by ?!-determinism of $M^1_\HH$, ${q}_\HH$ is the unique state of $M^1_\HH$ 
recognising the string $\symb{\HH\KK}{\restrictup{\xi}{\HH}}$. 
 \item
 $w_{\HH\KK}\neq\varepsilon$.\\
Then, by Lemma \ref{lem:getright}, we get $s \lts{}$. Contradiction to the assumption of no progress in $s$.
\end{description}


\item $q_\KK$ is final and $q_\HH$ is non final: \\
The same argument of the previous case does apply.
\end{description}
\end{proof}

\begin{corollary}[Preservation of strong deadlock-freeness]%\hfill\\
\label{prop:dfPreservation}
Let $S_1$ and $S_2$ be strongly deadlock-free.
Then $S = {S_{1}} \connect{\HH}{\KK} {S_{2}}$ is strongly deadlock-free.
\end{corollary}
\begin{proof}
By Proposition \ref{prop:freeprogorph}(\ref{prop:freeprogorph-ii}),  Corollary \ref{prop:nomPreservation} and Proposition \ref{lem:restrRS}.
\end{proof}

%\bigskip
%Notice that our previous results do not guarantee preservation of  deadlock freeness.
%Assume we had two systems $S_1$ and $S_2$ which are both  deadlock-free in the sense of 
%Definition \ref{def:safeness}(\ref{def:safeness-i})
%but at least one of them is not strongly deadlock free (= no orphan + progress).
%Then our current results would not help to say anything about the composed system.
%In the following subsection we hence provide such a preservation proof











