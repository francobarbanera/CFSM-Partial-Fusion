

\section{Composition via partial gateways}

Running example

Let us consider the two following systems $S_1$ and $S_2$ with interfaces, respectively,
$\hh_1$ and $\hh_2$.
\begin{equation}
\label{eq:runex}
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

$S_1$ and $S_2$ are both deadlock free and both enjoy the progress property.

Transforming $\hh_1$ and $\hh_2$ into gateways make the resulting composition non
deadlock free.
In fact, the (unique) connection policy is as below, and it is non deadlock free.

$$
\dbox{
     \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\hh_1\hh_2!\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
       \qquad
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_1\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\hh_1!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
}
$$

Instead of looking at a whole participant as an interface, we can 
consider only specific edges as description of actions of an outer system.
In our running example, for instance, we could still decide to compose $S_1$ and $S_2$ trough
$\hh_1$ and $\hh_2$, proviso that only the edges in bold in the drawing below
have to be interpreted as actions of the outer systems one intend to be connected to.  


\begin{equation}
\label{eq:1}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left, line width=0.5mm]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge     [line width=0.5mm]                     node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right, line width=0.5mm]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

The connection policy has now to be formed by CFSM describing the interactions 
between the ``interface'' parts of $\hh_1$ and $\hh_2$, which in our running examples 
turn out to be simply as follows.

\begin{equation}
\label{eq:cp1}
\dbox{
     \begin{tikzpicture}[mycfsm]
   \node[state]            (1) [above of=0] {$1$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 1]{$\hh_1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (1)
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
       \qquad
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_1\hh_2?\msg[mus]$} (3)
                   ;
       \end{tikzpicture}
}
\end{equation}

Such a communicating system does enjoy all communication properties we considered.

The partial gateways have to act as forwarders only for what concerns the interface parts,
whereas non interface parts describe what is still in charge of the participants $\hh_1$ and $\hh_2$.

So, the resulting composed system is as follows.

$$
\begin{array}{cc@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (1hat) [above left of=1, yshift=-4mm,xshift=2mm] {$\widehat 1$};
   \node[state]            (2) [above of=1hat, yshift=-2mm] {$2$};
   \node[state]            (2hat) [above right of=1, yshift=-4mm,xshift=-2mm] {$\widehat 2$};
   \node[state]            (3) [above of=2hat, yshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (1hat)
             (1hat)  edge   node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (2hat) 
             (2hat)  edge   node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
  &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1hat) [above right of=0] {$\widehat 1$};
    \node[state]            (1) [right of=1hat] {$1$};
   \node[state]           (2hat) [right of=0,xshift=-6mm] {$\widehat 2$};
    \node[state]           (2) [right of=2hat] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1hat)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2hat)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (1hat)  edge                      node [above]  {$\hh_2\tts!\msg[sbs]$} (1)
            (2hat)  edge                      node [above]  {$\hh_2\tts!\msg[hum]$} (2)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
$$

Our result will allow to infer that in this particular case the composition via partial gateways
satisfies also the communication properties (but lock-freedom).

Some care has however to be taken when, onece choosen the participants playing the roles of 
partial interfaces,  we decide which are the interface edge.
It is in fact not possible to consider any edge as an interface edge.

Let us consider again our running example, and let us consider again $\hh_1$ and 
$\hh_2$ as (partial) interfaces. However, let us consider now the following interface edges.



%We hence introduce the notion of CFSM with interface edges. 

 \begin{equation}
 \label{eq:2}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left, line width=0.5mm]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge     [line width=0.5mm]                     node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

The corresponding connection policy is 

$$
\dbox{
     \begin{tikzpicture}[mycfsm]
   \node[state]            (1) [above of=0] {$1$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 1]{$\hh_1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (1)
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
       \qquad
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0, xshift=1mm] {$1$};
   \node[state]           (2) [right of=0, xshift=-4.5mm] {$2$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [below]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   ;
       \end{tikzpicture}
}
$$
This communicating system is orphan-message free.

 The composition obtaining by building partial gateways of such connection policy is then the 
 following communication system.

\begin{equation}
\label{eq:comprunex}
\begin{array}{cc@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (1hat) [above left of=1, yshift=-4mm,xshift=2mm] {$\widehat 1$};
   \node[state]            (2) [above of=1hat, yshift=-2mm] {$2$};
   \node[state]            (2hat) [above right of=1, yshift=-4mm,xshift=-2mm] {$\widehat 2$};
   \node[state]            (3) [above of=2hat, yshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (1hat)
             (1hat)  edge   node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (2hat) 
             (2hat)  edge   node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
  &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1hat) [above right of=0] {$\widehat 1$};
    \node[state]            (1) [right of=1hat] {$1$};
   \node[state]           (2hat) [right of=0,xshift=-6mm] {$\widehat 2$};
    \node[state]           (2) [right of=2hat] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1hat)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2hat)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (1hat)  edge                      node [above]  {$\hh_2\tts!\msg[sbs]$} (1)
            (2hat)  edge                      node [above]  {$\hh_2\tts!\msg[hum]$} (2)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

Scuh communicating system, however, is not orphan-message free.
In fact the following configuration, made by final states only, is reachable:\\
\centerline{
$s=((3_\ttr,3_{\hh_1},3_{\hh_2},3_\tts),\vec{w})$
}
where $\vec{w}\neq\vec{\varepsilon}$, in particular $w_{\hh_1\hh_2}=\langle\msg[hum]\rangle$.\\
Hence $s$ is an orphan-message configuration.

A similar choice of interface edges can disrupt progress preservation.
 
Let us consider the two following systems $S_1$ and $S_2$ with interfaces, respectively,
$\hh_1$ and $\hh_2$. Both satisfying the progress property.
\begin{equation}
\label{eq:3}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge [line width=0.5mm]     node [below] {$\hh_1\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right, line width=0.5mm]            node [above]  {$\ttv\hh_2?\msg[a]$} (2);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
\end{equation}

The (unique) connection policy below satisfies the progress property.
 
$$
\dbox{
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
%
   \path  (start) edge node {} (0) 
            (0)  edge [line width=0.5mm]     node [below] {$\hh_2\hh_1?\msg[a]$} (1);
       \end{tikzpicture}
\quad
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0)
            (0)   edge    [bend right, line width=0.5mm]            node [above]  {$\hh_2\hh_1!\msg[a]$} (2);
       \end{tikzpicture}
       }
$$

The following composition via partial gateway, however, does not satisfies the progress property.
$$
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
\quad
        \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (0hat) [right of=0] {$\widehat 0$};
  \node[state]           (1) [above of=0hat] {$1$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     node [below] {$\hh_2\hh_1?\msg[a]$} (0hat)
            (0hat)  edge     node [below] {$\hh_1\ttu!\msg[a]$} (1)
            ;
       \end{tikzpicture}
\quad
            \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH_2$};
  \node[state]            (2) [right of=hat0] {$2$};
  \node[state]           (1) [above right of=0, yshift=-5mm] {$1$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)         edge   [bend right]        node [below] {${\ttv\hh_2}?{\msg[a]}$} (hat0)
                         edge   [bend left]      node [above]  {${\ttv\hh_2}?{\msg[b]}$} (1)
             (hat0)  edge        node [below] {${\HH_2\hh_1}!{\msg[a]}$} (2);       
             \end{tikzpicture}
\quad
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
$$
In fact, some states in $s=(0_\ttu,0_{\hh_1},1_{\hh_2},1_\ttv)$ are not final, $s$ is reachable and $s\notlts{}$. 

The previous two examples, where some properties are not preserved by composition via
partial gateways, share the fact that interfaces have a state with normal and interface outgoing
transitions.
  
The following example shows that progress preservation can be disrupted also in presence of
states all with non interface transitions.

Let us consider the following communicating system.
\begin{equation}
\label{eq:4}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge  [line width=0.5mm]     node [below] {$\hh_1\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (3) [right of=2] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh_2?\msg[c]$} (2)
            (2)   edge    [line width=0.5mm]            node [above]  {$\ttv\hh_2?\msg[a]$} (3);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
\end{equation}
The (unique) connection policy satisfies progress.
The composition below, however, does not.
$$
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
\quad
        \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (0hat) [right of=0] {$\widehat 0$};
  \node[state]           (1) [above of=0hat] {$1$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     node [below] {$\hh_2\hh_1?\msg[a]$} (0hat)
            (0hat)  edge     node [below] {$\hh_1\ttu!\msg[a]$} (1)
            ;
       \end{tikzpicture}
\quad
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (2hat) [right of=2] {$\hat{2}$};
  \node[state]           (3) [right of=2hat] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv_2\hh?\msg[c]$} (2)
            (2)   edge           node [above]  {$\ttv\hh_2?\msg[a]$} (2hat)
            (2hat)   edge      node [above]  {$\hh_2\ttu!\msg[a]$} (3)
            ;
       \end{tikzpicture}
\quad
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
$$
In fact, some states in $s=(0_\ttu,0_{\hh_1},1_{\hh_2},1_\ttv)$ are not final, $s$ is reachable and $s\notlts{}$. 


The main problem is that a choice should depend on a single participant.
In one of the previous examples, problems arise when a choice involves both
$\hh_1$ and $\hh_2$.
Problems also arise when a choice made by an interface is in conflict with what the other 
interface does. 

We hence restrict outgoing interface transitions always to be single. (Claim: non necessary for deadlock-freedom).
This restriction is formalised in the following definition, where $\intf$ is intended to identify
interface transitions, whereas $\nintf$ the non interface transitions.

\begin{definition}[CFSM with interface transitions]\label{def:cfsmie}
\label{def:cfsmintftrans}
A {\em CFSM with interface transitions} ($CFSM^{\mathsf{it}}$ for short) is a tuple $M=(Q,q_0,\mathbb{A},\bm{\delta})$ 
where $Q$, $q_0$ and $\mathbb{A}$ are as in the definition of CFSM, whereas\\
\centerline{
$\bm{\delta} \subseteq Q\times\textit{Act}_{\roles,\mathbb{A}}\times Q \times \Set{\intf,\nintf}$}
\begin{tabular}{lc@{\hspace{4pt}}l}
and such that & - & $(q_1,\elle,q_2,x),(q_1,\elle,q_2,y)\in\bm{\delta} \implies x=y$.\\
                     & - & $(q_1,\elle,q_2,\nintf), (q_1,\elle',q'_2,z)\in\bm{\delta} \implies (\elle=\elle' \text{ and } q_2=q'_2)$\\
                     &    & \hspace{51mm}  (and hence $z=\nintf$ by the previous item).
\end{tabular}\\
An element of $\bm{\delta}$ with the form $(\_,\_,\_,\intf)$ is called {\em interface edge}.
\end{definition}
It is possible to check that $\hh_2$ in (\ref{eq:1}) above is a CFSM with interface transitions,
whereas participants $\hh_2$ in (\ref{eq:2}), (\ref{eq:3}) and (\ref{eq:4}) are not.

%The conditions on CFSMs with interface edges prevent the problems shown in \cref{ex:singleeps}.

It is worth noticing that the usual PaI composition via gateway is a particular case 
of composition via partial gateways where all transitions are interface transitions.
Absence of non interface transition makes conditions in \cref{def:cfsmintftrans}
vacuously satisfied.

As done in the previous examples, we use the notation $q\lts{l}q'$ for $(q,l,q',\nintf)$ and
 $q
 \raisebox{2.7mm}
{\begin{tikzpicture}[mycfsm]
      % 
      \node[state, draw=none] (zero) [yshift=-4mm, xshift=5mm] {$~$};
      \node[state, draw=none] (one) [right of=zero, xshift=-10mm]   {$~$};
      % 
      \draw (zero) edge[-to,line width=0.5mm] node[above]{$l$} (one)
      ;
 \end{tikzpicture}
 } 
\!\! q'$ for $(q,l,q',\intf)$.

Composition via partial gateways consists, first of all, in identifying two interface participants
and then properly choosing some transitions in order to get a CFSM with
interface transitions. Given a CFSM $M$, an interface decoration is one of the possible
CFSM with interface transition that we can get out of $M$. 


\begin{definition}[Interface decorations]\label{def:IDM}
Let $M=(Q,q_0,\textit{Act},\delta)$ be a CFSM. We define the {\em interface decorations set} of $M$
as the following set of CFSMs with interface transitions:
$$\IDS(M) = \Set{(Q,q_0,\textit{Act},\bm{\delta}) \mid (Q,q_0,\textit{Act},\bm{\delta}) \text{ is a CFSM$^\mathsf{it}$ with } \proj{\bm{\delta'}}{Q\times\textit{Act}\times Q} =\delta}$$
\end{definition}

Given a CFSM with interface transitions, say $\hh_2$ in (\ref{eq:1}), these transitions identifies the behaviour of the external system intended for the composition.
Such a behaviour should be the one described in terms of a particular CFSM, like
\begin{equation}
\label{eq:epsrunex}
\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\varepsilon$} (4)
                   ;
       \end{tikzpicture}
\end{equation}

In this simple case such a behaviour does correspond to the proper CFSM

$$
\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   %\node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            %(2)  edge                           node [above]  {$\varepsilon$} (4)
                   ;
       \end{tikzpicture}
$$

Since (\ref{eq:epsrunex}) above
has been obtained out of a CFSM with interface transitions -- where, by definition, outgoing
transitions are single whenever they are non-interface --   




which, in turn is used to identify one of the CFSMs of the connection policy (uniquely identified
for the binary case), in particular the $\hh_2$ in the connection policy (\ref{eq:cp1})
for our running example.

By extending the usual notion of gateway (*reference*) the interface participant $\hh_2$ in
$S_2$ of our running example (\ref{eq:runex}) and the $\hh_2$ above  
are the argument to buil the partial gateway intended to be substituted for $\hh_2$ in the composition.
Namely $\hh_2$ in (\ref{eq:comprunex}).
The construction of partial gateways is formally defined as follows.

  


for  our example.\\
The above is  a CFSM extended with $\varepsilon$ actions, an $\varepsilon$-FSA.    

%\begin{definition}[$\I(M)$]\label{def:IM}%\hfill\\
%Let $M=(Q,q_0,\textit{Act},\bm{\delta})$ be a CFSM with interface edges
%and let $M'=(Q',q'_0,\textit{Act},\delta')$ be a standard CFSM. We say that
%$M'$ is an {\em interface for $M$ via $(f,g)$}, $\I^M_{\!\!(f,g)}(M')$, whenever
%\begin{itemize}
%\item[-]
%$f:Q\to Q'$  is onto and such that, for all $q\in Q$, $\langin(q)=\langin(f(q))$;
%\item[-]
%$g:\delta'\to\Set{e\in\delta\mid e \text{ is an interface edge}}$ is such that 
%$\I(M)$ as the CFSM obtained out of $\bm{\varepsilon}(M)$ using the standard procedure
%to get a FSA without $\varepsilon$-transitions out of a $\varepsilon$-FSA \cite[someStandardReference]. 
%Roughly:\\ 
%- one first calculate the $\varepsilon$-closure for each state, which is the set of all states reachable from a given state using only $\varepsilon$-transitions;\\ 
%- then, for each element of $\textit{Act}$, define new transitions for each state by considering the $\varepsilon$-closures of the states reachable via the original transition function.
%\end{itemize}
%\end{definition}

\begin{definition}[$\roles$-duality]\label{def:PD}%\hfill\\
\begin{enumerate}[i)]
\item
Let $M=(Q,q_0,\textit{Act},\bm{\delta})$ be a CFSM with interface edges. We define
$\varepsilon(M)$ as  the $\varepsilon$-FSA $(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta')$   where\\
\centerline{
$\delta' = \Set{(q,l,q') \mid (q,\varepsilon,q',\nintf) \in \bm{\delta}}\cup \Set{(q,\varepsilon,q') \mid (q,\elle,q',\intf) \in \bm{\delta}}$  }
\item
Let $l,l'\in\textit{Act}\cup\Set{\varepsilon}$ and  let $\roles\neq\emptyset$ be a set of participants.
We say that $l'$ is {\em a $\roles$-dual of $l$} whenever 
\begin{itemize}
\item[-]
$l = \ttr\ttq?\msg[m] \implies l'= \ttq\tts!\msg[m] \text{ with } \tts\in\roles$, $\tts\neq\ttq$;
\item[-]
$l = \ttq\ttr!\msg[m] \implies l'= \tts\ttq?\msg[m] \text{ with } \tts\in\roles$, $\tts\neq\ttq$.
\end{itemize}
\item
Let $\delta,\delta'\in Q\times\textit{Act}\cup\Set{\varepsilon}\times Q$ and  let $\roles$ be a set of participants.
We say that $\delta'$ is {\em a $\roles$-dual of $\delta$} whenever is a minimal relation over
 $Q\times\textit{Act}\cup\Set{\varepsilon}\times Q$ such that\\
\centerline{
$q\lts{l}q'\in\delta \implies q\lts{l'}q'\in\delta'$, where $l'$ is a $\roles$-dual of $l$.
}
\item
Let $M=(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta)$ and $M'=(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta')$ be two $\varepsilon$-FSA and  let $\roles$ be a set of participants.
We say that $M''$ is {\em a $\roles$-dual of $M$} whenever $\delta'$ is a $\roles$-dual of $\delta$.
\end{enumerate}
\end{definition}

\begin{definition}
\label{def:noepsver}
%\begin{enumerate}
%\item
%We define the set of the {\em duals of $\delta'$ with respect to} $\roles$  as the following set of $\epsilon$-FSA
%$$\bm{\delta}\text{-}\duals_{\,\roles}(M) = 
%\Set{(Q,q_0,\textit{Act}\cup\Set{\epsilon},\delta'') \mid q\lts{l'}q'\in\delta'' \text{ if } }$$
%where $\bm{\varepsilon}(M) = (Q,q_0,\textit{Act}\cup\Set{\epsilon},\delta')$.
%\item
Let $M=(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta)$ be a $\varepsilon$-FSA
and $M'=(Q',q'_0,\textit{Act},\delta)$ be a CFSM.
We say that $M'$ is a {\em $\noeps$-version of $M$ via $f$} ($\noeps_f$-version of $M$ for short)
whenever 
\begin{enumerate}[a)]
\item
$M'$ is deterministic;
\item 
$f:Q\to Q'$ is onto and such that $f(p_0) = f(p'_0)$;
\item
$p_1\lts{\epsilon}p_2 \quad\text{implies}\quad f(p_1)=f(p_2)$; 
\item
$p_1\LTS{\elle}p_2 \quad\text{implies}\quad f(p_1)\lts{\elle}f(p_2)$; 
\item
\label{def:noepsver-e}
$ f(p_1)\lts{\elle}f(p_2)\quad\text{implies}\quad p_1\LTS{\elle}p_2$.
\end{enumerate}
(((i.e. $f$ is a weak bisimulation?)))

\begin{remark}
\label{rem:neccond}
{\em
Notice that without the condition\\
\centerline{
$(q_1,\elle,q_2,\nintf), (q_1,\elle',q'_2,z)\in\bm{\delta} \implies (\elle=\elle' \text{ and } q_2=q'_2)$}
in \cref{def:cfsmie}, the conditions involving $f$ in the above definition \cref{def:noepsver} would not be satisfiable. \finex
}
\end{remark}

$
     \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\varepsilon$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
$
is ``equivalent'' to 
$
     \begin{tikzpicture}[mycfsm]
   \node[state]            (1) [above of=0] {$1$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 1]{$\hh_1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (1)
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
$

whereas

$ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\varepsilon$} (4)
                   ;
       \end{tikzpicture}
$
is ``equivalent'' to
$
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_1\hh_2?\msg[mus]$} (3)
                   ;
       \end{tikzpicture}
$


%We define $\noeps(M)$ as the CFSM obtained out of $M$ 
%using the following version of the standard procedure to get a FSA without $\varepsilon$-transitions
%out of a $\varepsilon$-FSA \cite{sipser96}, where final states are not taken into account and
%the set of states of $\I(M)$ and $\noeps(M)$ stay the same . 
%Roughly:\\ 
%- Add an arc from p to q labeled a iff there is an arc labeled a in N from some state in eps-CLOSE(p) to q.;\\
%- Delete all arcs labeled with epsilon.
%%- one first calculate the $\varepsilon$-closure for each state, which is the set of all states reachable from a given state using only $\varepsilon$-transitions;\\ 
%%- then, for each element of $\textit{Act}$, define new transitions for each state by considering the $\varepsilon$-closures of the states reachable via the original transition function.
%\end{enumerate}
\end{definition}
%Notice that the states of $\I(M)$ and $M$ are the same.



\begin{definition}[$\roles$-complementarity]
\label{def:Pcomplementarity}
Let $M^1_\hh = (Q, q_0, \textit{Act}, \delta^1)$ and 
$M^2_\hh = (Q, q_0, \textit{Act}, \delta^2)$  
be two CFSMs with the same name $\hh$, and let $\roles$ be a set of participants.
Moreover, let $\bm{\delta} \subseteq Q\times\textit{Act}\times Q \times \Set{\intf,\nintf}$
We say that
$M^1_\hh$ is {\em $\roles$-complementary} with $M^2_\hh$ via $\bm{\delta}$ and $f$, written $\emb{f}{\roles}{\bm{\delta}}{M^1_\hh}{M^2_\hh}$, whenever 
$$M^1_\hh \text{ is a $\noeps_{\!f}$-version of } M''_\hh$$
where $M''_\hh$ is a $\roles$-dual of $\varepsilon(M'_\hh)$ where $M'_\hh= (Q, q_0, \textit{Act}, \bm{\delta})\in\IDS(M^2_\hh)$.\\
We call $\varepsilon(M'_\hh)$ {\em the $\epsilon$-counterpart of $M^1_\hh$}
\end{definition}

By definition of CFSM with interface edges it follows that $\varepsilon(M'_\hh)$ in the above definition
does not contain any $\varepsilon$-clique. [*make a lemma*].

We write simply $\emb{}{\bm{}}{M^1_\hh}{M^2_\hh}$ whenever
$\roles$, $\bm\delta$ and $f$ are clear from the context or ininfluent.




\section{Partial-fusion Composition}

%We make distinct two equal labels when they are used in different transitions. 
%\begin{definition}[$M^+$]
%Let $M = (Q, q_0, \textit{Act}, \delta)$. We define
%$$M^+ = (Q, q_0, \textit{Act}', \delta')$$
%where $\textit{Act}'= \Set{\ttr\tts!\msg[m]^{(q,l,q')},\ttr\tts?\msg[m]^{(q,l,q')} \mid (q,l,q')\in Q\times\textit{Act}\times Q,\ttr,\tts\in\roles, \msg[m] \text{ a message}}$\\
% and 
%$\delta'= \Set{q\lts{\ttr\tts!\msg[m]^{(q,\ttr\tts!\msg[m],q')}}q' \mid q\lts{\ttr\tts!\msg[m]}q'\in\delta}$.
%\end{definition}


%\begin{definition}[$\bm{\delta}$-complementarity]
%Let $M^1_\hh = (Q, q_0, \textit{Act}, \delta^1)$ and $M^2_\hh = (Q, q_0, \textit{Act}, \delta^2)$  be two CFSMs with the same name $\hh$.
%We say that
%\begin{enumerate}[i)]
%\item
%$M^1_\hh$ is {\em $\bm{\delta^2}$-complementary} with $M^2_\hh$, written $\emb{\bm{\delta^2}}{}{M^1_\hh}{M^2_\hh}$, whenever 
%\begin{itemize}
%\item[-] 
%there exists $M'_\hh = (Q, q_0, \textit{Act}, \bm{\delta^2})\in\IDS(M^2_\hh)$;
%\item[-]
%$\I(\bm{\varepsilon}(M'_\hh)^+) = (Q, q_0, \textit{Act}, \delta')$;
%\item[-]
%$q_1 \lts{\hh\ttp!\msg[m]} q_2 \in \delta^1$ for some $\ttp$ \quad iff \quad 
%$q_1\lts{\ttp'\hh?\msg[m]^{(q,l,q')}}q_2\in \delta'$ for some $\ttp'$;
%\item[-]
%$q_1 \lts{\ttp\hh?\msg[m]} q_2 \in \delta^1$ for some $\ttp$ \quad iff \quad 
%$q_1\lts{\hh\ttp'!\msg[m]^{(q,l,q')}}q_2\in \delta'$  for some $\ttp'$;
%
%
%\item[-]
%$q_1\lts{\ttp\hh?\msg[m]^{(q,l,q')}}q_2,q'_1\lts{\ttp\hh?\msg[m]^{(q,l,q')}}q'_2\in \delta'$
%implies
%$q_1 \lts{\hh\ttp'!\msg[m]} q_2, q'_1 \lts{\hh\ttp'!\msg[m]} q'_2 \in \delta^1$;
%\item[-]
%$q_1\lts{\hh\ttp!\msg[m]^{(q,l,q')}}q_2,q'_1\lts{\hh\ttp!\msg[m]^{(q,l,q')}}q'_2\in \delta'$
%implies
%$q_1 \lts{\ttp'\hh?\msg[m]} q_2, q'_1 \lts{\ttp'\hh?\msg[m]} q'_2 \in \delta^1$.
%\end{itemize}
%\end{enumerate}
%\end{definition}
%The fifth and sixth items guarantees that if two labels in $\I(\bm{\varepsilon}(M'_\hh)^+))$ comes
%from the very same transition in $\bm{\varepsilon}(M'_\hh)$ then in $M^1_\hh$ they must
%send(receive) to(from) the same participant.

\begin{definition}[Partial Fusion]
\label{def:parfus}
Let $M^1_\hh = (Q^1, q^1_0, \textit{Act}, \delta^1)$ and $M^2_\hh = (Q^2, q^2_0, \textit{Act}, \delta^2)$  be two CFSMs with the same name $\hh$ such that 
$\emb{f}{\bm{\delta}}{\roles\setminus\Set{\hh}}{M^1_{\hh}}{M^2_\hh}$.
We define the {\em partial fusion of $M^1_{\hh}$ and $M^2_{\hh}$ via $\bm{\delta}$ and $\roles$} as
$$\fusion_{\!\!\bm{\delta}}^{\roles}(M^1_{\hh},M^2_{\hh}) = (Q^2\cup\widehat{Q},q_0,\textit{Act},\widehat{\delta})$$
\begin{tabular}{l@{\hspace{1mm}}c@{\hspace{2mm}}l}
where &  $\bullet$  & $\widehat{Q} =\Set{q^{(q, l,q')} \mid (q, l,q',\intf)\in\bm{\delta}}$; \\[1mm]
          &  $\bullet$  & $\widehat\delta = \Set{(q, l,q') \mid (q, l,q',\nintf)\in\bm{\delta}}\,\cup$\\ 
           &    & ${\hspace{20pt}}\Set{(q,\ttr\HH?\msg[a],\widehat q), (\widehat q,\HH\tts!\msg[a],q') \mid  (q,\HH\tts!\msg[a],q',\intf)\in\bm{\delta}, (q,\ttr\hh?\msg[a],\ q')\in\delta^1,\ \widehat q=q^{(q,\HH\tts!\msg[a],q')}}\, \cup$ \\
                &    & ${\hspace{20pt}}\Set{(q,\tts\HH?\msg[a],\widehat q), (\widehat q,\HH'\ttr!\msg[a],q') \mid  (q,\tts\HH?\msg[a],q',\intf)\in\bm{\delta},\ (q,\hh\ttr!\msg[a],q')\in\delta^1,\ \widehat q=q^{(q,\tts\HH?\msg[a],q')}}.$
 \end{tabular} 
\end{definition}



\begin{definition}[Composition by Partial Fusion]
\label{def:cpf}
Let $S_1=(M^1_\ttx)_{\ttx\in\roles_1}$ and $S_2=(M^2_\ttx)_{\ttx\in\roles_2}$ be two communicating systems such that $\roles_1\cap\roles_2=\Set{\hh}$
and $\emb{f}{\bm{\delta}}{\roles_1}{M^1_{\hh}}{M^2_{\hh}}$.
We define the {\em composition of $S_1$ and $S_2$ via partial fusion of $\hh$} by
$$\fusioncomp_{\!\hh}(S_1,S_2) = (\widetilde{M}_\ttx)_{\ttx\in\roles_1\cup\roles_2}$$ 
\begin{tabular}{lc@{\hspace{2mm}}l@{\hspace{4mm}}l}
where &  $\bullet$  & $\widetilde M_\ttx = M^1_\ttx$  & $\text{if}\quad \ttx\in\roles_1 $; \\[1mm]
          &   $\bullet$  & $\widetilde M_\ttx = M^2_\ttx$ &  $\text{if}\quad \ttx\in\roles_2 $; \\[1mm]
                    &   $\bullet$  & $\widetilde M_{\hh} =\fusion_{\!\!\bm{\delta}}^{{\roles_1\setminus\Set{\hh}}}(M^1_{\hh},M^2_{\hh})$.
 \end{tabular} 
 We call $\widetilde M_{\hh}$ the {\em connector} of $S_1$ and $S_2$ in the composition.
\end{definition}














