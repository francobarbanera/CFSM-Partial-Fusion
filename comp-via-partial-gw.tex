

\section{PaI composition via partial gateways}

In this section we formally describe the PaI composition via partial gateways.
We do that just for the binary case for the sake of simplicity. 
The definitions we provide scale up without much difficulties to PaI multicomposition 
and PaI orchestrated multicomposition. 

We use the following running example to introduce and discuss the main issues of 
binary PaI composition via partial gateways.

Let us consider the two following systems $S_1$ and $S_2$ with interfaces, respectively,
$\hh_1$ and $\hh_2$.
\begin{equation}
\label{eq:runex}
\begin{array}{c@{\qquad\qquad}c@{\hspace{1cm}}c@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

$S_1$ and $S_2$ are both deadlock free and both enjoy the progress property.

Transforming $\hh_1$ and $\hh_2$ into gateways, according to the standard
PaI composition via gateways, makes the resulting composition non
deadlock free.
In fact, the (unique) connection policy is as below, and it is non deadlock-free.

$$
\dbox{
     \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\hh_1\hh_2!\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
       \qquad
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_1\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\hh_1!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
}
$$

We notice, however, that instead of looking at a whole participant as an interface, we can 
consider only specific edges as description of actions of an outer system.
In the present example, for instance, we could still decide to compose $S_1$ and $S_2$ trough
$\hh_1$ and $\hh_2$, proviso that only the edges in bold in the drawing below
have to be interpreted as actions of the outer systems one intends to be connected to.  


\begin{equation}
\label{eq:1}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left, line width=0.5mm]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge     [line width=0.5mm]                     node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right, line width=0.5mm]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

The connection policy has now to be formed by CFSMs describing just the interactions 
between the ``interface'' parts of $\hh_1$ and $\hh_2$, which in our running examples 
turn out to be simply as follows.

\begin{equation}
\label{eq:cp1}
\dbox{
     \begin{tikzpicture}[mycfsm]
   \node[state]            (1) [above of=0] {$1$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 1]{$\hh_1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (1)
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
       \qquad
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_1\hh_2?\msg[mus]$} (3)
                   ;
       \end{tikzpicture}
}
\end{equation}

Such a communicating system does enjoy all communication properties we considered.

The partial gateways enabling the composition have now to act as forwarders only for what concerns the interface parts,
whereas non interface parts keep on describing what is still in charge of the participants $\hh_1$ and $\hh_2$.
Each partial gateway is hence built (similarly to the standard composition via gateways) out of 
the CFSM identified as interface and of  its counterpart in the
communication policy we intend to use for the composition. 
 \vspace{-1mm} In particular, out of the interface transition
\raisebox{2mm}
{\begin{tikzpicture}[mycfsm]
      % 
      \node[state] (zero) [yshift=-4mm] {$0$};
      \node[state] (one) [right of=zero, xshift=-2mm]   {$1$};
      % 
      \path
      (zero) edge[bend left=15, line width=0.5mm] node[above] {$\aout[h_2][s][][sbs]$} (one)
      ;
 \end{tikzpicture}
 } 
 of $\hh_2$ in (\ref{eq:1}) and of the transition
 \raisebox{2mm}
{\begin{tikzpicture}[mycfsm]
      % 
      \node[state] (zero) [yshift=-4mm] {$0$};
      \node[state] (one) [right of=zero, xshift=-2mm]   {$1$};
      % 
      \path
      (zero) edge[bend left=15] node[above] {$\ain[\hh_2][\hh_2][][sbs]$} (one)
      ;
 \end{tikzpicture}
 }  
 of $\hh_2$ in the connection policy (\ref{eq:cp1}) , we introduce 
  \raisebox{2mm}
{\begin{tikzpicture}[mycfsm]
      % 
      \node[state] (zero) [yshift=-4mm] {$0$};
      \node[state] (one) [right of=zero, xshift=-2mm, yshift=2mm]   {$\widehat 1$};
       \node[state] (two) [right of=one, xshift=-2mm, yshift=-2mm,]   {$1$};
      % 
      \path
      (zero) edge[bend left=10] node[above] {$\ain[h_1][h_2][][sbs]$} (one)
      (one) edge[bend left=10] node[above] {$\aout[\hh_2][s][][sbs]$} (two)
      ;
 \end{tikzpicture}
 }
in the resulting partial gateway, where $\widehat 1$ is specifically introduced 
by the partial gateway construction.
Recall that, in order to enforce conservativity, gateways are given the same names as the
corresponding interfaces.
The above discussion applies, dually, for edges in the interface $\hh_1$ labelled with output actions.
Non interface transitions are instead left unchanged by the partial gateway construction.



So, the resulting composed system is as follows.

$$
\begin{array}{cc@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (1hat) [above left of=1, yshift=-4mm,xshift=2mm] {$\widehat 1$};
   \node[state]            (2) [above of=1hat, yshift=-2mm] {$2$};
   \node[state]            (2hat) [above right of=1, yshift=-4mm,xshift=-2mm] {$\widehat 2$};
   \node[state]            (3) [above of=2hat, yshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (1hat)
             (1hat)  edge   node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (2hat) 
             (2hat)  edge   node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
  &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1hat) [above right of=0] {$\widehat 1$};
    \node[state]            (1) [right of=1hat] {$1$};
   \node[state]           (2hat) [right of=0,xshift=-6mm] {$\widehat 2$};
    \node[state]           (2) [right of=2hat] {$2$};
   \node[state]           (3hat) [below right of=0] {$\widehat 3$};
   \node[state]           (3) [ right of=3hat] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1hat)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2hat)
                   edge    [bend right]     node [below]  {$\hh_1\hh_2?\msg[mus]$} (3hat)
            (3hat)  edge                      node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (1hat)  edge                      node [above]  {$\hh_2\tts!\msg[sbs]$} (1)
            (2hat)  edge                      node [above]  {$\hh_2\tts!\msg[hum]$} (2)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
$$

Our result will allow to infer that the above composition via partial gateways
satisfies also the communication properties (but lock-freedom).

Some care has however to be taken when, once choosen the participants playing the roles of 
interfaces,  we decide which of their transitions we wish to consider as interface transitions.
It is in fact not possible to consider any transition as an interface transition.

Let us consider again our running example, and let us consider again $\hh_1$ and 
$\hh_2$ as interfaces. However, let us consider now the following interface transitions.



%We hence introduce the notion of CFSM with interface edges. 

 \begin{equation}
 \label{eq:2}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[sbs]$} (2)
            (1)  edge[bend right, line width=0.5mm]    node [below] {$\ttr\hh_1?\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left, line width=0.5mm]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge     [line width=0.5mm]                     node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

The corresponding connection policy is 

$$
\dbox{
     \begin{tikzpicture}[mycfsm]
   \node[state]            (1) [above of=0] {$1$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 1]{$\hh_1$};
   \node[state]            (2) [above left of=1, yshift=-4mm,xshift=2mm] {$2$};
   \node[state]            (3) [above right of=1, yshift=-4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (1)
            (1)  edge[bend left]    node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
       \qquad
     \begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0, xshift=1mm] {$1$};
   \node[state]           (2) [right of=0, xshift=-4.5mm] {$2$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1)
                   edge                          node [below]  {$\hh_1\hh_2?\msg[hum]$} (2)
                   ;
       \end{tikzpicture}
}
$$
This communicating system is orphan-message free.

 The composition obtained by building partial gateways out of such connection policy is then the 
 following communicating system.

\begin{equation}
\label{eq:comprunex}
\begin{array}{cc@{\hspace{-4mm}}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttr$};
   \node[state]            (1) [below of=0] {$1$};
   \node[state]            (2) [below left of=1, yshift=4mm,xshift=2mm] {$2$};
   \node[state]            (3) [below right of=1, yshift=4mm,xshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttr\hh_1!\msg[start]$} (1) 
            (1)  edge[bend right]    node [above] {$\ttr\hh1!\msg[sbs]$} (2)
            (1)  edge[bend left]    node [above] {$\ttr\hh_1!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
   \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [below left = 0.3cm  of 0]{$\hh_1$};
   \node[state]            (1) [above of=0] {$1$};
   \node[state]            (1hat) [above left of=1, yshift=-4mm,xshift=2mm] {$\widehat 1$};
   \node[state]            (2) [above of=1hat, yshift=-2mm] {$2$};
   \node[state]            (2hat) [above right of=1, yshift=-4mm,xshift=-2mm] {$\widehat 2$};
   \node[state]            (3) [above of=2hat, yshift=-2mm] {$3$};
%
   \path  (start) edge node {} (0)
            (0)  edge                    node [above] {$\ttr\hh_1?\msg[start]$} (1) 
            (1)  edge[bend left]    node [below] {$\ttr\hh_1?\msg[sbs]$} (1hat)
             (1hat)  edge   node [below] {$\hh_1\hh_2!\msg[sbs]$} (2)
            (1)  edge[bend right]    node [below] {$\ttr\hh_1?\msg[hum]$} (2hat) 
             (2hat)  edge   node [below] {$\hh_1\hh_2!\msg[hum]$} (3) 
            ;
       \end{tikzpicture}
    \end{array}
  &
      \raisebox{3mm}{\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1hat) [above right of=0] {$\widehat 1$};
    \node[state]            (1) [right of=1hat] {$1$};
   \node[state]           (2hat) [right of=0,xshift=-6mm] {$\widehat 2$};
    \node[state]           (2) [right of=2hat] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_1\hh_2?\msg[sbs]$} (1hat)
                   edge                          node [above]  {$\hh_1\hh_2?\msg[hum]$} (2hat)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (1hat)  edge                      node [above]  {$\hh_2\tts!\msg[sbs]$} (1)
            (2hat)  edge                      node [above]  {$\hh_2\tts!\msg[hum]$} (2)
            (2)  edge                           node [above]  {$\tts\hh_2?\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
        }
&
      \raisebox{-3mm}{ \begin{tikzpicture}[mycfsm]
  \node[state]           (0)            {$0$};
   \node[draw=none,fill=none] (start) [above right = 0.3cm  of 0]{$\tts$};
  \node[state]            (1) [above left of=0] {$1$};
   \node[state]           (2) [left of=0,xshift=6mm] {$2$};
   \node[state]           (3) [below left of=0] {$3$};
   \node[state]           (4) [left of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend right]      node [above] {$\tts\hh_2?\msg[sbs]$} (1)
                   edge                          node [above]  {$\tts\hh_2?\msg[hum]$} (2)
                   edge    [bend left]     node [below]  {$\tts\hh_2?\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\hh_2\tts!\msg[deg]$} (4)
                   ;
       \end{tikzpicture}
       }
\end{array}
\end{equation}

Scuh communicating system, however, is not orphan-message free.
In fact the following configuration, made by final states only, is reachable:\\
\centerline{
$s=((3_\ttr,3_{\hh_1},3_{\hh_2},3_\tts),\vec{w})$
}
where $\vec{w}\neq\vec{\varepsilon}$, in particular $w_{\hh_1\hh_2}=\langle\msg[hum]\rangle$.\\
Hence $s$ is an orphan-message configuration.\\

\smallskip
We show now that unrestricted choice of interface transitions can disrupt progress preservation
in composition via partial gateways.
Let us consider the two following systems $S_1$ and $S_2$ with interfaces, respectively,
$\hh_1$ and $\hh_2$. Both the systems satisfy the progress property.
\begin{equation}
\label{eq:pre3}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge   node [below] {$\hh_1\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh_2?\msg[a]$} (2);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
\end{equation}

We then make the following choice of interface transitions for the interface participants.

\begin{equation}
\label{eq:3}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge [line width=0.5mm]     node [below] {$\hh_1\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right, line width=0.5mm]            node [above]  {$\ttv\hh_2?\msg[a]$} (2);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
\end{equation}

The (unique) connection policy below satisfies the progress property.
 
$$
\dbox{
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
%
   \path  (start) edge node {} (0) 
            (0)  edge [line width=0.5mm]     node [below] {$\hh_2\hh_1?\msg[a]$} (1);
       \end{tikzpicture}
\quad
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};

   \path  (start) edge node {} (0)
            (0)   edge    [bend right, line width=0.5mm]            node [above]  {$\hh_2\hh_1!\msg[a]$} (2);
       \end{tikzpicture}
       }
$$

The following composition via partial gateway, however, does not satisfies the progress property.
$$
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};
%
   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
\quad
        \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (0hat) [right of=0] {$\widehat 0$};
  \node[state]           (1) [above of=0hat] {$1$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     node [below] {$\hh_2\hh_1?\msg[a]$} (0hat)
            (0hat)  edge     node [below] {$\hh_1\ttu!\msg[a]$} (1)
            ;
       \end{tikzpicture}
\quad
            \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
  \node[state]           (hat0)          [below right of=0, yshift=5mm]              {$\widehat{0}$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\HH_2$};
  \node[state]            (2) [right of=hat0] {$2$};
  \node[state]           (1) [above right of=0, yshift=-5mm] {$1$};
  %\node[state]           (2) [right of=hat0'] {$2$};

   \path  (start) edge node {} (0) 
            (0)         edge   [bend right]        node [below] {${\ttv\hh_2}?{\msg[a]}$} (hat0)
                         edge   [bend left]      node [above]  {${\ttv\hh_2}?{\msg[b]}$} (1)
             (hat0)  edge        node [below] {${\HH_2\hh_1}!{\msg[a]}$} (2);       
             \end{tikzpicture}
\quad
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
$$
In fact, some states in $s=(0_\ttu,0_{\hh_1},1_{\hh_2},1_\ttv)$ are not final, $s$ is reachable and $s\notlts{}$. 

The previous two examples, where some properties are not preserved by composition via
partial gateways, share the fact that interfaces have a state with normal and interface outgoing
transitions.
  
The following example shows that progress preservation can be disrupted also in presence of
states all with non interface transitions.

Let us consider the following communicating system.
\begin{equation}
\label{eq:4}
\begin{array}{c@{\qquad}c@{\hspace{1cm}}c@{\qquad}c}
    \begin{array}{cc}
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh_1\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
&
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (1) [right of=0] {$1$};
  %\node[state]           (2) [above right of=0] {$2$};

   \path  (start) edge node {} (0) 
            (0)  edge  [line width=0.5mm]     node [below] {$\hh_1\ttu!\msg[a]$} (1);
       \end{tikzpicture}
    \end{array}
       &
       \begin{array}{c}
       |\\
       |\\
       |\\
       |
       \end{array}
       &
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (3) [right of=2] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv\hh_2?\msg[c]$} (2)
            (2)   edge    [line width=0.5mm]            node [above]  {$\ttv\hh_2?\msg[a]$} (3);
       \end{tikzpicture}
&
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
\end{array}
\end{equation}
The (unique) connection policy satisfies progress.
The composition below, however, does not.
$$
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttu$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\hh\ttu?\msg[a]$} (1) ;
       \end{tikzpicture}
\quad
        \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_1$};
  \node[state]            (0hat) [right of=0] {$\widehat 0$};
  \node[state]           (1) [above of=0hat] {$1$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     node [below] {$\hh_2\hh_1?\msg[a]$} (0hat)
            (0hat)  edge     node [below] {$\hh_1\ttu!\msg[a]$} (1)
            ;
       \end{tikzpicture}
\quad
       \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0,yshift=-5mm] {$1$};
  \node[state]           (2) [below right of=0,yshift=5mm] {$2$};
  \node[state]           (2hat) [right of=2] {$\hat{2}$};
  \node[state]           (3) [right of=2hat] {$3$};
%
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\ttv\hh_2?\msg[b]$} (1)
            (0)   edge    [bend right]            node [above]  {$\ttv_2\hh?\msg[c]$} (2)
            (2)   edge           node [above]  {$\ttv\hh_2?\msg[a]$} (2hat)
            (2hat)   edge      node [above]  {$\hh_2\ttu!\msg[a]$} (3)
            ;
       \end{tikzpicture}
\quad
      \begin{tikzpicture}[mycfsm]
  \node[state]           (0)                        {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\ttv$};
   \node[state]            (1) [below of=0, yshift=4mm] {$1$};

   \path  (start) edge node {} (0)
            (0)  edge    node [above] {$\ttv\hh_2!\msg[b]$} (1) ;
       \end{tikzpicture}
$$
In fact, some states in the configuration $s=(0_\ttu,0_{\hh_1},1_{\hh_2},1_\ttv)$ are not final, $s$ is reachable and $s\notlts{}$. \\


Intuitively, the main problem in the two previous examples is that a choice among transitions
in the composition, 
does not depends on a single participant.
In one of the previous examples, problems arise when a choice involves both
$\hh_1$ and $\hh_2$.
In onother example
problems also arise when a choice made by an interface is in conflict with what the other 
interface does. We need hence to avoid, possibly by syntactical means, such problems.

We hence require outgoing interface transitions always to be single. (Claim: non necessary for deadlock-freedom).
This restriction is required in the following definition, where we formalise the notion of
interface transitions. In the following, the symbol $\intf$ is intended to identify
interface transitions, whereas $\nintf$ the non interface transitions.

\begin{definition}[CFSM with interface transitions]\label{def:cfsmie}
\label{def:cfsmintftrans}
A {\em CFSM with interface transitions} ($CFSM^{\mathsf{it}}$ for short) is a tuple $M=(Q,q_0,\textit{Act},\bm{\delta})$ 
where $Q$, $q_0$ and $\textit{Act}$ are as in the definition of CFSM, whereas\\
\centerline{
$\bm{\delta} \subseteq Q\times\textit{Act}\times Q \times \Set{\intf,\nintf}$}
\begin{tabular}{lc@{\hspace{4pt}}l}
and such that & - & $(q_1,\elle,q_2,x),(q_1,\elle,q_2,y)\in\bm{\delta} \implies x=y$.\\
                     & - & $(q_1,\elle,q_2,\nintf), (q_1,\elle',q'_2,z)\in\bm{\delta} \implies (\elle=\elle' \text{ and } q_2=q'_2)$\\
                     &    & \hspace{51mm}  (and hence $z=\nintf$ by the previous item).
\end{tabular}\\
An element of $\bm{\delta}$ of the form $(\_,\_,\_,\intf)$ is called {\em interface edge}.
\end{definition}
It is possible to check that $\hh_2$ in (\ref{eq:1}) above is a CFSM with interface transitions,
whereas participants $\hh_2$ in (\ref{eq:2}), (\ref{eq:3}) and (\ref{eq:4}) are not.
It is also worth noticing that the usual PaI composition via gateway is a particular case 
of composition via partial gateways where all transitions are interface transitions.
Absence of non interface transition makes conditions in \cref{def:cfsmintftrans} above
vacuously satisfied.

As done in the previous examples, we use the notation $q\lts{l}q'$ for $(q,l,q',\nintf)$ and
 $q
 \raisebox{2.7mm}
{\begin{tikzpicture}[mycfsm]
      % 
      \node[state, draw=none] (zero) [yshift=-4mm, xshift=5mm] {$~$};
      \node[state, draw=none] (one) [right of=zero, xshift=-10mm]   {$~$};
      % 
      \draw (zero) edge[-to,line width=0.5mm] node[above]{$l$} (one)
      ;
 \end{tikzpicture}
 } 
\!\! q'$ for $(q,l,q',\intf)$.\\

We describe now step-by step the composition via partial gateways that we have
roughly presented above.
We use our running example to describe the various steps. 
For each of them we provide the formal definitions of the notions we introduce.

\paragraph{Indentifying the interface transitions in the interface participants.}
Composition via partial gateways consists, first of all, in identifying two interface participants
and then properly choosing some transitions in order to get a CFSM with
interface transitions. Given a CFSM $M$, an interface decoration is one of the possible
CFSM with interface transition that we can get out of $M$. 


\begin{definition}[Interface decorations]\label{def:IDM}
Let $M=(Q,q_0,\textit{Act},\delta)$ be a CFSM. We define the {\em interface decorations set} of $M$
as the following set of CFSMs with interface transitions:
$$\IDS(M) = \Set{(Q,q_0,\textit{Act},\bm{\delta}) \mid (Q,q_0,\textit{Act},\bm{\delta}) \text{ is a CFSM$^\mathsf{it}$ with } \proj{\bm{\delta'}}{Q\times\textit{Act}\times Q} =\delta}$$
\end{definition}

\paragraph{Extract the intended interface out of a choosen decoration.}
Given a CFSM with interface transitions, say $\hh_2$ in (\ref{eq:1}), these transitions identifies the behaviour of the external system intended for the composition.
Such a behaviour should be the one described in terms of a particular CFSM, like
\begin{equation}
\label{eq:epsrunex}
\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   \node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            (2)  edge                           node [above]  {$\varepsilon$} (4)
                   ;
       \end{tikzpicture}
\end{equation}

In order to formally get that, we use the following function.

\begin{definition}[$\varepsilon(M)$]
\label{def:epsfun}
\item
Let $M=(Q,q_0,\textit{Act},\bm{\delta})$ be a CFSM with interface edges. We define
$\varepsilon(M)$ as  the $\varepsilon$-FSA $(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta')$   where\\
\centerline{
$\delta' = \Set{(q,l,q') \mid (q,\varepsilon,q',\nintf) \in \bm{\delta}}\cup \Set{(q,\varepsilon,q') \mid (q,\elle,q',\intf) \in \bm{\delta}}$  }
\end{definition}
In this simple case such a behaviour does correspond to the proper CFSM

\begin{equation}
\label{eq:cfsmnoeps}
\begin{tikzpicture}[mycfsm]
  \node[state]           (0)              {$0$};
   \node[draw=none,fill=none] (start) [above left = 0.3cm  of 0]{$\hh_2$};
  \node[state]            (1) [above right of=0] {$1$};
   \node[state]           (2) [right of=0,xshift=-6mm] {$2$};
   \node[state]           (3) [below right of=0] {$3$};
   %\node[state]           (4) [right of=2] {$4$};
   %
   \path  (start) edge node {} (0) 
            (0)  edge     [bend left]      node [above] {$\hh_2\tts!\msg[sbs]$} (1)
                   edge                          node [above]  {$\hh_2\tts!\msg[hum]$} (2)
                   edge    [bend right]     node [below]  {$\hh_2\tts!\msg[mus]$} (3)
            %(2)  edge                           node [above]  {$\varepsilon$} (4)
                   ;
       \end{tikzpicture}
\end{equation}

Since (\ref{eq:epsrunex}) above
has been obtained out of a CFSM with interface transitions -- where, by definition, outgoing
transitions are single whenever they are non-interface --  the CFSM  (\ref{eq:cfsmnoeps})
can be obtained by simply making all the $\varepsilon$-transition ``collapse''.
Such transformation is a much simpler algorithm then the usual algorithm for 
the elimination of $\varepsilon$-transitions in $\varepsilon$-FSA, due to the strong
restriction we have on $\varepsilon$-transitions.
In general, the CFSM describing the behaviour of the $\varepsilon$-FSA could be also 
different from the one obtained with the mentioned algorithm, as far as  it is possible
to get a precise correspondence among the non-$\varepsilon$ transition in the 
$\varepsilon$-FSA and the transitions of the CFSM.
We hence introduce the following definition where we focus not on the particula algorithm
but rather on the properties it has to satisfy.
This definition will also prove more adapt when we shall deal with partial fusion (see XYZ).

\begin{definition}[$\noeps$-versions]
\label{def:noepsver}
Let $M=(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta)$ be a $\varepsilon$-FSA
and $M'=(Q',q'_0,\textit{Act},\delta)$ be a CFSM.
We say that $M'$ is a {\em $\noeps$-version of $M$ via $f$} ($\noeps_f$-version of $M$ for short)
whenever 
\begin{enumerate}[a)]
\item
$M'$ is deterministic;
\item 
$f:Q\to Q'$ is onto and such that $f(p_0) = f(p'_0)$;
\item
$p_1\lts{\epsilon}p_2 \quad\text{implies}\quad f(p_1)=f(p_2)$; 
\item
$p_1\LTS{\elle}p_2 \quad\text{implies}\quad f(p_1)\lts{\elle}f(p_2)$; 
\item
\label{def:noepsver-e}
$ f(p_1)\lts{\elle}f(p_2)\quad\text{implies}\quad p_1\LTS{\elle}p_2$.
\end{enumerate}
\end{definition}
(((i.e. $f$ is a weak bisimulation?)))

\begin{remark}
\label{rem:neccond}
{\em
Notice that without the condition\\
\centerline{
$(q_1,\elle,q_2,\nintf), (q_1,\elle',q'_2,z)\in\bm{\delta} \implies (\elle=\elle' \text{ and } q_2=q'_2)$}
in \cref{def:cfsmie}, the conditions involving $f$ in the above definition \cref{def:noepsver} would not be satisfiable. \finex
}
\end{remark}

\begin{example}
((*Example of how (\ref{eq:cfsmnoeps}) is a $\noeps$-version of (\ref{eq:epsrunex})*))
\end{example}

\paragraph{Describing the forwarding behaviour for the connection policy.}
Out of a $\noeps$-version $M'$ of an $\varepsilon$-FSA, 
we can get an element for the intended connection policy by ``dualising'' the actions labelling the transitions and replacing the senders (of inputs) and receivers (of outputs) with
the names of the other participants of the connection policy. (Recall that in the binary case
such a replacement is uniquely determined.) 
The role of the set of the names of the other participants in a connection policy
is played by the set $\roles$ in the following definition of $\roles$-duality.

 

%\begin{definition}[$\I(M)$]\label{def:IM}%\hfill\\
%Let $M=(Q,q_0,\textit{Act},\bm{\delta})$ be a CFSM with interface edges
%and let $M'=(Q',q'_0,\textit{Act},\delta')$ be a standard CFSM. We say that
%$M'$ is an {\em interface for $M$ via $(f,g)$}, $\I^M_{\!\!(f,g)}(M')$, whenever
%\begin{itemize}
%\item[-]
%$f:Q\to Q'$  is onto and such that, for all $q\in Q$, $\langin(q)=\langin(f(q))$;
%\item[-]
%$g:\delta'\to\Set{e\in\delta\mid e \text{ is an interface edge}}$ is such that 
%$\I(M)$ as the CFSM obtained out of $\bm{\varepsilon}(M)$ using the standard procedure
%to get a FSA without $\varepsilon$-transitions out of a $\varepsilon$-FSA \cite[someStandardReference]. 
%Roughly:\\ 
%- one first calculate the $\varepsilon$-closure for each state, which is the set of all states reachable from a given state using only $\varepsilon$-transitions;\\ 
%- then, for each element of $\textit{Act}$, define new transitions for each state by considering the $\varepsilon$-closures of the states reachable via the original transition function.
%\end{itemize}
%\end{definition}

\begin{definition}[$\roles$-duality]\label{def:PD}%\hfill\\
\begin{enumerate}[i)]
%\item
%Let $M=(Q,q_0,\textit{Act},\bm{\delta})$ be a CFSM with interface edges. We define
%$\varepsilon(M)$ as  the $\varepsilon$-FSA $(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta')$   where\\
%\centerline{
%$\delta' = \Set{(q,l,q') \mid (q,\varepsilon,q',\nintf) \in \bm{\delta}}\cup \Set{(q,\varepsilon,q') \mid (q,\elle,q',\intf) \in \bm{\delta}}$  }
\item
Let $l,l'\in\textit{Act}$ and  let $\roles\neq\emptyset$ be a set of participants.
We say that $l'$ is {\em a $\roles$-dual of $l$} whenever 
\begin{itemize}
\item[-]
$l = \ttr\ttq?\msg[m] \implies l'= \ttq\tts!\msg[m] \text{ with } \tts\in\roles$, $\tts\neq\ttq$;
\item[-]
$l = \ttq\ttr!\msg[m] \implies l'= \tts\ttq?\msg[m] \text{ with } \tts\in\roles$, $\tts\neq\ttq$.
\end{itemize}
\item
Let $\delta,\delta'\in Q\times\textit{Act}\times Q$ and  let $\roles$ be a set of participants.
We say that $\delta'$ is {\em a $\roles$-dual of $\delta$} whenever is a minimal relation over
 $Q\times\textit{Act}\cup\Set{\varepsilon}\times Q$ such that\\
\centerline{
$q\lts{l}q'\in\delta \implies q\lts{l'}q'\in\delta'$, where $l'$ is a $\roles$-dual of $l$.
}
\item
Let $M=(Q,q_0,\textit{Act},\delta)$ and $M'=(Q,q_0,\textit{Act}\cup\Set{\varepsilon},\delta')$ be two CFSM and  let $\roles$ be a set of participants.
We say that $M''$ is {\em a $\roles$-dual of $M$} whenever $\delta'$ is a $\roles$-dual of $\delta$.
\end{enumerate}
\end{definition}

We have that $\hh_2$ in (\ref{eq:cp1}) is a $\Set{\hh_1}$-dual of (\ref{eq:cfsmnoeps}) (actually the
unique $\Set{\hh_1}$-dual since we are in a binary setting).

\paragraph{Build the partial gateway.}
Towards the formal definition of partial gateway, 
we define now the relation of $\roles$-complementarity in terms of the definitions of interface decoration,
$\varepsilon(\_)$, $\noeps$-version and $\roles$-duality.


 \begin{definition}[$\roles$-complementarity]
\label{def:Pcomplementarity}
Let $M^1_\hh = (Q, q_0, \textit{Act}, \delta^1)$ and 
$M^2_\hh = (Q, q_0, \textit{Act}, \delta^2)$  
be two CFSMs with the same name $\hh$, and let $\roles$ be a set of participants.
Moreover, let $\bm{\delta} \subseteq Q\times\textit{Act}\times Q \times \Set{\intf,\nintf}$
We say that
$M^1_\hh$ is {\em $\roles$-complementary} with $M^2_\hh$ via $\bm{\delta}$ and $f$, 
written $\emb{f}{\roles}{\bm{\delta}}{M^1_\hh}{M^2_\hh}$, whenever 
$$M^1_\hh \text{ is a $\roles$-dual of a $\noeps_{\!f}$-version of } \varepsilon(M'_\hh)$$
where $M'_\hh= (Q, q_0, \textit{Act}, \bm{\delta})\in\IDS(M^2_\hh)$.\\
We call $\varepsilon(M'_\hh)$ {\em the $\epsilon$-counterpart of $M^1_\hh$}
\end{definition}

\noindent
We write simply $M^1_\hh \embd M^2_\hh$ whenever
$\roles$, $\bm\delta$ and $f$ are clear from the context or ininfluent.

A partial gateway is 

-- (\ref{eq:cfsmnoeps}) in our running example --

which, in turn is used to identify one of the CFSMs of the connection policy (uniquely identified
for the binary case), in particular the $\hh_2$ in the connection policy (\ref{eq:cp1})
for our running example.

 \begin{definition}[Connection policy]\label{def:cp}
 Let $S_i=(M^i_{\ttx})_{\ttx\in\roles_i}$ be two composable communicating systems such that $S_i=(M^i_{\ttx})_{\ttx\in\roles_i}$  with interfaces $\hh_i$ ($i=1,2$) . 
 A {\em connection policy} for the set of interfaces $H=\Set{\hh_1,\hh_2}$ is a communicating system 
 $$\cs = (M^\cs_\ttu)_{\ttu\in H}$$ 
 such that,
 for each $i\in\Set{1,2}$, for some $f_i$ and $\bm{\delta_i}$: \  $\emb{f_i}{H\setminus\Set{\hh_i}}{\bm{\delta_i}}{M^\cs_\hh}{M^i_\hh}$\\
\end{definition}


The construction of partial gateways is formally defined as follows.

\begin{definition}[Partial Gateway]
\label{def:gatewaycs} 
\label{def:gatewaymc}
Let $M^1_{\hh}= (Q_1, q^1_0,\textit{Act},\delta_1)$ and 
$M^2_{\hh} = (Q_2, {q^2_0},\textit{Act},\delta^2)$ such that \linebreak
$\emb{f}{\roles}{\bm{\delta}}{M^1_\hh}{M^2_\hh}$.
The {\em partial gateway} $M^1_{\hh}{\gts} M^2_{\hh}$ obtained out of  $M^1_\HH$ and $M^2_\hh$  is the CFSM with name $\hh$ defined by  
$$
M^1_{\hh}{\gts} M^2_{\hh} = (Q^2\cup\widehat Q, q^2_0, \textit{Act},\widehat{\delta})
$$
\begin{tabular}{l@{\hspace{4pt}}c@{\hspace{2mm}}l}
where &  $\bullet$  & $\widehat{Q} =\bigcup_{q\in Q}\Set{q^{(q, l,q')} \mid (q, l,q',\intf)\in\bm{\delta}}$; \\[1mm]
          &  $\bullet$  & $\widehat\delta = \Set{(q,{\ttr}\HH?\msg[a],\widehat q), (\widehat q,\HH\tts!\msg[a],q') \mid  (q,\HH\tts!\msg[a],q',\intf)\in\bm{\delta}, (f(q),\ttr\hh?\msg[a],\ {f(q')})\in\delta^1,\ \widehat q=q^{(q,\hh\tts!\msg[a],q')}}\, \cup$ \\
                &    & ${\hspace{20pt}}\Set{(q,\tts\HH?\msg[a],\widehat q), (\widehat q,\HH {\ttr}!\msg[a],q') \mid  (q,\tts\HH?\msg[a],q',\intf)\in\bm{\delta},\ (q,\hh\ttr!\msg[a],{q'})\in\delta^1,\ \widehat q=q^{(q,\tts\HH?\msg[a],q')}}\, \cup$ \\
                 &    & ${\hspace{20pt}}\Set{(q,\elle, q') \mid (q,\elle, q',\nintf) \in\bm{\delta}}.$
 \end{tabular} 
 
\smallskip
\noindent
We refer to $\widehat\delta$ as $\widehat\delta_{\HH}$ whenever $\HH$ is not clear from the
context; similarly for $\widehat Q$.
\end{definition}
  
By extending the usual notion of gateway (*reference*) the interface participant $\hh_2$ in
$S_2$ of our running example (\ref{eq:runex}) and the $\hh_2$ above  
are the argument to build the partial gateway intended to be substituted for $\hh_2$ in the composition.
Namely $\hh_2$ in (\ref{eq:comprunex}).

 \begin{definition}[Composability]
 \label{def:composability}
Let $S_1$ and $S_2$  be two communicating systems such that $S_i=(M_{\ttx})_{\ttx\in\roles_i}$ ($i=1,2$). 
%Moreover, let $\hh_1$ and $\hh_2$ be two participants of, respectively,  $S_1$ and $S_2$
%and appointed as interfaces.
We say that $S_1$ and $S_2$ are {\em composable} whenever $\roles_1\cap\roles_2=\emptyset$.
\end{definition} 


\begin{definition}[PaI composition of communicating systems via partial gateways]
\label{def:comppgw} 
Let $S_1$ and $S_2$ be two composable communicating systems
such that $S_i=(M^i_{\ttx})_{\ttx\in\roles_i}$ ($i\in\Set{1,2}$)
and let  $\cs=(M^\cs_{\ttp})_{\ttp\in H}$  
 be an orchestrated connection policy for the set of interfaces $H=\Set{1,2}$. 
The {\em PaI composition of communicating systems via partial gateways  
(partial composition for short) of 
 $S_1$ and $S_2$ with respect to $\cs$} is the communicating system 
$$\PC(\Set{S_i}_{i\in \Set{1,2}}, \cs) =  (M'_\ttp)_{\ttp\in\roles_1\cup\roles_2}$$
where\\
${\qquad\qquad}M'_\ttp = \left\{ \begin{array}{ll}
                          M^i_\ttp 
                                    &  \text{ if }\ \ttp\not\in H \text{ and } i\in\Set{1,2}
                          \\[2mm]
                          M^\cs_{\hh_i}{\gts\,}M^i_{\hh_i} & \text{ if } \ttp=\hh_i \text{ and $i\in \Set{1,2}$}
                           \end{array}
                 \right.$
\end{definition}


%We define $\noeps(M)$ as the CFSM obtained out of $M$ 
%using the following version of the standard procedure to get a FSA without $\varepsilon$-transitions
%out of a $\varepsilon$-FSA \cite{sipser96}, where final states are not taken into account and
%the set of states of $\I(M)$ and $\noeps(M)$ stay the same . 
%Roughly:\\ 
%- Add an arc from p to q labeled a iff there is an arc labeled a in N from some state in eps-CLOSE(p) to q.;\\
%- Delete all arcs labeled with epsilon.
%%- one first calculate the $\varepsilon$-closure for each state, which is the set of all states reachable from a given state using only $\varepsilon$-transitions;\\ 
%%- then, for each element of $\textit{Act}$, define new transitions for each state by considering the $\varepsilon$-closures of the states reachable via the original transition function.
%\end{enumerate}

%Notice that the states of $\I(M)$ and $M$ are the same.



\begin{theorem}[Safety of PaI multicomposition via partial gateways]
\label{th:paisafenesse}
 Let $\Set{S_i}_{i\in I}$ be a set of communicating systems composable with respect to a set
 $H$ %$ = \{\hh_i\}_{i \in I}$
 of interfaces with no mixed states (cf.~\cref{def:interfaces}); and
let $\cs$ be a connection policy for $H$. 


Let $\mathcal{P}$ be
either the property of {\em deadlock-freedom} or {\em reception-error-freedom} 
or {\em progress}
(as defined in \cref{def:safeness}).
If $\mathcal{P}$ holds for each $S_i$ with $i \in I$ 
and for $\cs$, 
then $\mathcal{P}$ holds for $S  = \PC(\Set{S_i}_{i\in I}, \cs)$.
Moreover, the above holds also if the no-mixed-state condition is removed and
$\mathcal{P}$ is {\em orphan-message-freedom}.
\end{theorem}

The proof of the above theorem descends from the fact that any system obtained by 
PaI multicomposition via partial gateways can be actually got by multiple application of
(binary) partial-fusion composition. 


\section{Partial-fusion Composition}

%We make distinct two equal labels when they are used in different transitions. 
%\begin{definition}[$M^+$]
%Let $M = (Q, q_0, \textit{Act}, \delta)$. We define
%$$M^+ = (Q, q_0, \textit{Act}', \delta')$$
%where $\textit{Act}'= \Set{\ttr\tts!\msg[m]^{(q,l,q')},\ttr\tts?\msg[m]^{(q,l,q')} \mid (q,l,q')\in Q\times\textit{Act}\times Q,\ttr,\tts\in\roles, \msg[m] \text{ a message}}$\\
% and 
%$\delta'= \Set{q\lts{\ttr\tts!\msg[m]^{(q,\ttr\tts!\msg[m],q')}}q' \mid q\lts{\ttr\tts!\msg[m]}q'\in\delta}$.
%\end{definition}


%\begin{definition}[$\bm{\delta}$-complementarity]
%Let $M^1_\hh = (Q, q_0, \textit{Act}, \delta^1)$ and $M^2_\hh = (Q, q_0, \textit{Act}, \delta^2)$  be two CFSMs with the same name $\hh$.
%We say that
%\begin{enumerate}[i)]
%\item
%$M^1_\hh$ is {\em $\bm{\delta^2}$-complementary} with $M^2_\hh$, written $\emb{\bm{\delta^2}}{}{M^1_\hh}{M^2_\hh}$, whenever 
%\begin{itemize}
%\item[-] 
%there exists $M'_\hh = (Q, q_0, \textit{Act}, \bm{\delta^2})\in\IDS(M^2_\hh)$;
%\item[-]
%$\I(\bm{\varepsilon}(M'_\hh)^+) = (Q, q_0, \textit{Act}, \delta')$;
%\item[-]
%$q_1 \lts{\hh\ttp!\msg[m]} q_2 \in \delta^1$ for some $\ttp$ \quad iff \quad 
%$q_1\lts{\ttp'\hh?\msg[m]^{(q,l,q')}}q_2\in \delta'$ for some $\ttp'$;
%\item[-]
%$q_1 \lts{\ttp\hh?\msg[m]} q_2 \in \delta^1$ for some $\ttp$ \quad iff \quad 
%$q_1\lts{\hh\ttp'!\msg[m]^{(q,l,q')}}q_2\in \delta'$  for some $\ttp'$;
%
%
%\item[-]
%$q_1\lts{\ttp\hh?\msg[m]^{(q,l,q')}}q_2,q'_1\lts{\ttp\hh?\msg[m]^{(q,l,q')}}q'_2\in \delta'$
%implies
%$q_1 \lts{\hh\ttp'!\msg[m]} q_2, q'_1 \lts{\hh\ttp'!\msg[m]} q'_2 \in \delta^1$;
%\item[-]
%$q_1\lts{\hh\ttp!\msg[m]^{(q,l,q')}}q_2,q'_1\lts{\hh\ttp!\msg[m]^{(q,l,q')}}q'_2\in \delta'$
%implies
%$q_1 \lts{\ttp'\hh?\msg[m]} q_2, q'_1 \lts{\ttp'\hh?\msg[m]} q'_2 \in \delta^1$.
%\end{itemize}
%\end{enumerate}
%\end{definition}
%The fifth and sixth items guarantees that if two labels in $\I(\bm{\varepsilon}(M'_\hh)^+))$ comes
%from the very same transition in $\bm{\varepsilon}(M'_\hh)$ then in $M^1_\hh$ they must
%send(receive) to(from) the same participant.

\begin{definition}[Partial Fusion]
\label{def:parfus}
Let $M^1_\hh = (Q^1, q^1_0, \textit{Act}, \delta^1)$ and $M^2_\hh = (Q^2, q^2_0, \textit{Act}, \delta^2)$  be two CFSMs with the same name $\hh$ such that 
$\emb{f}{\bm{\delta}}{\roles\setminus\Set{\hh}}{M^1_{\hh}}{M^2_\hh}$.
We define the {\em partial fusion of $M^1_{\hh}$ and $M^2_{\hh}$ via $\bm{\delta}$ and $\roles$} as
$$\fusion_{\!\!\bm{\delta}}^{\roles}(M^1_{\hh},M^2_{\hh}) = (Q^2\cup\widehat{Q},q_0,\textit{Act},\widehat{\delta})$$
\begin{tabular}{l@{\hspace{1mm}}c@{\hspace{2mm}}l}
where &  $\bullet$  & $\widehat{Q} =\Set{q^{(q, l,q')} \mid (q, l,q',\intf)\in\bm{\delta}}$; \\[1mm]
          &  $\bullet$  & $\widehat\delta = \Set{(q, l,q') \mid (q, l,q',\nintf)\in\bm{\delta}}\,\cup$\\ 
           &    & ${\hspace{20pt}}\Set{(q,\ttr\HH?\msg[a],\widehat q), (\widehat q,\HH\tts!\msg[a],q') \mid  (q,\HH\tts!\msg[a],q',\intf)\in\bm{\delta}, (q,\ttr\hh?\msg[a],\ q')\in\delta^1,\ \widehat q=q^{(q,\HH\tts!\msg[a],q')}}\, \cup$ \\
                &    & ${\hspace{20pt}}\Set{(q,\tts\HH?\msg[a],\widehat q), (\widehat q,\HH'\ttr!\msg[a],q') \mid  (q,\tts\HH?\msg[a],q',\intf)\in\bm{\delta},\ (q,\hh\ttr!\msg[a],q')\in\delta^1,\ \widehat q=q^{(q,\tts\HH?\msg[a],q')}}.$
 \end{tabular} 
\end{definition}



\begin{definition}[Composition by Partial Fusion]
\label{def:cpf}
Let $S_1=(M^1_\ttx)_{\ttx\in\roles_1}$ and $S_2=(M^2_\ttx)_{\ttx\in\roles_2}$ be two communicating systems such that $\roles_1\cap\roles_2=\Set{\hh}$
and $\emb{f}{\bm{\delta}}{\roles_1}{M^1_{\hh}}{M^2_{\hh}}$.
We define the {\em composition of $S_1$ and $S_2$ via partial fusion of $\hh$} by
$$\fusioncomp_{\!\hh}(S_1,S_2) = (\widetilde{M}_\ttx)_{\ttx\in\roles_1\cup\roles_2}$$ 
\begin{tabular}{lc@{\hspace{2mm}}l@{\hspace{4mm}}l}
where &  $\bullet$  & $\widetilde M_\ttx = M^1_\ttx$  & $\text{if}\quad \ttx\in\roles_1 $; \\[1mm]
          &   $\bullet$  & $\widetilde M_\ttx = M^2_\ttx$ &  $\text{if}\quad \ttx\in\roles_2 $; \\[1mm]
                    &   $\bullet$  & $\widetilde M_{\hh} =\fusion_{\!\!\bm{\delta}}^{{\roles_1\setminus\Set{\hh}}}(M^1_{\hh},M^2_{\hh})$.
 \end{tabular} 
 We call $\widetilde M_{\hh}$ the {\em connector} of $S_1$ and $S_2$ in the composition.
\end{definition}














